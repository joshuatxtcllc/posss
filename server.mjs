var St=Object.defineProperty;var Ss=Object.getOwnPropertyDescriptor;var vs=Object.getOwnPropertyNames;var Is=Object.prototype.hasOwnProperty;var xs=(o,e,t)=>e in o?St(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var $e=(o=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(o,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):o)(function(o){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+o+'" is not supported')});var _=(o,e)=>()=>(o&&(e=o(o=0)),e);var U=(o,e)=>{for(var t in e)St(o,t,{get:e[t],enumerable:!0})},Cs=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of vs(e))!Is.call(o,a)&&a!==t&&St(o,a,{get:()=>e[a],enumerable:!(r=Ss(e,a))||r.enumerable});return o};var zr=o=>Cs(St({},"__esModule",{value:!0}),o);var k=(o,e,t)=>xs(o,typeof e!="symbol"?e+"":e,t);var Gt={};U(Gt,{customerNotifications:()=>G,customers:()=>A,frameConfigurationBookmarks:()=>Zr,frames:()=>O,glassOptions:()=>ie,insertCustomerNotificationSchema:()=>Ws,insertCustomerSchema:()=>Bt,insertFrameConfigurationBookmarkSchema:()=>cn,insertFrameSchema:()=>Fs,insertGlassOptionSchema:()=>As,insertInventoryCategorySchema:()=>zs,insertInventoryCountItemSchema:()=>rn,insertInventoryCountSchema:()=>tn,insertInventoryItemSchema:()=>Ys,insertInventoryLocationSchema:()=>vt,insertInventoryTransactionSchema:()=>Js,insertLarsonJuhlCatalogSchema:()=>$s,insertMatColorSchema:()=>Os,insertMaterialLocationSchema:()=>sn,insertMaterialOrderSchema:()=>Gs,insertNotificationSchema:()=>nn,insertOrderFrameSchema:()=>Ds,insertOrderGroupSchema:()=>Rs,insertOrderMatSchema:()=>js,insertOrderSchema:()=>Ns,insertOrderSpecialServiceSchema:()=>Ms,insertPaymentLinkSchema:()=>on,insertPurchaseOrderLineSchema:()=>en,insertPurchaseOrderSchema:()=>Xs,insertQrCodeScanSchema:()=>Jr,insertQrCodeSchema:()=>Qr,insertSpecialServiceSchema:()=>_s,insertSupplierSchema:()=>Ks,insertUserSchema:()=>Ts,insertWholesaleOrderSchema:()=>Ls,inventoryCategories:()=>Ce,inventoryCountItems:()=>Yr,inventoryCounts:()=>Wt,inventoryItems:()=>L,inventoryLocations:()=>D,inventoryTransactions:()=>ye,larsonJuhlCatalog:()=>Vr,matColors:()=>ae,materialLocations:()=>Ht,materialOrderStatuses:()=>Hs,materialOrders:()=>I,materialTypes:()=>Us,measurementUnits:()=>Vs,notificationChannels:()=>Bs,notificationTypes:()=>qs,notifications:()=>z,orderFrames:()=>Je,orderGroups:()=>B,orderMats:()=>Qe,orderSpecialServices:()=>qe,orders:()=>x,paymentLinks:()=>j,productionStatuses:()=>Es,purchaseOrderLines:()=>It,purchaseOrderStatuses:()=>Zs,purchaseOrders:()=>de,qrCodeScans:()=>Ut,qrCodeTypes:()=>an,qrCodes:()=>Be,specialServices:()=>ce,suppliers:()=>K,transactionTypes:()=>Qs,users:()=>ue,wholesaleOrders:()=>le});import{pgTable as R,text as p,serial as T,integer as C,boolean as q,numeric as S,timestamp as v,jsonb as xe,primaryKey as ks}from"drizzle-orm/pg-core";import{createInsertSchema as E}from"drizzle-zod";var A,Bt,O,Fs,ae,Os,ie,As,ce,_s,B,Rs,Es,x,Ns,qe,Ms,Qe,js,Je,Ds,le,Ls,ue,Ts,Vr,$s,qs,Bs,G,Ws,Us,Hs,I,Gs,K,Ks,Ce,zs,D,vt,Vs,L,Ys,Qs,ye,Js,Zs,de,Xs,It,en,Wt,tn,Yr,rn,j,on,an,Be,Qr,Ut,Jr,Ht,sn,z,nn,Zr,cn,Q=_(()=>{"use strict";A=R("customers",{id:T("id").primaryKey(),name:p("name").notNull(),email:p("email"),phone:p("phone"),address:p("address"),stripeCustomerId:p("stripe_customer_id"),createdAt:v("created_at").defaultNow()}),Bt=E(A).omit({id:!0,createdAt:!0}),O=R("frames",{id:p("id").primaryKey(),name:p("name").notNull(),manufacturer:p("manufacturer").notNull(),material:p("material").notNull(),width:S("width").notNull(),depth:S("depth").notNull(),price:S("price").notNull(),catalogImage:p("catalog_image").notNull(),edgeTexture:p("edge_texture"),corner:p("corner")}),Fs=E(O),ae=R("mat_colors",{id:p("id").primaryKey(),name:p("name").notNull(),color:p("color").notNull(),price:S("price").notNull(),manufacturer:p("manufacturer"),code:p("code"),description:p("description"),category:p("category")}),Os=E(ae),ie=R("glass_options",{id:p("id").primaryKey(),name:p("name").notNull(),description:p("description").notNull(),price:S("price").notNull()}),As=E(ie),ce=R("special_services",{id:p("id").primaryKey(),name:p("name").notNull(),description:p("description").notNull(),price:S("price").notNull()}),_s=E(ce),B=R("order_groups",{id:T("id").primaryKey(),customerId:C("customer_id").references(()=>A.id),subtotal:S("subtotal"),tax:S("tax"),total:S("total"),status:p("status").notNull().default("open"),paymentMethod:p("payment_method"),notes:p("notes"),createdAt:v("created_at").defaultNow(),stripePaymentIntentId:p("stripe_payment_intent_id"),stripePaymentStatus:p("stripe_payment_status"),paymentDate:v("payment_date"),discountAmount:S("discount_amount"),discountType:p("discount_type"),taxExempt:q("tax_exempt").default(!1),cashAmount:S("cash_amount"),checkNumber:p("check_number"),invoiceEmailSent:q("invoice_email_sent").default(!1),invoiceEmailDate:v("invoice_email_date")}),Rs=E(B).omit({id:!0,createdAt:!0}),Es=["order_processed","scheduled","materials_ordered","materials_arrived","frame_cut","mat_cut","prepped","completed","delayed"],x=R("orders",{id:T("id").primaryKey(),customerId:C("customer_id").references(()=>A.id),orderGroupId:C("order_group_id").references(()=>B.id),frameId:p("frame_id").references(()=>O.id),matColorId:p("mat_color_id").references(()=>ae.id),glassOptionId:p("glass_option_id").references(()=>ie.id),artworkWidth:S("artwork_width").notNull(),artworkHeight:S("artwork_height").notNull(),matWidth:S("mat_width").notNull(),artworkDescription:p("artwork_description"),artworkType:p("artwork_type"),artworkLocation:p("artwork_location"),quantity:C("quantity").notNull().default(1),subtotal:S("subtotal").notNull(),tax:S("tax").notNull(),total:S("total").notNull(),status:p("status").notNull().default("pending"),productionStatus:p("production_status").$type().notNull().default("order_processed"),previousStatus:p("previous_status").$type(),createdAt:v("created_at").defaultNow(),dueDate:v("due_date"),artworkImage:p("artwork_image"),frameDesignImage:p("frame_design_image"),lastNotificationSent:v("last_notification_sent"),estimatedCompletionDays:C("estimated_completion_days"),addToWholesaleOrder:q("add_to_wholesale_order").default(!1),lastStatusChange:v("last_status_change").defaultNow(),notificationsEnabled:q("notifications_enabled").default(!0),useMultipleMats:q("use_multiple_mats").default(!1),useMultipleFrames:q("use_multiple_frames").default(!1),useManualFrame:q("use_manual_frame").default(!1),manualFrameName:p("manual_frame_name"),manualFrameCost:S("manual_frame_cost"),miscChargeDescription:p("misc_charge_description"),miscChargeAmount:S("misc_charge_amount")}),Ns=E(x).omit({id:!0,createdAt:!0}),qe=R("order_special_services",{orderId:C("order_id").references(()=>x.id).notNull(),specialServiceId:p("special_service_id").references(()=>ce.id).notNull()},o=>({pk:ks({columns:[o.orderId,o.specialServiceId]})})),Ms=E(qe),Qe=R("order_mats",{id:T("id").primaryKey(),orderId:C("order_id").references(()=>x.id).notNull(),matColorId:p("mat_color_id").references(()=>ae.id).notNull(),position:C("position").notNull(),width:S("width").notNull(),offset:S("offset").notNull().default("0"),createdAt:v("created_at").defaultNow()}),js=E(Qe).omit({id:!0,createdAt:!0}),Je=R("order_frames",{id:T("id").primaryKey(),orderId:C("order_id").references(()=>x.id).notNull(),frameId:p("frame_id").references(()=>O.id).notNull(),position:C("position").notNull(),distance:S("distance").notNull().default("0"),createdAt:v("created_at").defaultNow()}),Ds=E(Je).omit({id:!0,createdAt:!0}),le=R("wholesale_orders",{id:T("id").primaryKey(),orderId:C("order_id").references(()=>x.id),manufacturer:p("manufacturer").notNull(),items:xe("items").notNull(),status:p("status").notNull().default("pending"),createdAt:v("created_at").defaultNow()}),Ls=E(le).omit({id:!0,createdAt:!0}),ue=R("users",{id:T("id").primaryKey(),username:p("username").notNull().unique(),password:p("password").notNull(),role:p("role").notNull().default("employee")}),Ts=E(ue).omit({id:!0}),Vr=R("larson_juhl_catalog",{id:p("id").primaryKey(),name:p("name").notNull(),hex_color:p("hex_color"),price:S("price",{precision:10,scale:6}).notNull(),code:p("code").notNull(),crescent_code:p("crescent_code"),description:p("description"),category:p("category"),manufacturer:p("manufacturer").notNull(),type:p("type").notNull().default("matboard"),material:p("material"),width:S("width"),depth:S("depth"),edge_texture:p("edge_texture"),corner:p("corner"),catalog_image:p("catalog_image"),createdAt:v("created_at").defaultNow()}),$s=E(Vr).omit({createdAt:!0}),qs=["status_update","estimated_completion","status_change","due_date_update","completion_reminder","order_complete","payment_reminder","delay_notification","payment_link"],Bs=["email","sms","both"],G=R("customer_notifications",{id:T("id").primaryKey(),customerId:C("customer_id").references(()=>A.id),orderId:C("order_id").references(()=>x.id),notificationType:p("notification_type").$type().notNull(),channel:p("channel").$type().notNull().default("email"),subject:p("subject").notNull(),message:p("message").notNull(),sentAt:v("sent_at").defaultNow(),successful:q("successful").notNull(),responseData:xe("response_data"),previousStatus:p("previous_status"),newStatus:p("new_status"),paymentLinkId:C("payment_link_id")}),Ws=E(G).omit({id:!0,sentAt:!0}),Us=["frame","matboard","glass","backing_board","hardware","specialty_materials"],Hs=["pending","processed","ordered","arrived","frame_cut","mat_cut","prepped","completed","delayed","canceled"],I=R("material_orders",{id:T("id").primaryKey(),materialType:p("material_type").$type().notNull(),materialId:p("material_id").notNull(),materialName:p("material_name").notNull(),quantity:S("quantity").notNull(),status:p("status").$type().notNull().default("pending"),sourceOrderId:C("source_order_id").references(()=>x.id),orderDate:v("order_date"),expectedArrival:v("expected_arrival"),actualArrival:v("actual_arrival"),supplierName:p("supplier_name"),supplierOrderNumber:p("supplier_order_number"),notes:p("notes"),costPerUnit:S("cost_per_unit"),totalCost:S("total_cost"),priority:p("priority").default("normal"),hubOrderId:p("hub_order_id"),hubSyncStatus:p("hub_sync_status").default("not_synced"),hubLastSyncDate:v("hub_last_sync_date"),hubTrackingInfo:p("hub_tracking_info"),hubEstimatedDelivery:v("hub_estimated_delivery"),hubSupplierNotes:p("hub_supplier_notes"),orderReference:p("order_reference"),unitMeasurement:p("unit_measurement"),createdAt:v("created_at").defaultNow()}),Gs=E(I).omit({id:!0,createdAt:!0,hubOrderId:!0,hubSyncStatus:!0,hubLastSyncDate:!0,hubTrackingInfo:!0,hubEstimatedDelivery:!0,hubSupplierNotes:!0}),K=R("suppliers",{id:T("id").primaryKey(),name:p("name").notNull(),contactName:p("contact_name"),email:p("email"),phone:p("phone"),address:p("address"),website:p("website"),accountNumber:p("account_number"),notes:p("notes"),paymentTerms:p("payment_terms"),minimumOrderAmount:S("minimum_order_amount"),shippingPreference:p("shipping_preference"),leadTime:C("lead_time"),active:q("active").default(!0),createdAt:v("created_at").defaultNow(),lastOrderDate:v("last_order_date")}),Ks=E(K).omit({id:!0,createdAt:!0}),Ce=R("inventory_categories",{id:T("id").primaryKey(),name:p("name").notNull(),description:p("description"),parentCategoryId:C("parent_category_id").references(()=>Ce.id),createdAt:v("created_at").defaultNow()}),zs=E(Ce).omit({id:!0,createdAt:!0}),D=R("inventory_locations",{id:T("id").primaryKey(),name:p("name").notNull(),description:p("description"),type:p("type"),parentLocationId:C("parent_location_id").references(()=>D.id),active:q("active").default(!0),createdAt:v("created_at").defaultNow()}),vt=E(D).omit({id:!0,createdAt:!0}),Vs=["each","inch","foot","united_inch","square_inch","sheet","roll","pound","liter","gallon"],L=R("inventory_items",{id:T("id").primaryKey(),sku:p("sku").notNull().unique(),name:p("name").notNull(),description:p("description"),categoryId:C("category_id").references(()=>Ce.id),supplierId:C("supplier_id").references(()=>K.id),supplierSku:p("supplier_sku"),unitOfMeasure:p("unit_of_measure").$type().notNull(),costPerUnit:S("cost_per_unit").notNull(),retailPrice:S("retail_price"),minimumStockLevel:S("minimum_stock_level").notNull(),reorderLevel:S("reorder_level").notNull(),reorderQuantity:S("reorder_quantity"),locationId:C("location_id").references(()=>D.id),barcode:p("barcode"),notes:p("notes"),tags:p("tags").array(),isActive:q("is_active").default(!0),createdAt:v("created_at").defaultNow(),updatedAt:v("updated_at").defaultNow(),lastCountDate:v("last_count_date"),imageUrl:p("image_url"),dimensions:xe("dimensions"),autoBatchReorder:q("auto_batch_reorder").default(!1),materialType:p("material_type").$type(),materialId:p("material_id")}),Ys=E(L).omit({id:!0,createdAt:!0,updatedAt:!0}),Qs=["purchase","sale","adjustment","return","transfer","count","scrap","initial"],ye=R("inventory_transactions",{id:T("id").primaryKey(),itemId:C("item_id").references(()=>L.id).notNull(),type:p("type").$type().notNull(),quantity:S("quantity").notNull(),unitCost:S("unit_cost"),locationId:C("location_id").references(()=>D.id),relatedOrderId:C("related_order_id").references(()=>x.id),notes:p("notes"),referenceNumber:p("reference_number"),createdAt:v("created_at").defaultNow(),createdBy:C("created_by").references(()=>ue.id)}),Js=E(ye).omit({id:!0,createdAt:!0}),Zs=["draft","pending","approved","sent","partially_received","received","canceled"],de=R("purchase_orders",{id:T("id").primaryKey(),poNumber:p("po_number").notNull(),supplierId:C("supplier_id").references(()=>K.id).notNull(),orderDate:v("order_date").notNull(),expectedDeliveryDate:v("expected_delivery_date"),status:p("status").$type().default("draft").notNull(),subtotal:S("subtotal"),tax:S("tax"),shipping:S("shipping"),total:S("total"),notes:p("notes"),createdBy:C("created_by").references(()=>ue.id),createdAt:v("created_at").defaultNow(),updatedAt:v("updated_at").defaultNow(),receivedDate:v("received_date"),supplierOrderConfirmation:p("supplier_order_confirmation"),shippingMethod:p("shipping_method"),paymentMethod:p("payment_method"),paymentTerms:p("payment_terms"),tracking:p("tracking"),attachments:p("attachments").array()}),Xs=E(de).omit({id:!0,createdAt:!0,updatedAt:!0}),It=R("purchase_order_lines",{id:T("id").primaryKey(),purchaseOrderId:C("purchase_order_id").references(()=>de.id).notNull(),itemId:C("item_id").references(()=>L.id).notNull(),quantity:S("quantity").notNull(),unitCost:S("unit_cost").notNull(),lineTotal:S("line_total").notNull(),receivedQuantity:S("received_quantity").default("0"),notes:p("notes"),createdAt:v("created_at").defaultNow()}),en=E(It).omit({id:!0,createdAt:!0}),Wt=R("inventory_counts",{id:T("id").primaryKey(),countReference:p("count_reference").notNull(),startDate:v("start_date").notNull(),endDate:v("end_date"),status:p("status").default("in_progress").notNull(),notes:p("notes"),createdBy:C("created_by").references(()=>ue.id),createdAt:v("created_at").defaultNow()}),tn=E(Wt).omit({id:!0,createdAt:!0}),Yr=R("inventory_count_items",{id:T("id").primaryKey(),countId:C("count_id").references(()=>Wt.id).notNull(),itemId:C("item_id").references(()=>L.id).notNull(),locationId:C("location_id").references(()=>D.id),expectedQuantity:S("expected_quantity"),actualQuantity:S("actual_quantity"),notes:p("notes"),countedBy:C("counted_by").references(()=>ue.id),countedAt:v("counted_at"),createdAt:v("created_at").defaultNow()}),rn=E(Yr).omit({id:!0,createdAt:!0}),j=R("payment_links",{id:T("id").primaryKey(),token:p("token").notNull().unique(),amount:S("amount",{precision:10,scale:2}).notNull(),description:p("description"),customerId:C("customer_id").references(()=>A.id),createdAt:v("created_at").defaultNow(),expiresAt:v("expires_at").notNull(),usedAt:v("used_at"),used:q("used").default(!1),paymentIntentId:p("payment_intent_id"),paymentStatus:p("payment_status").default("pending")}),on=E(j).omit({id:!0,createdAt:!0,usedAt:!0,used:!0,paymentIntentId:!0,paymentStatus:!0}),an=["inventory_location","inventory_item","material_order","customer_order","production_status","artwork_location"],Be=R("qr_codes",{id:T("id").primaryKey(),code:p("code").notNull().unique(),type:p("type").$type().notNull(),entityId:p("entity_id").notNull(),title:p("title").notNull(),description:p("description"),metadata:xe("metadata"),createdAt:v("created_at").defaultNow(),lastScanned:v("last_scanned"),scanCount:C("scan_count").default(0),active:q("active").default(!0)}),Qr=E(Be).omit({id:!0,createdAt:!0,lastScanned:!0,scanCount:!0}),Ut=R("qr_code_scans",{id:T("id").primaryKey(),qrCodeId:C("qr_code_id").references(()=>Be.id).notNull(),userId:C("user_id").references(()=>ue.id),scannedAt:v("scanned_at").defaultNow(),location:p("location"),action:p("action"),metadata:xe("metadata")}),Jr=E(Ut).omit({id:!0,scannedAt:!0}),Ht=R("material_locations",{id:T("id").primaryKey(),materialType:p("material_type").$type().notNull(),materialId:p("material_id").notNull(),locationId:C("location_id").references(()=>D.id).notNull(),qrCodeId:C("qr_code_id").references(()=>Be.id),quantity:S("quantity").notNull().default("1"),notes:p("notes"),lastUpdated:v("last_updated").defaultNow(),active:q("active").default(!0)}),sn=E(Ht).omit({id:!0,lastUpdated:!0}),z=R("notifications",{id:T("id").primaryKey(),title:p("title").notNull(),description:p("description").notNull(),source:p("source").notNull(),sourceId:p("source_id"),type:p("type").$type().notNull().default("info"),createdAt:v("created_at").defaultNow(),read:q("read").default(!1),actionable:q("actionable").default(!1),link:p("link"),smsEnabled:q("sms_enabled").default(!1),smsRecipient:p("sms_recipient"),userId:C("user_id").references(()=>ue.id)}),nn=E(z).omit({id:!0,createdAt:!0}),Zr=R("frame_configuration_bookmarks",{id:T("id").primaryKey(),name:p("name").notNull(),description:p("description"),frames:xe("frames").notNull(),mats:xe("mats").notNull(),glassOptionId:p("glass_option_id").references(()=>ie.id),useMultipleMats:q("use_multiple_mats").default(!1),useMultipleFrames:q("use_multiple_frames").default(!1),defaultArtworkWidth:S("default_artwork_width"),defaultArtworkHeight:S("default_artwork_height"),defaultMatWidth:S("default_mat_width"),tags:p("tags").array(),usageCount:C("usage_count").default(0),lastUsed:v("last_used"),isFavorite:q("is_favorite").default(!1),isPublic:q("is_public").default(!1),createdBy:C("created_by").references(()=>ue.id),createdAt:v("created_at").defaultNow(),updatedAt:v("updated_at").defaultNow()}),cn=E(Zr).omit({id:!0,createdAt:!0,updatedAt:!0,usageCount:!0,lastUsed:!0})});var Xr,eo=_(()=>{"use strict";Xr=[{id:"studio-SM1001",name:"Studio Classic Oak Profile",manufacturer:"Studio Moulding",material:"wood",width:"2.0",depth:"1.5",price:"15.99",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",color:"#D2B48C",description:"Traditional oak frame with natural finish"},{id:"studio-SM1002",name:"Studio Modern Black Metal",manufacturer:"Studio Moulding",material:"metal",width:"1.5",depth:"0.75",price:"12.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",color:"#000000",description:"Sleek black metal frame with matte finish"},{id:"studio-SM2001",name:"Studio Antique Gold Ornate",manufacturer:"Studio Moulding",material:"wood",width:"3.0",depth:"2.0",price:"28.75",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",color:"#FFD700",description:"Ornate gold leaf frame for traditional artwork"},{id:"studio-SM2002",name:"Studio Silver Leaf Contemporary",manufacturer:"Studio Moulding",material:"wood",width:"2.5",depth:"1.25",price:"22.99",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",color:"#C0C0C0",description:"Contemporary silver leaf frame"},{id:"studio-SM3001",name:"Studio Rustic Barnwood",manufacturer:"Studio Moulding",material:"wood",width:"2.75",depth:"1.75",price:"18.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60",color:"#8B4513",description:"Distressed barnwood frame for rustic appeal"}]});var to={};U(to,{default:()=>yn,filterFrames:()=>hn,frameCatalog:()=>N,getFrameById:()=>ln,getFramesByManufacturer:()=>un,getFramesByMaterial:()=>dn,getFramesByPriceRange:()=>pn,getFramesByWidthRange:()=>mn,getUniqueManufacturers:()=>gn,getUniqueMaterials:()=>fn});var N,ln,un,dn,mn,pn,gn,fn,hn,yn,xt=_(()=>{"use strict";eo();N=[{id:"larson-4512",name:"Larson Gold Leaf 4512",manufacturer:"Larson-Juhl",material:"wood",width:"2.5",depth:"1.75",price:"12.99",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#D4AF37"},{id:"larson-210286",name:"Larson Academie Black 210286",manufacturer:"Larson-Juhl",material:"wood",width:"1.25",depth:"0.75",price:"8.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#000000"},{id:"L655320",name:"Larson Biltmore Gold L655320",manufacturer:"Larson-Juhl",material:"wood",width:"1.5",depth:"0.875",price:"10.75",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#FFD700"},{id:"L460530",name:"Larson Ventura Silver L460530",manufacturer:"Larson-Juhl",material:"metal",width:"0.75",depth:"1.125",price:"9.25",catalogImage:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#C0C0C0"},{id:"L310445",name:"Larson Classic Walnut L310445",manufacturer:"Larson-Juhl",material:"wood",width:"2.0",depth:"1.25",price:"14.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#8B4513"},{id:"L220158",name:"Larson Heritage Cherry L220158",manufacturer:"Larson-Juhl",material:"wood",width:"1.75",depth:"1.0",price:"11.25",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#722F37"},{id:"N71",name:"Nielsen Florentine N71",manufacturer:"Nielsen",material:"metal",width:"1.25",depth:"0.75",price:"8.99",catalogImage:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#C0C0C0"},{id:"R250",name:"Roma Dark Walnut R250",manufacturer:"Roma Moulding",material:"wood",width:"3.0",depth:"2.0",price:"14.50",catalogImage:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#5C4033"},{id:"O102",name:"Omega Black Satin O102",manufacturer:"Omega Moulding",material:"wood",width:"2.0",depth:"1.5",price:"9.75",catalogImage:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#2D2D2D"},{id:"B35",name:"Bella White Simple B35",manufacturer:"Bella Moulding",material:"composite",width:"1.5",depth:"1.0",price:"6.50",catalogImage:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#F5F5F5"},{id:"L8921",name:"Larson Ornate Gold L8921",manufacturer:"Larson-Juhl",material:"wood",width:"3.5",depth:"2.25",price:"18.99",catalogImage:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#D4AF37"},...Xr],ln=o=>N.find(e=>e.id===o),un=o=>o==="all"?N:N.filter(e=>e.manufacturer===o),dn=o=>o==="all"?N:N.filter(e=>e.material===o),mn=o=>{switch(o){case"narrow":return N.filter(e=>parseFloat(e.width)<=1.5);case"medium":return N.filter(e=>parseFloat(e.width)>1.5&&parseFloat(e.width)<=2.5);case"wide":return N.filter(e=>parseFloat(e.width)>2.5);default:return N}},pn=o=>{switch(o){case"economy":return N.filter(e=>parseFloat(e.price)>=5&&parseFloat(e.price)<=9);case"standard":return N.filter(e=>parseFloat(e.price)>9&&parseFloat(e.price)<=14);case"premium":return N.filter(e=>parseFloat(e.price)>14);default:return N}},gn=()=>{let o=new Set(N.map(e=>e.manufacturer));return["all",...Array.from(o)]},fn=()=>{let o=new Set(N.map(e=>e.material));return["all",...Array.from(o)]},hn=(o="all",e="all",t="all",r="all")=>N.filter(a=>{let s=o==="all"||a.material===o,n=e==="all"||a.manufacturer===e,c=parseFloat(a.width),i=parseFloat(a.price),d=t==="all"||t==="narrow"&&c<=1.5||t==="medium"&&c>1.5&&c<=2.5||t==="wide"&&c>2.5,h=r==="all"||r==="economy"&&i>=5&&i<=9||r==="standard"&&i>9&&i<=14||r==="premium"&&i>14;return s&&n&&d&&h}),yn=N});var Ct,ro=_(()=>{"use strict";Ct=[{id:"float-mount",name:"Float Mount",description:"Artwork appears to float",price:"50.00"},{id:"glass-float",name:"Glass Float",description:"Suspended between glass",price:"55.00"},{id:"shadowbox",name:"Shadowbox",description:"For 3D objects",price:"65.00"},{id:"labor-30min",name:"Additional Labor (30 min)",description:"Custom work",price:"30.00"},{id:"labor-1hour",name:"Additional Labor (1 hour)",description:"Custom work",price:"55.00"}]});var Kt,oo=_(()=>{"use strict";Kt=null;console.log("Server: Using PostgreSQL database directly via Drizzle ORM instead of Supabase");Kt={from:()=>({select:()=>Promise.resolve({data:[],error:null}),insert:()=>Promise.resolve({data:[],error:null}),update:()=>Promise.resolve({data:[],error:null}),delete:()=>Promise.resolve({data:null,error:null}),upsert:()=>Promise.resolve({data:null,error:null})}),rpc:()=>Promise.resolve({data:null,error:null})}});var ao={};U(ao,{db:()=>m,pool:()=>zt,supabase:()=>Kt});import{Pool as bn,neonConfig as wn}from"@neondatabase/serverless";import{drizzle as Pn}from"drizzle-orm/neon-serverless";import Sn from"ws";var zt,m,H=_(()=>{"use strict";Q();oo();wn.webSocketConstructor=Sn;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");zt=new bn({connectionString:process.env.DATABASE_URL,max:10,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});zt.query("SELECT 1 as test").then(()=>{console.log("\u2713 Database connection successful")}).catch(o=>{console.error("\u2717 Database connection failed:",o)});m=Pn({client:zt,schema:Gt})});function Vt(o,e,t,r){let a=o/e,s=t+r;return a/s}function so(o,e,t,r){let a=o+t*2,s=e+t*2,n=a+s,c=n*r*1,i=2.5;n<=24?i=2.5:n<=36?i=2.3:n<=50?i=2.2:n<=68?i=2.1:n<=88?i=2:n<=108?i=1.9:i=1.8;let d=In(n)*.5;return c*i+d}function no(o,e,t,r){return vn(o,e,t,r).retailPrice}function vn(o,e,t,r){let a=o+t*2,s=e+t*2,n=a*s/144,c="Regular Glass",i=2.25,d=8;r>.3?(c="Museum Glass",i=8.5,d=32):r>.15?(c="Conservation Glass",i=4.75,d=18):r>.1&&(c="Premium Acrylic",i=3.25,d=12);let h=n*i,g=Math.max(n*d,15),u=g-h,l=u/g;return{wholesaleCost:h,retailPrice:g,profit:u,profitMargin:l,glassType:c,areaInSqFt:n}}function In(o){let e=15;return o<=24?e=15:o<=36?e=20:o<=50?e=25:o<=68?e=35:o<=88?e=45:o<=108?e=55:e=65,e}var io=_(()=>{"use strict"});async function co(o,e,t,r){let a=`pricing:${o}:${e}:${t}:${r.width}x${r.height}x${r.matWidth}`;return await Ze.get(a)}async function lo(o,e,t,r,a){let s=`pricing:${o}:${e}:${t}:${r.width}x${r.height}x${r.matWidth}`;await Ze.set(s,a,6e5)}var Yt,Ze,Qt=_(()=>{"use strict";Yt=class{constructor(){k(this,"cache",new Map);k(this,"defaultTTL",3e5);setInterval(()=>this.cleanup(),3e5)}async get(e){let t=this.cache.get(e);return t?Date.now()>t.expiry?(this.cache.delete(e),null):t.value:null}async set(e,t,r=this.defaultTTL){this.cache.set(e,{value:t,expiry:Date.now()+r})}async del(e){this.cache.delete(e)}async exists(e){let t=this.cache.get(e);return t?Date.now()>t.expiry?(this.cache.delete(e),!1):!0:!1}cleanup(){let e=Date.now();for(let[t,r]of this.cache.entries())e>r.expiry&&this.cache.delete(t)}},Ze=new Yt});import{createLogger as xn,format as Jt,transports as Cn}from"winston";function Xt(o,e){let t=new Date().toISOString(),r=e?`[${e}]`:"";console.log(`${t} ${r} ${o}`)}var We,Zt,se,ke=_(()=>{"use strict";We=xn({level:"info",format:Jt.combine(Jt.timestamp(),Jt.json()),transports:[new Cn.Console]});Zt=class{constructor(){k(this,"winston",We)}info(e,t){this.winston.info(e,{...t,timestamp:new Date().toISOString()})}warn(e,t){this.winston.warn(e,{...t,timestamp:new Date().toISOString()})}error(e,t){let r={message:e,error:t.error instanceof Error?t.error.message:t.error,stack:t.error instanceof Error?t.error.stack:t.stack,severity:t.severity,timestamp:new Date().toISOString(),...t};this.winston.error(r),t.severity==="critical"&&this.sendToCriticalMonitoring(r)}integration(e,t,r,a){let s={integration:e,operation:t,success:r,timestamp:new Date().toISOString(),...a};r?this.winston.info(`Integration success: ${e}.${t}`,s):this.winston.error(`Integration failure: ${e}.${t}`,s)}async sendToCriticalMonitoring(e){try{console.error("CRITICAL ERROR:",JSON.stringify(e,null,2))}catch(t){console.error("Failed to send to monitoring:",t)}}},se=new Zt});var be,W,kt=_(()=>{"use strict";be=class{constructor(e,t=5,r=6e4,a=3){this.name=e;k(this,"state");k(this,"failureThreshold");k(this,"resetTimeout");k(this,"successThreshold");this.state={state:"CLOSED",failureCount:0,lastFailureTime:0,successCount:0},this.failureThreshold=t,this.resetTimeout=r,this.successThreshold=a}async execute(e){if(this.state.state==="OPEN")if(Date.now()-this.state.lastFailureTime>this.resetTimeout)this.state.state="HALF_OPEN",this.state.successCount=0,console.log(`Circuit breaker ${this.name} transitioning to HALF_OPEN`);else throw new Error(`Circuit breaker ${this.name} is OPEN - operation blocked`);try{let t=await e();return this.onSuccess(),t}catch(t){throw this.onFailure(),t}}onSuccess(){this.state.failureCount=0,this.state.state==="HALF_OPEN"&&(this.state.successCount++,this.state.successCount>=this.successThreshold&&(this.state.state="CLOSED",console.log(`Circuit breaker ${this.name} transitioning to CLOSED`)))}onFailure(){this.state.failureCount++,this.state.lastFailureTime=Date.now(),this.state.failureCount>=this.failureThreshold&&(this.state.state="OPEN",console.error(`Circuit breaker ${this.name} transitioning to OPEN after ${this.state.failureCount} failures`))}getState(){return{...this.state}}},W={database:new be("Database",3,3e4),openai:new be("OpenAI",5,6e4),stripe:new be("Stripe",3,45e3),supabase:new be("Supabase",4,3e4),larsonApi:new be("Larson API",5,12e4),twilio:new be("Twilio",3,3e4)}});var uo={};U(uo,{cacheService:()=>kn});var Xe,kn,mo=_(()=>{"use strict";Xe=class{constructor(){k(this,"cache",new Map);k(this,"maxSize",1e3)}set(e,t,r=300){this.cache.size>=this.maxSize&&this.cleanup(),this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r*1e3})}get(e){let t=this.cache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.cache.delete(e),null):t.data:null}has(e){let t=this.cache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.cache.delete(e),!1):!0:!1}delete(e){return this.cache.delete(e)}clear(){this.cache.clear()}cleanup(){let e=Date.now(),t=[];for(let[r,a]of this.cache.entries())e-a.timestamp>a.ttl&&t.push(r);t.forEach(r=>this.cache.delete(r)),this.cache.size>=this.maxSize&&Array.from(this.cache.entries()).sort((s,n)=>s[1].timestamp-n[1].timestamp).slice(0,Math.floor(this.maxSize*.2)).forEach(([s])=>this.cache.delete(s))}getStats(){return{size:this.cache.size,maxSize:this.maxSize}}},kn={pricing:new Xe,catalog:new Xe,frames:new Xe,getPricingCacheKey(o){return`pricing:${JSON.stringify(o)}`},getFramesCacheKey(){return"frames:all"},getMatboardsCacheKey(){return"matboards:all"},async getCachedPricing(o,e,t=300){let r=this.pricing.get(o);if(r)return r;try{let a=await e();return this.pricing.set(o,a,t),a}catch(a){throw console.error("Error calculating pricing:",a),a}},async getCachedCatalog(o,e,t=600){let r=this.catalog.get(o);if(r)return r;try{let a=await e();return this.catalog.set(o,a,t),a}catch(a){throw console.error("Error fetching catalog data:",a),a}}}});var po={};U(po,{CircuitBreaker:()=>Fe,circuitBreakers:()=>Fn});var Fe,Fn,go=_(()=>{"use strict";Fe=class{constructor(e=5,t=6e4,r=6e4){this.threshold=e;this.timeout=t;this.monitoringPeriod=r;k(this,"failures",0);k(this,"lastFailureTime",0);k(this,"state","CLOSED")}async execute(e,t){if(this.state==="OPEN")if(Date.now()-this.lastFailureTime>this.timeout)this.state="HALF_OPEN";else{if(t)return await t();throw new Error("Circuit breaker is OPEN")}try{let r=await e();return this.onSuccess(),r}catch(r){if(this.onFailure(),t)return await t();throw r}}onSuccess(){this.failures=0,this.state="CLOSED"}onFailure(){this.failures++,this.lastFailureTime=Date.now(),this.failures>=this.threshold&&(this.state="OPEN")}getState(){return{state:this.state,failures:this.failures,lastFailureTime:this.lastFailureTime}}},Fn={openai:new Fe(3,3e4),stripe:new Fe(5,6e4),supabase:new Fe(3,3e4),database:new Fe(3,15e3)}});var ho={};U(ho,{calculateFramePrice:()=>fo,calculateFramingPrice:()=>or,calculateGlassPrice:()=>An,calculateMatPrice:()=>On});function fo(o,e){let t=o*e,r=2.5;return t>=40?r=2.2:t>=25?r=2.4:t>=15?r=2.6:t>=10?r=2.8:t>=6?r=3:t>=4?r=3.2:t>=2?r=3.5:r=4,t*r}function On(o,e,t){let r=Nn(t);return e*o*r}function An(o,e,t=0,r=0,a="regular"){let s=t&&r?t+r:Math.sqrt(e)*2,n=En(s),c=1;switch(a){case"conservation":c=1.5;break;case"museum":c=2;break}let i=e/144;return(s<=40?85:125)+i*o*n*.35*c}function En(o){return o<=20?2.8:o<=40?3.2:o<=60?3.6:o<=80?4:4.5}function Nn(o){return o<=20?2.5:o<=40?2.8:o<=60?3.1:o<=80?3.4:3.8}function Mn(o,e,t,r){let a=r/40;return{frameAssembly:o?.25*a:0,matCutting:e?.3*a:0,glassCutting:t?.15*a:0,fitting:.2*a,finishing:.1*a}}function jn(o,e,t){return(o.frameAssembly+o.matCutting+o.glassCutting+o.fitting+o.finishing)*e*t}async function or(o){let{cacheService:e}=await Promise.resolve().then(()=>(mo(),uo)),{circuitBreakers:t}=await Promise.resolve().then(()=>(go(),po)),r=e.getPricingCacheKey(o);try{return await e.getCachedPricing(r,async()=>await t.database.execute(()=>Dn(o),()=>rr(o)))}catch(a){return console.error("Pricing calculation failed:",a),rr(o)}}async function Dn(o){let{frameId:e,matColorId:t,glassOptionId:r,artworkWidth:a,artworkHeight:s,matWidth:n,quantity:c,includeWholesalePrices:i=!1}=o;try{let d=await co(e||"none",t||"none",r||"none",{width:a,height:s,matWidth:n});if(d)return se.info("Pricing served from cache",{operation:"calculateFramingPrice",frameId:e,cached:!0}),d}catch(d){se.warn("Cache retrieval failed, proceeding with calculation",{error:d,operation:"calculateFramingPrice"})}try{let d=await W.database.execute(async()=>await Ln(o));try{await lo(e||"none",t||"none",r||"none",{width:a,height:s,matWidth:n},d)}catch(h){se.warn("Failed to cache pricing result",{error:h,operation:"calculateFramingPrice"})}return d}catch(d){return se.error("Pricing calculation failed, using fallback",{error:d,severity:"high",operation:"calculateFramingPrice",frameId:e,matColorId:t,glassOptionId:r}),rr(o)}}function rr(o){let{artworkWidth:e,artworkHeight:t,matWidth:r,quantity:a}=o,s=e+r*2+(t+r*2),n=s*2.5,c=s*1.8,i=s*1.2,d=15,h=Math.max(s*.8,25),g=n+c+i+d,u=g+h,l=u*a;return se.info("Fallback pricing applied",{operation:"calculateFallbackPricing",unitedInches:s,totalPrice:l}),{framePrice:n,matPrice:c,glassPrice:i,backingPrice:d,laborCost:h,materialCost:g,subtotal:u,totalPrice:l,laborRates:{baseRate:tr,regionalFactor:er,estimates:{frameAssembly:.5,matCutting:.5,glassCutting:.3,fitting:.3,finishing:.2}}}}async function Ln(o){let{frameId:e,matColorId:t,glassOptionId:r,artworkWidth:a,artworkHeight:s,matWidth:n,quantity:c,includeWholesalePrices:i=!1}=o,d=e&&e!=="none"?await y.getFrame(e):null,h=t&&t!=="none"?await y.getMatColor(t):null,g=r&&r!=="none"?await y.getGlassOption(r):null,u=a+s,l=a+n*2,f=s+n*2,b=l+f,F=l*f-a*s,P=l*2+f*2,M=i?{frame:d?d.price:"0.00",mat:"0.00",glass:g&&g.price||"0.00",backing:"0.00"}:void 0,oe=0;if(d){let Te=parseFloat(d.price),Ke=a+n*2,ze=s+n*2,Z=(Ke+ze)/12;if(oe=fo(Te,Z),M){let he=Z*Te;M.frame=he.toFixed(2)}}let Y=0;if(h){let Z=Vt(45.5,25,32,40);if(Y=so(a,s,n,Z),M){let he=a+n*2,Ve=s+n*2,Ye=(he+Ve)*Z;M.mat=Ye.toFixed(2)}}let ge=0;if(g){let Z=Vt(125,10,24,36);if(ge=no(a,s,n,Z),M){let he=a+n*2,Ve=s+n*2,Ye=(he+Ve)*Z;M.glass=Ye.toFixed(2)}}let fe=.04,bt=l*f,Ur=bt*fe*_n;M&&(M.backing=(bt*fe).toFixed(2));let Hr=Mn(!!d,!!h,!!g,b),qt=jn(Hr,tr,er),Gr=oe+Y+ge+Ur,Ge=Gr+qt,ws=Ge*c,Kr;if(i&&M){let Te=d?parseFloat(d.price)*P/12:0,Ke=h?parseFloat(M.mat):0,ze=g&&g.price?parseFloat(g.price)*l*f/144:0,wt=parseFloat(M.backing),Z=Te+Ke+ze+wt,he=Z*Rn,Ve=Z+he+qt,Pt=Ge-Ve,Ye=Pt/Ge,Ps=Ge/Z;Kr={totalWholesaleCost:Z,overheadCost:he,grossProfit:Pt,grossProfitMargin:Ye,markupMultiplier:Ps}}return{framePrice:oe,matPrice:Y,glassPrice:ge,backingPrice:Ur,laborCost:qt,materialCost:Gr,subtotal:Ge,totalPrice:ws,wholesalePrices:M,laborRates:{baseRate:tr,regionalFactor:er,estimates:Hr},profitability:Kr}}var _n,er,tr,Rn,ar=_(()=>{"use strict";J();io();Qt();ke();kt();_n=1.2,er=1.15,tr=45,Rn=.3});import Tn from"axios";async function sr(o){try{let e=await Tn.post(`${$n}/api/notifications/send`,{to:o.to,subject:o.subject,message:o.message,orderId:o.orderId,customerName:o.customerName,type:o.type||"order_update",source:"Jays Frames POS",method:"email",deliveryType:"email"},{headers:{Authorization:`Bearer ${qn}`,"Content-Type":"application/json"},timeout:1e4});if(e.data&&e.data.success)console.log(`Email notification sent successfully to ${o.to} via SMS Hub`);else throw new Error(e.data?.error||"SMS Hub returned error response")}catch(e){throw console.error("SMS Hub Error:",e.message),e.response&&console.error("SMS Hub Response:",e.response.data),new Error(`Failed to send email notification via SMS Hub: ${e.message}`)}}async function yo(o,e,t,r,a){let s=`Hi ${t}, your order #${r} status has been updated to: ${a}. Thank you for choosing Jay's Frames!`;await sr({to:o,subject:`Order #${r} Update`,message:s,orderId:r,customerName:t,type:"status_update"})}var $n,qn,bo=_(()=>{"use strict";$n="https://telitel-sms-hub-JayFrames.replit.app",qn=process.env.SMS_HUB_API_KEY||"jays_frames_api_2025"});var nr={};U(nr,{generateOrderStatusEmailTemplate:()=>Wn,sendEmailWithSendGrid:()=>et,sendOrderStatusUpdate:()=>tt});async function et(o){console.log("Using SMS Hub instead of SendGrid for notifications");try{await sr({to:o.to,subject:o.subject,message:o.text||Bn(o.html||""),type:"email_replacement"})}catch(e){throw console.error("SMS Hub notification error:",e.message),new Error(`Failed to send notification via SMS Hub: ${e.message}`)}}function Bn(o){return o.replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").trim()}function Wn(o,e,t,r){let a=t.split("_").map(h=>h.charAt(0).toUpperCase()+h.slice(1)).join(" "),s=r?new Date(r).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):"Not available",n=["order_processed","scheduled","materials_ordered","materials_arrived","frame_cut","mat_cut","prepped","completed"],c=n.indexOf(t),d=`
    <div style="margin: 20px 0; width: 100%;">
      <div style="width: 100%; background-color: #f0f0f0; height: 20px; border-radius: 10px; overflow: hidden;">
        <div style="width: ${Math.max(10,Math.min(100,Math.round((c+1)/n.length*100)))}%; background-color: #4CAF50; height: 20px;"></div>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px;">
        <span>Order Placed</span>
        <span>In Production</span>
        <span>Completed</span>
      </div>
    </div>
  `;return`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>Order Status Update</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          line-height: 1.6;
          color: #333;
          margin: 0;
          padding: 0;
        }
        .container {
          max-width: 600px;
          margin: 0 auto;
          padding: 20px;
        }
        .header {
          background-color: #4A90E2;
          color: white;
          padding: 20px;
          text-align: center;
        }
        .content {
          padding: 20px;
          background-color: #f9f9f9;
        }
        .footer {
          text-align: center;
          padding: 20px;
          font-size: 12px;
          color: #666;
        }
        .button {
          display: inline-block;
          background-color: #4A90E2;
          color: white;
          padding: 10px 20px;
          text-decoration: none;
          border-radius: 5px;
          margin-top: 20px;
        }
        .status-box {
          background-color: #e8f4fd;
          border-left: 4px solid #4A90E2;
          padding: 15px;
          margin: 20px 0;
        }
        .details-table {
          width: 100%;
          border-collapse: collapse;
          margin: 20px 0;
        }
        .details-table th, .details-table td {
          border: 1px solid #ddd;
          padding: 10px;
          text-align: left;
        }
        .details-table th {
          background-color: #f0f0f0;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>Order Status Update</h1>
        </div>
        
        <div class="content">
          <p>Hello ${o},</p>
          
          <p>We're writing to provide you with an update on your custom framing order.</p>
          
          <div class="status-box">
            <h2>Order #${e} Status: ${a}</h2>
            <p>Your order is now in the <strong>${a}</strong> stage.</p>
            <p><strong>Estimated Completion:</strong> ${s}</p>
          </div>
          
          ${d}
          
          <h3>What's Next?</h3>
          <p>Your order is progressing through our custom framing process. Here's what's happening:</p>
          
          <table class="details-table">
            <tr>
              <th>Current Stage</th>
              <th>Description</th>
            </tr>
            <tr>
              <td>${a}</td>
              <td>${Un(t)}</td>
            </tr>
          </table>
          
          <p>We'll notify you when your order moves to the next stage or is ready for pickup.</p>
          
          <a href="#" class="button">Track Your Order</a>
        </div>
        
        <div class="footer">
          <p>Thank you for choosing Jays Frames Guru Framing</p>
          <p>123 Frame Street, Anytown, ST 12345</p>
          <p>Phone: (555) 123-4567 | Email: info@jaysframes.com</p>
        </div>
      </div>
    </body>
    </html>
  `}async function tt(o,e,t,r,a){console.log(`Sending order status update via SMS Hub for order #${t}`),await yo(o,"",e,t.toString(),r)}function Un(o){switch(o){case"order_processed":return"Your order has been processed and is scheduled for production.";case"scheduled":return"Your order has been scheduled and is in our production queue.";case"materials_ordered":return"We have ordered the special materials needed for your custom frame.";case"materials_arrived":return"All materials for your order have arrived and are ready for production.";case"frame_cut":return"Your frame has been cut to the specified dimensions.";case"mat_cut":return"Your mat board has been cut and prepared for assembly.";case"prepped":return"Your frame is assembled and is going through final quality checks.";case"completed":return"Your order is complete and ready for pickup!";case"delayed":return"Your order is temporarily delayed. We will contact you with more information.";default:return"Your order is being processed by our team."}}var rt=_(()=>{"use strict";bo()});var wo={};U(wo,{DatabaseStorage:()=>Ot,storage:()=>y});import{eq as w,desc as Pe,asc as ir,and as Hn,or as Ft}from"drizzle-orm";function we(o){let{material:e,name:t}=o,r=e.toLowerCase(),a=t.toLowerCase();return r.includes("gold")||a.includes("gold")?"#D4AF37":r.includes("silver")||r.includes("metal")||a.includes("silver")||a.includes("metal")||a.includes("chrome")||a.includes("steel")?"#C0C0C0":r.includes("black")||a.includes("black")||a.includes("ebony")||a.includes("onyx")?"#000000":r.includes("white")||a.includes("white")?"#F5F5F5":r.includes("walnut")||a.includes("walnut")?"#5C4033":r.includes("cherry")||a.includes("cherry")?"#722F37":r.includes("oak")||a.includes("oak")?"#D8BE75":r.includes("mahogany")||a.includes("mahogany")?"#4E2728":r.includes("maple")||a.includes("maple")?"#E8D4A9":"#8B4513"}var Ot,y,J=_(()=>{"use strict";Q();xt();ro();H();Ot=class{constructor(){k(this,"initialized",!1);k(this,"initPromise");console.log("DatabaseStorage: Initializing storage system"),this.initialized=!1,this.initPromise=this.init(),this.initPromise.then(()=>{this.initializeMatColors(),this.initializeDefaultFrames(),this.initializeDefaultGlassOptions()})}async init(){try{this.initialized=!0,console.log("DatabaseStorage: Successfully initialized storage system")}catch(e){throw console.error("DatabaseStorage: Error initializing storage system:",e),e}}async ensureInitialized(){this.initialized||(console.log("DatabaseStorage: Waiting for initialization..."),await this.initPromise,console.log("DatabaseStorage: Initialization complete"))}async initializeMatColors(){try{if((await m.select().from(ae).limit(1)).length>0){console.log("Mat colors already initialized");return}console.log("Initializing mat colors...");let t=[{id:"white",name:"White",color:"#FFFFFF",price:"0.025",manufacturer:"Crescent",code:"C9502",description:"Standard white mat board",category:"Whites"},{id:"crescent-cream",name:"Cream",color:"#FFF8E1",price:"0.025",manufacturer:"Crescent",code:"C9503",description:"Cream white conservation mat board",category:"Whites"},{id:"black",name:"Black",color:"#000000",price:"0.030",manufacturer:"Crescent",code:"C9800",description:"Standard black mat board",category:"Blacks"}];await m.insert(ae).values(t),console.log("Successfully initialized mat colors")}catch(e){console.error("Error initializing mat colors:",e)}}async initializeDefaultFrames(){try{if((await m.select().from(O).limit(1)).length>0){console.log("Frames already initialized");return}console.log("Initializing default frames...");let t=[{id:"G001",name:"Simple Black Frame G001",material:"Wood",width:"1.5",height:"0.75",price:"8.50",manufacturer:"Generic",catalogImage:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=400",description:"Simple black wood frame"},{id:"G002",name:"Simple White Frame G002",material:"Wood",width:"1.5",height:"0.75",price:"8.50",manufacturer:"Generic",catalogImage:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=400",description:"Simple white wood frame"}];await m.insert(O).values(t),console.log("Successfully initialized default frames")}catch(e){console.error("Error initializing default frames:",e)}}async initializeDefaultGlassOptions(){try{if((await m.select().from(ie).limit(1)).length>0){console.log("Glass options already initialized");return}console.log("Initializing default glass options...");let t=[{id:"standard",name:"Standard Glass",price:"0.25",description:"Regular picture frame glass"},{id:"acrylic",name:"Acrylic Glass",price:"0.35",description:"Lightweight acrylic glazing"},{id:"uv",name:"UV Protection Glass",price:"0.45",description:"UV protection glazing"},{id:"museum",name:"Museum Glass",price:"0.85",description:"Premium museum-quality glazing"},{id:"reflection_control",name:"Reflection Control Glass",price:"0.65",description:"Anti-reflective glazing"}];await m.insert(ie).values(t),console.log("Successfully initialized default glass options")}catch(e){console.error("Error initializing default glass options:",e)}}async updateOrderArtLocation(e,t){try{let[r]=await m.update(x).set({artworkLocation:t}).where(w(x.id,e)).returning();if(!r)throw new Error("Order not found");return r}catch(r){throw console.error("Error updating order artwork location:",r),r}}async getOrderMats(e){try{let t=await m.select().from(Qe).where(w(Qe.orderId,e)),r=[];for(let a of t){let s=await this.getMatColor(a.matColorId);s&&r.push({...a,matboard:s})}return r}catch(t){return console.error("Error getting order mats for order "+e+":",t),[]}}async getOrderFrames(e){try{let t=await m.select().from(Je).where(w(Je.orderId,e)),r=[];for(let a of t){let s=await this.getFrame(a.frameId);s&&r.push({...a,frame:s})}return r}catch(t){return console.error("Error getting order frames for order "+e+":",t),[]}}async getOrderPricingDetails(e){try{let t=await this.getOrder(e);if(!t)return;let{calculatePricing:r}=(ar(),zr(ho)),a=t.frameId?await this.getFrame(t.frameId):void 0,s=t.matColorId?await this.getMatColor(t.matColorId):void 0,n=t.glassOptionId?await this.getGlassOption(t.glassOptionId):void 0,c=await this.getOrderSpecialServices(e),i=await this.getOrderMats(e),d=await this.getOrderFrames(e),h={artworkWidth:Number(t.artworkWidth),artworkHeight:Number(t.artworkHeight),matWidth:Number(t.matWidth),frame:a,matColor:s,glassOption:n,specialServices:c,quantity:t.quantity||1,includeWholesalePrices:!0,mats:i.length>0?i:void 0,frames:d.length>0?d:void 0};return r(h)}catch(t){console.error("Error getting order pricing details:",t);return}}async getCustomer(e){let[t]=await m.select().from(A).where(w(A.id,e));return t||void 0}async getCustomerByEmail(e){let[t]=await m.select().from(A).where(w(A.email,e));return t||void 0}async getAllCustomers(){return await m.select().from(A)}async createCustomer(e){let[t]=await m.insert(A).values({...e,createdAt:new Date}).returning();return t}async updateCustomer(e,t){let[r]=await m.update(A).set(t).where(w(A.id,e)).returning();if(!r)throw new Error("Customer not found");return r}async getFrame(e){console.log("Storage: Getting frame with ID: "+e);try{let[t]=await m.select().from(O).where(w(O.id,e));if(t){console.log("Storage: Found frame in database: "+t.name);let a=we(t),s=t.catalogImage,n=t.corner||"",c=t.edgeTexture||"";if(t.manufacturer==="Larson-Juhl"){let i=t.id.split("-")[1];i&&(s="https://www.larsonjuhl.com/contentassets/products/mouldings/"+i+"_fab.jpg",n="https://www.larsonjuhl.com/contentassets/products/mouldings/"+i+"_corner.jpg",c="https://www.larsonjuhl.com/contentassets/products/mouldings/"+i+"_prof.jpg")}if(t.manufacturer==="Nielsen"){let i=t.id.split("-")[1];i&&(s="https://www.nielsenbainbridge.com/images/products/detail/"+i+"-Detail.jpg",n="https://www.nielsenbainbridge.com/images/products/detail/"+i+"-Corner.jpg",c="https://www.nielsenbainbridge.com/images/products/detail/"+i+"-Edge.jpg")}return{...t,catalogImage:s,corner:n,edgeTexture:c,color:a}}console.log("Storage: Frame not found in database, checking catalog");let r=N.find(a=>a.id===e);if(r){console.log("Storage: Found frame in catalog: "+r.name);let a=r.catalogImage,s=r.corner||"",n=r.edgeTexture||"",c=r.color||we(r);if(r.manufacturer==="Larson-Juhl"){let d=r.id.split("-")[1];d&&(a="https://www.larsonjuhl.com/contentassets/products/mouldings/"+d+"_fab.jpg",s="https://www.larsonjuhl.com/contentassets/products/mouldings/"+d+"_corner.jpg",n="https://www.larsonjuhl.com/contentassets/products/mouldings/"+d+"_prof.jpg")}if(r.manufacturer==="Nielsen"){let d=r.id.split("-")[1];d&&(a="https://www.nielsenbainbridge.com/images/products/detail/"+d+"-Detail.jpg",s="https://www.nielsenbainbridge.com/images/products/detail/"+d+"-Corner.jpg",n="https://www.nielsenbainbridge.com/images/products/detail/"+d+"-Edge.jpg")}let i={...r,catalogImage:a,corner:s,edgeTexture:n};console.log("Storage: Inserting enhanced frame into database: "+i.name);try{await m.insert(O).values(i),console.log("Storage: Successfully inserted frame into database")}catch(d){console.error("Storage: Error inserting frame into database:",d)}return{...i,color:c}}console.log("Storage: Frame not found in catalog");return}catch(t){console.error("Storage: Error in getFrame("+e+"):",t);let r=N.find(a=>a.id===e);if(r){let a=we(r),s=r.catalogImage;if(r.manufacturer==="Larson-Juhl"){let n=r.id.split("-")[1];n&&(s="https://www.larsonjuhl.com/contentassets/products/mouldings/"+n+"_fab.jpg")}else if(r.manufacturer==="Nielsen"){let n=r.id.split("-")[1];n&&(s="https://www.nielsenbainbridge.com/images/products/detail/"+n+"-Detail.jpg")}return{...r,catalogImage:s,color:a}}return}}async getAllFrames(){console.log("Storage: Getting all frames");try{let e=await m.select().from(O);return console.log("Storage: Found "+e.length+" frames in database"),e.length>0?(console.log("Storage: Enhancing existing frames with real wholesaler images"),e.map(r=>{let a=we(r),s=r.catalogImage,n=r.corner||"",c=r.edgeTexture||"";if(r.manufacturer==="Larson-Juhl"){let i=r.id.split("-")[1];i&&(s="https://www.larsonjuhl.com/contentassets/products/mouldings/"+i+"_fab.jpg",n="https://www.larsonjuhl.com/contentassets/products/mouldings/"+i+"_corner.jpg",c="https://www.larsonjuhl.com/contentassets/products/mouldings/"+i+"_prof.jpg")}if(r.manufacturer==="Nielsen"){let i=r.id.split("-")[1];i&&(s="https://www.nielsenbainbridge.com/images/products/detail/"+i+"-Detail.jpg",n="https://www.nielsenbainbridge.com/images/products/detail/"+i+"-Corner.jpg",c="https://www.nielsenbainbridge.com/images/products/detail/"+i+"-Edge.jpg")}return{...r,catalogImage:s,corner:n,edgeTexture:c,color:a}})):(console.log("Storage: No frames in database, returning enhanced catalog data"),N.map(r=>{let a=r.catalogImage,s=r.corner||"",n=r.edgeTexture||"",c=r.color||we(r);if(r.manufacturer==="Larson-Juhl"){let d=r.id.split("-")[1];d&&(a="https://www.larsonjuhl.com/contentassets/products/mouldings/"+d+"_fab.jpg",s="https://www.larsonjuhl.com/contentassets/products/mouldings/"+d+"_corner.jpg",n="https://www.larsonjuhl.com/contentassets/products/mouldings/"+d+"_prof.jpg")}if(r.manufacturer==="Nielsen"){let d=r.id.split("-")[1];d&&(a="https://www.nielsenbainbridge.com/images/products/detail/"+d+"-Detail.jpg",s="https://www.nielsenbainbridge.com/images/products/detail/"+d+"-Corner.jpg",n="https://www.nielsenbainbridge.com/images/products/detail/"+d+"-Edge.jpg")}let i={...r,catalogImage:a,corner:s,edgeTexture:n};try{m.insert(O).values(i).execute()}catch(d){console.error("Storage: Error inserting frame "+r.id+" into database:",d)}return{...i,color:c}}))}catch(e){return console.error("Storage: Error in getAllFrames:",e),N.map(t=>{let r=we(t),a=t.id.split("-")[1],s=t.catalogImage;return t.manufacturer==="Larson-Juhl"?s="https://images.unsplash.comcom/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D":t.manufacturer==="Roma"?s="https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D":t.manufacturer==="Omega"?s="https://images.unsplash.com/photo-1513519245088-0e12902e5a38?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8ZnJhbWV8ZW58MHx8MHx8fDA%3D":s="https://images.unsplash.com/photo-1518998053901-5348d3961a04?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fGZyYW1lfGVufDB8fDB8fHww",{...t,catalogImage:s,color:r}})}}async updateFrame(e,t){let[r]=await m.update(O).set(t).where(w(O.id,e)).returning();if(!r)throw new Error("Frame not found");return r}async addFrame(e){console.log("Storage: Adding new frame to database: "+e.name+" ("+e.id+")");try{let[t]=await m.insert(O).values(e).returning();return console.log("Storage: Successfully added frame to database"),t}catch(t){throw console.error("Storage: Error adding frame to database:",t),t}}async searchFramesByItemNumber(e){try{console.log(`Storage: Searching for frames with item number: ${e}`);let t=await m.select().from(O);console.log(`Storage: Found ${t.length} frames in database`);let r=t.filter(a=>(a.id.split("-")[1]||"")===e||a.id.includes(e)||a.name.toLowerCase().includes(e.toLowerCase()));if(r.length===0){console.log(`Storage: No matches in database, searching static catalog for: ${e}`);let a=N.filter(s=>(s.id.split("-")[1]||"")===e||s.id.includes(e)||s.name.toLowerCase().includes(e.toLowerCase()));r=a.map(s=>{let n=we(s),c=s.catalogImage;if(s.manufacturer==="Larson-Juhl"){let i=s.id.split("-")[1];i&&(c=`https://www.larsonjuhl.com/contentassets/products/mouldings/${i}_fab.jpg`)}return{...s,catalogImage:c,color:n}});for(let s of a)try{await m.insert(O).values(s),console.log(`Storage: Inserted frame ${s.id} into database`)}catch(n){n.message.includes("duplicate key")||console.error(`Storage: Error inserting frame ${s.id}:`,n)}}return console.log(`Storage: Found ${r.length} frames matching item number: ${e}`),r}catch(t){return console.error("Error searching frames by item number:",t),console.log(`Storage: Falling back to static catalog search for: ${e}`),N.filter(a=>(a.id.split("-")[1]||"")===e||a.id.includes(e)||a.name.toLowerCase().includes(e.toLowerCase())).map(a=>({...a,color:we(a)}))}}async createOrder(e){try{console.log("DatabaseStorage: Creating order with validated data:",JSON.stringify(e,null,2));let t={customerId:parseInt(e.customerId.toString()),frameId:e.frameId,matColorId:e.matColorId,glassOptionId:e.glassOptionId,artworkWidth:e.artworkWidth,artworkHeight:e.artworkHeight,matWidth:e.matWidth,artworkDescription:e.artworkDescription||"Custom artwork",artworkType:e.artworkType||"print",artworkLocation:e.artworkLocation||null,subtotal:e.subtotal||"0.00",tax:e.tax||"0.00",total:e.total||"0.00",status:e.status||"pending",artworkImage:e.artworkImage||"placeholder-image.jpg",useManualFrame:e.useManualFrame||!1,manualFrameName:e.manualFrameName||null,manualFrameCost:e.manualFrameCost||null,miscChargeDescription:e.miscChargeDescription||null,miscChargeAmount:e.miscChargeAmount||null,createdAt:new Date,updatedAt:new Date};console.log("DatabaseStorage: Inserting order with processed data...");let[r]=await m.insert(x).values(t).returning();return console.log("DatabaseStorage: Order created successfully with ID:",r.id),r}catch(t){throw console.error("DatabaseStorage: Error creating order:",t),console.error("DatabaseStorage: Error details:",{message:t.message,code:t.code,constraint:t.constraint,detail:t.detail}),new Error(`Failed to create order: ${t.message}`)}}async getMatColor(e){try{await this.ensureInitialized();let[t]=await m.select().from(ae).where(w(ae.id,e));return t||void 0}catch(t){console.error("Error getting mat color:",t);return}}async getAllMatColors(){try{await this.ensureInitialized(),await this.initializeMatColors();let e=await m.select().from(ae).orderBy(ae.name);return console.log(`Found ${e.length} mat colors in database`),e}catch(e){throw console.error("Error fetching mat colors:",e),e}}async getGlassOption(e){try{let[t]=await m.select().from(ie).where(w(ie.id,e));return t||void 0}catch(t){console.error("Error getting glass option:",t);return}}async getAllGlassOptions(){try{let e=await m.select().from(ie);return console.log(`Found ${e.length} glass options in database`),e}catch(e){return console.error("Error fetching glass options:",e),[]}}async getSpecialService(e){let[t]=await m.select().from(ce).where(w(ce.id,e));if(!t){let r=Ct.find(a=>a.id===e);if(r)return await m.insert(ce).values(r),r}return t||void 0}async getAllSpecialServices(){let e=await m.select().from(ce);return e.length===0?(await m.insert(ce).values(Ct),Ct):e}async getOrderGroup(e){let[t]=await m.select().from(B).where(w(B.id,e));return t||void 0}async getActiveOrderGroupByCustomer(e){let[t]=await m.select().from(B).where(w(B.customerId,e));return t&&t.status==="open"?t:void 0}async getAllOrderGroups(){return await m.select().from(B)}async createOrderGroup(e){let[t]=await m.insert(B).values({...e,status:"open",createdAt:new Date}).returning();return t}async updateOrderGroup(e,t){let[r]=await m.update(B).set(t).where(w(B.id,e)).returning();if(!r)throw new Error("Order group not found");return r}async getOrderGroupsByCustomerId(e){try{console.log("Storage: Getting order groups for customer ID:",e);let t=await m.select().from(B).where(w(B.customerId,e));return console.log("Storage: Found",t.length,"order groups for customer ID:",e),t}catch(t){throw console.error("Storage: Error getting order groups by customer ID:",t),t}}async getOrdersByGroupId(e){return await m.select().from(x).where(w(x.orderGroupId,e))}async getOrder(e){let[t]=await m.select().from(x).where(w(x.id,e));return t||void 0}async getAllOrders(){try{console.log("DatabaseStorage: Starting getAllOrders query...");let e=await m.select().from(x).leftJoin(A,w(x.customerId,A.id)).orderBy(Pe(x.createdAt));if(console.log("DatabaseStorage: Raw orders from database:",e.length),e.length===0)return console.log("DatabaseStorage: No orders found in database"),[];let t=e.map(r=>(console.log("DatabaseStorage: Processing order ID:",r.orders?.id),{...r.orders,customer:r.customers,status:r.orders.status||"pending",total:r.orders.total||"0.00",artworkWidth:r.orders.artworkWidth||0,artworkHeight:r.orders.artworkHeight||0}));return console.log("DatabaseStorage: Returning",t.length,"orders"),t}catch(e){return console.error("DatabaseStorage: Error fetching orders from database:",e),[]}}async deleteOrder(e){await m.delete(x).where(w(x.id,e))}async createOrderSpecialService(e){let[t]=await m.insert(qe).values(e).returning();return t}async getOrderSpecialServices(e){let r=(await m.select().from(qe).where(w(qe.orderId,e))).map(s=>s.specialServiceId),a=[];for(let s of r)if(s){let n=await this.getSpecialService(s);n&&a.push(n)}return a}async getWholesaleOrder(e){let[t]=await m.select().from(le).where(w(le.id,e));return t||void 0}async getAllWholesaleOrders(){return await m.select().from(le)}async createWholesaleOrder(e){let[t]=await m.insert(le).values({...e,status:"pending",createdAt:new Date}).returning();return t}async updateWholesaleOrder(e,t){let[r]=await m.update(le).set(t).where(w(le.id,e)).returning();if(!r)throw new Error("Wholesale order not found");return r}async getOrdersByProductionStatus(e){return await m.select().from(x).where(w(x.productionStatus,e)).orderBy(x.lastStatusChange)}async updateOrderProductionStatus(e,t){let[r]=await m.select().from(x).where(w(x.id,e));if(!r)throw new Error("Order not found");let a=r.productionStatus,[s]=await m.update(x).set({productionStatus:t,lastStatusChange:new Date}).where(w(x.id,e)).returning();if(s.notificationsEnabled){let[n]=await m.select().from(A).where(w(A.id,r.customerId));if(n)try{let{sendOrderStatusUpdate:c}=await Promise.resolve().then(()=>(rt(),nr)),i=await c(n.email,n.name,r.id,t,a,r.estimatedCompletionDays);await this.createCustomerNotification({customerId:n.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:"Order #"+r.id+" Status Update: "+t,message:"Your order is now "+t.split("_").join(" ")+". Check your email for details.",successful:i,previousStatus:a,newStatus:t,responseData:i?{sent:!0,timestamp:new Date().toISOString()}:{sent:!1,error:"Email failed to send"}}),console.log("Status update email "+i?"sent":"failed for Order #"+r.id+" to "+n.email)}catch(c){console.error("Error sending status update email:",c),await this.createCustomerNotification({customerId:n.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:"Order #"+r.id+" Status Update: "+t,message:"Your order is now "+t.split("_").join(" ")+".",successful:!1,previousStatus:a,newStatus:t,responseData:{error:c.message}})}}return s}async getOrdersForKanban(){return(await m.select({order:x,customer:A}).from(x).leftJoin(A,w(x.customerId,A.id)).orderBy(x.lastStatusChange)).map(t=>({...t.order,customerName:t.customer?t.customer.name:"Unknown Customer",customerPhone:t.customer?.phone||"No phone",customerEmail:t.customer?.email||"No email"}))}async scheduleOrderForProduction(e,t){let[r]=await m.select().from(x).where(w(x.id,e));if(!r)throw new Error("Order not found");let[a]=await m.update(x).set({estimatedCompletionDays:t,productionStatus:"scheduled"}).where(w(x.id,e)).returning();if(a.notificationsEnabled){let[s]=await m.select().from(A).where(w(A.id,r.customerId));if(s){let n=new Date;n.setDate(n.getDate()+t),await this.createCustomerNotification({customerId:s.id,orderId:r.id,notificationType:"estimated_completion",channel:"email",subject:"Your Custom Framing Order #"+r.id+" Has Been Scheduled",message:"Your custom framing order #"+r.id+" has been scheduled for production. The estimated completion date is "+n.toLocaleDateString()+".",successful:!0,previousStatus:r.productionStatus,newStatus:"scheduled"})}}return a}async createCustomerNotification(e){let[t]=await m.insert(G).values({...e}).returning();return t}async getCustomerNotifications(e){return await m.select().from(G).where(w(G.customerId,e)).orderBy(G.sentAt,"desc")}async getNotificationsByOrder(e){return await m.select().from(G).where(w(G.orderId,e)).orderBy(G.sentAt,"desc")}async getMaterialOrder(e){let[t]=await m.select().from(I).where(w(I.id,e));return t}async getAllMaterialOrders(){try{console.log("Getting all material orders from database");let e=await m.select().from(I);return console.log("Found",e.length,"material orders"),e}catch(e){return console.error("Error in getAllMaterialOrders:",e),[]}}async getMaterialOrdersByStatus(e){try{return await m.select().from(I).where(w(I.status,e)).orderBy(Pe(I.createdAt))}catch(t){return console.error("Error in getMaterialOrdersByStatus:",t),[]}}async getMaterialOrdersByType(e){try{return await m.select().from(I).where(w(I.materialType,e)).orderBy(Pe(I.createdAt))}catch(t){return console.error("Error in getMaterialOrdersByType:",t),[]}}async createMaterialOrder(e){console.log("Creating material order with data:",e);let t={...e};t.vendor&&!t.supplierName&&(t.supplierName=t.vendor,delete t.vendor),console.log("Cleaned data for material order creation:",t);try{let[r]=await m.insert(I).values([t]).returning();return console.log("Successfully created material order:",r.id),r}catch(r){throw console.error("Error creating material order:",r),r}}async updateMaterialOrder(e,t){console.log("updateMaterialOrder called with id:",e,"and data:",t);let r=typeof e=="string"&&!isNaN(parseInt(e))?parseInt(e):e,a={...t};a.vendor&&!a.supplierName&&(a.supplierName=a.vendor,delete a.vendor),console.log("Cleaned data for update:",a);try{let[s]=await m.update(I).set(a).where(w(I.id,r)).returning();return console.log("Successfully updated material order:",s.id),s}catch(s){throw console.error("Error updating material order:",s),s}}async deleteMaterialOrder(e){await m.delete(I).where(w(I.id,e))}async getAllInventoryItems(){try{return await m.select().from(L).orderBy(ir(L.name))}catch(e){return console.error("Error in getAllInventoryItems:",e),[]}}async getInventoryItem(e){try{let[t]=await m.select().from(L).where(w(L.id,e));return t}catch(t){console.error("Error in getInventoryItem:",t);return}}async getInventoryItemByBarcode(e){try{let[t]=await m.select().from(L).where(w(L.barcode,e));return t}catch(t){console.error("Error in getInventoryItemByBarcode:",t);return}}async createInventoryItem(e){try{e.sku||(e.sku="INV-"+Date.now().toString(36).toUpperCase());let{initialQuantity:t,...r}=e,[a]=await m.insert(L).values([r]).returning();return t&&await this.createInventoryTransaction({itemId:a.id,type:"initial",quantity:t,unitCost:e.costPerUnit,notes:"Initial inventory setup"}),a}catch(t){throw console.error("Error in createInventoryItem:",t),t}}async updateInventoryItem(e,t){try{let[r]=await m.update(L).set({...t,updatedAt:new Date}).where(w(L.id,e)).returning();return r}catch(r){throw console.error("Error in updateInventoryItem:",r),r}}async deleteInventoryItem(e){try{await m.delete(ye).where(w(ye.itemId,e)),await m.delete(L).where(w(L.id,e))}catch(t){throw console.error("Error in deleteInventoryItem:",t),t}}async getLowStockItems(){try{let e=await m.select().from(L),t=[];for(let r of e){let a=await this.getItemCurrentStock(r.id);a<=Number(r.reorderLevel)&&t.push({...r,currentStock:a})}return t}catch(e){return console.error("Error in getLowStockItems:",e),[]}}async getItemCurrentStock(e){try{let t=await m.select().from(ye).where(w(ye.itemId,e)),r=0;for(let a of t){let s=Number(a.quantity);switch(a.type){case"purchase":case"initial":case"adjustment":r+=s;break;case"sale":case"scrap":r-=s;break}}return r}catch(t){return console.error("Error in getItemCurrentStock:",t),0}}async createInventoryTransaction(e){try{let[t]=await m.insert(ye).values([e]).returning();return e.type==="count"&&await m.update(L).set({lastCountDate:new Date,updatedAt:new Date}).where(w(L.id,e.itemId)),t}catch(t){throw console.error("Error in createInventoryTransaction:",t),t}}async getAllSuppliers(){try{return await m.select().from(K).orderBy(ir(K.name))}catch(e){return console.error("Error in getAllSuppliers:",e),[]}}async getSupplier(e){try{let[t]=await m.select().from(K).where(w(K.id,e));return t}catch(t){console.error("Error in getSupplier:",t);return}}async createSupplier(e){try{let[t]=await m.insert(K).values(e).returning();return t}catch(t){throw console.error("Error in createSupplier:",t),t}}async updateSupplier(e,t){try{let[r]=await m.update(K).set(t).where(w(K.id,e)).returning();return r}catch(r){throw console.error("Error in updateSupplier:",r),r}}async deleteSupplier(e){try{await m.delete(K).where(w(K.id,e))}catch(t){throw console.error("Error in deleteSupplier:",t),t}}async getAllInventoryLocations(){try{return await m.select().from(D).orderBy(ir(D.name))}catch(e){return console.error("Error in getAllInventoryLocations:",e),[]}}async getInventoryLocation(e){try{let[t]=await m.select().from(D).where(w(D.id,e));return t}catch(t){console.error("Error in getInventoryLocation:",t);return}}async createInventoryLocation(e){try{let[t]=await m.insert(D).values(e).returning();return t}catch(t){throw console.error("Error in createInventoryLocation:",t),t}}async getAllPurchaseOrders(){try{return await m.select().from(de).orderBy(Pe(de.createdAt))}catch(e){return console.error("Error in getAllPurchaseOrders:",e),[]}}async getPurchaseOrder(e){try{let[t]=await m.select().from(de).where(w(de.id,e));return t}catch(t){console.error("Error in getPurchaseOrder:",t);return}}async createPurchaseOrderWithLines(e,t){try{let r="PO-"+Date.now().toString(36).toUpperCase(),a=0;for(let i of t){let d=Number(i.quantity)*Number(i.unitCost);a+=d}let s=a*.08,n=a+s+Number(e.shipping||0),[c]=await m.insert(de).values({...e,subtotal:a.toString(),tax:s.toString(),total:n.toString()}).returning();for(let i of t){let d=Number(i.quantity)*Number(i.unitCost);await m.insert(It).values({...i,purchaseOrderId:c.id,lineTotal:d.toString()})}return c}catch(r){throw console.error("Error in createPurchaseOrderWithLines:",r),r}}async getInventoryValuation(){try{let e=await this.getAllInventoryItems(),t=0,r={};for(let s of e){let c=await this.getItemCurrentStock(s.id)*Number(s.costPerUnit);if(t+=c,s.categoryId){let d=(await this.getInventoryCategory(s.categoryId))?.name||"Uncategorized";r[d]||(r[d]=0),r[d]+=c}else r.Uncategorized||(r.Uncategorized=0),r.Uncategorized+=c}let a=Object.entries(r).map(([s,n])=>({category:s,value:n}));return{totalValue:t,itemCount:e.length,valuationByCategory:a}}catch(e){return console.error("Error in getInventoryValuation:",e),{totalValue:0,itemCount:0,valuationByCategory:[]}}}async getInventoryCategory(e){try{let[t]=await m.select().from(Ce).where(w(Ce.id,e));return t}catch(t){console.error("Error in getInventoryCategory:",t);return}}async generateRecommendedPurchaseOrders(){try{let e=await this.getLowStockItems(),t={};for(let r of e)if(r.supplierId){let a=await this.getSupplier(r.supplierId);a&&(t[a.id]||(t[a.id]={supplierId:a.id,supplierName:a.name,items:[]}),t[a.id].items.push({itemId:r.id,name:r.name,sku:r.sku,currentStock:await this.getItemCurrentStock(r.id),reorderLevel:Number(r.reorderLevel),reorderQuantity:Number(r.reorderQuantity||r.reorderLevel)}))}return Object.values(t)}catch(e){return console.error("Error in generateRecommendedPurchaseOrders:",e),[]}}async importInventoryFromCSV(e){try{return{success:!0,importedCount:0,errors:[]}}catch(t){return console.error("Error in importInventoryFromCSV:",t),{success:!1,importedCount:0,errors:["Failed to import CSV data"]}}}async exportInventoryToCSV(){try{return`id,sku,name,description,quantity
`}catch(e){throw console.error("Error in exportInventoryToCSV:",e),e}}async createNotification(e){let[t]=await m.insert(z).values([e]).returning();return t}async getNotification(e){let[t]=await m.select().from(z).where(w(z.id,e));return t||void 0}async getNotifications(e){let t=m.select().from(z).orderBy(Pe(z.createdAt));return e&&(t=t.limit(e)),await t}async getUnreadNotifications(){return await m.select().from(z).where(w(z.read,!1)).orderBy(Pe(z.createdAt))}async markNotificationAsRead(e){let[t]=await m.update(z).set({read:!0}).where(w(z.id,e)).returning();return t}async getNotificationsByUser(e){return await m.select().from(z).where(w(z.userId,e)).orderBy(Pe(z.createdAt))}async getMaterialsPickList(){try{return(await m.select({id:I.id,name:I.materialName,sku:I.materialId,supplier:I.supplierName,type:I.materialType,quantity:I.quantity,status:I.status,priority:I.priority,notes:I.notes,orderDate:I.orderDate,receiveDate:I.actualArrival,sourceOrderId:I.sourceOrderId,costPerUnit:I.costPerUnit,totalCost:I.totalCost}).from(I).where(Ft(w(I.status,"pending"),w(I.status,"processed"),w(I.status,"ordered"),w(I.status,"arrived"))).orderBy(Pe(I.createdAt))).map(r=>({id:r.id.toString(),orderIds:r.sourceOrderId?[r.sourceOrderId]:[],name:r.name,sku:r.sku,supplier:r.supplier||"Unknown",type:r.type,quantity:Number(r.quantity),status:r.status,priority:r.priority||"medium",notes:r.notes||"",orderDate:r.orderDate?.toISOString()||null,receiveDate:r.receiveDate?.toISOString()||null,costPerUnit:r.costPerUnit?Number(r.costPerUnit):0,totalCost:r.totalCost?Number(r.totalCost):0}))}catch(e){throw console.error("Error in getMaterialsPickList:",e),e}}async getMaterialsForOrder(e){try{return await m.select().from(I).where(w(I.sourceOrderId,e))}catch(t){throw console.error("Error in getMaterialsForOrder:",t),t}}async createPurchaseOrder(e){try{let t=e.map(c=>parseInt(c)),r=await m.select().from(I).where(Ft(...t.map(c=>w(I.id,c))));if(r.length===0)throw new Error("No valid materials found for purchase order");let a=r.filter(c=>c.status==="ordered"||c.status==="arrived"||c.status==="completed");if(a.length>0)throw new Error("Materials already ordered: "+a.map(c=>c.materialName).join(", "));await m.update(I).set({status:"ordered",orderDate:new Date}).where(Ft(...t.map(c=>w(I.id,c))));let s=r.reduce((c,i)=>c+(Number(i.totalCost)||0),0);return{id:"po-"+Date.now(),orderNumber:"PO-"+new Date().getFullYear()+"-"+String(Math.floor(Math.random()*1e3)).padStart(3,"0"),materialIds:e,totalAmount:s,status:"sent",createdAt:new Date().toISOString(),expectedDeliveryDate:new Date(Date.now()+14*24*60*60*1e3).toISOString(),materials:r}}catch(t){throw console.error("Error in createPurchaseOrder:",t),t}}async checkDuplicateMaterialOrder(e,t){try{return(await m.select().from(I).where(Hn(w(I.materialId,e),w(I.sourceOrderId,t),Ft(w(I.status,"pending"),w(I.status,"ordered"),w(I.status,"arrived"))))).length>0}catch(r){return console.error("Error checking duplicate material order:",r),!1}}async createMaterialOrdersFromOrder(e){try{let t=[];if(e.frameId){let a=await this.getFrame(e.frameId);if(a&&!await this.checkDuplicateMaterialOrder(e.frameId,e.id)){let n=2*(Number(e.artworkWidth)+Number(e.artworkHeight)),c=Math.ceil(n*1.1);t.push({materialType:"frame",materialId:e.frameId,materialName:`${a.name} (Item: ${e.frameId})`,quantity:c.toString(),status:"pending",sourceOrderId:e.id,supplierName:a.manufacturer,costPerUnit:a.price,totalCost:(Number(a.price)*c).toString(),priority:"medium",unitMeasurement:"united_inch",notes:`Frame for order #${e.id} - Order Item: ${e.frameId} from ${a.manufacturer}`})}}if(e.matColorId){let a=await this.getMatColor(e.matColorId);if(a&&!await this.checkDuplicateMaterialOrder(e.matColorId,e.id)){let n=Number(e.artworkWidth)+Number(e.matWidth)*2+4,c=Number(e.artworkHeight)+Number(e.matWidth)*2+4,i=n*c;t.push({materialType:"matboard",materialId:e.matColorId,materialName:a.name,quantity:"1",status:"pending",sourceOrderId:e.id,supplierName:a.manufacturer||"Crescent",costPerUnit:(Number(a.price)*i).toString(),totalCost:(Number(a.price)*i).toString(),priority:"medium",unitMeasurement:"sheet",notes:"Mat board for order #"+e.id+" - "+n+'"x'+c+'"'})}}if(e.glassOptionId){let a=await this.getGlassOption(e.glassOptionId);if(a&&!await this.checkDuplicateMaterialOrder(e.glassOptionId,e.id)){let n=Number(e.artworkWidth)+Number(e.matWidth)*2,c=Number(e.artworkHeight)+Number(e.matWidth)*2,i=n*c;t.push({materialType:"glass",materialId:e.glassOptionId,materialName:a.name,quantity:"1",status:"pending",sourceOrderId:e.id,supplierName:"Tru Vue",costPerUnit:(Number(a.price)*i).toString(),totalCost:(Number(a.price)*i).toString(),priority:"medium",unitMeasurement:"square_inch",notes:"Glass for order #"+e.id+" - "+n+'"x'+c+'"'})}}console.log("Attempting to save "+t.length+" material orders");let r=[];for(let a of t)try{console.log("Inserting material order:",a);let[s]=await m.insert(t).values(a).returning();r.push(s),console.log("Successfully inserted material order:",s.id)}catch(s){console.error("Error inserting material order:",s,a)}return console.log("Successfully created "+r.length+" material orders for order "+e.id),r}catch(t){throw console.error("Error creating material orders from order:",t),t}}async withTransaction(e){let r;for(let a=0;a<3;a++)try{return await m.transaction(async s=>await e(s))}catch(s){if(r=s,console.error(`Transaction attempt ${a+1} failed:`,s),s.code==="23505"||s.code==="23503")throw s;if(a<2){let n=Math.pow(2,a)*1e3;await new Promise(c=>setTimeout(c,n))}}throw r}},y=new Ot});import ot from"fs";import Kn from"csv-parser";import zn from"path";var Ae,Vl,So=_(()=>{"use strict";Ae=class{constructor(e){k(this,"baseUrl","https://api.studiomoulding.com");k(this,"apiKey",null);k(this,"catalogPath","./data/studio-moulding-catalog.csv");k(this,"catalogData",[]);this.apiKey=e||process.env.STUDIO_MOULDING_API_KEY||null,this.loadCatalogFromFile()}async loadCatalogFromFile(){try{if(!ot.existsSync(this.catalogPath)){console.log("Studio Moulding catalog file not found, using sample data"),this.catalogData=await this.getSampleCatalog();return}let e=[];return new Promise((t,r)=>{ot.createReadStream(this.catalogPath).pipe(Kn()).on("data",a=>{try{let s={itemNumber:a.Item_Number||a.itemNumber,description:a.Description||a.description,lengthPrice:parseFloat(a.Length_Price||a.lengthPrice||"0"),straightCutPrice:parseFloat(a.Straight_Cut_Price||a.straightCutPrice||"0"),chopPrice:parseFloat(a.Chop_Price||a.chopPrice||"0"),joinPrice:parseFloat(a.Join_Price||a.joinPrice||"0"),boxPrice:parseFloat(a.Box_Price||a.boxPrice||"0"),boxQty:parseInt(a.Box_Qty||a.boxQty||"0"),width:a.Width||a.width||"1.0",height:a.Height||a.height||"1.0",rabbet:a.Rabbet_H||a.rabbet||"0.5",catPage:a.Cat_Page||a.catPage||"A-01",collection:this.extractCollection(a.Description||""),material:this.determineMaterial(a.Description||""),finish:this.extractFinish(a.Description||""),color:this.extractColor(a.Description||"")};e.push(s)}catch(s){console.warn("Error parsing row:",s)}}).on("end",()=>{this.catalogData=e,console.log(`Loaded ${e.length} Studio Moulding frames from file`),t()}).on("error",r)})}catch(e){console.error("Error loading Studio Moulding catalog:",e),this.catalogData=await this.getSampleCatalog()}}extractCollection(e){let t=["B&B","MADERA","ETUDE","ADAGIO","FORTE","LEGATO","HONORS","KOTA","CHALET","ASH","SIERRA","HARMONY","BEECH","OLEA","PLUME","D'ORME","LYRA","AVANT","DUNE","WILLOW","ETHOS","ELAN","NUANCE","GROVE","MILAN"],r=e.toUpperCase();for(let a of t)if(r.includes(a))return a;return"Studio Moulding"}determineMaterial(e){let t=e.toUpperCase();return t.includes("VENEER")||t.includes("MAPLE")||t.includes("ASH")||t.includes("BEECH")?"wood":t.includes("METAL")||t.includes("ALUMINUM")?"metal":"wood"}extractFinish(e){let t=e.toUpperCase();return t.includes("GLOSS")?"gloss":t.includes("MATT")||t.includes("MATTE")?"matte":t.includes("STAIN")?"stained":t.includes("WHITEWASH")?"whitewash":t.includes("FLOATER")?"float":"natural"}extractColor(e){let t={"SABLE BROWN":"#8B4513",COFFEE:"#6F4E37",PECAN:"#C8860D",HONEY:"#FFB347",WALNUT:"#8B4513",CHERRY:"#722F37",NATURAL:"#DEB887",CLEAR:"#F5F5DC",BLACK:"#000000",GRAY:"#808080",GREY:"#808080",MAHOGANY:"#C04000",WHITE:"#FFFFFF",WHITEWASH:"#F8F8FF",GOLD:"#FFD700","DARK BROWN":"#654321","LIGHT WALNUT":"#D2B48C",BUFF:"#F0DC82",BEIGE:"#F5F5DC",SAND:"#C2B280",KHAKI:"#F0E68C",BARK:"#8B4513",TAUPE:"#483C32",IVORY:"#FFFFF0",EBONY:"#555D50",CHARCOAL:"#36454F",WENGE:"#645452"},r=e.toUpperCase();for(let[a,s]of Object.entries(t))if(r.includes(a))return s;return"#DEB887"}getPricingOptions(e){let t=[];return e.lengthPrice>0&&t.push({method:"length",pricePerFoot:e.lengthPrice,description:"Full length pricing (standard 8-foot sticks)"}),e.straightCutPrice>0&&t.push({method:"straight_cut",pricePerFoot:e.straightCutPrice,description:"Straight cut to length"}),e.chopPrice>0&&t.push({method:"chop",pricePerFoot:e.chopPrice,description:"Chopped to exact length"}),e.joinPrice>0&&t.push({method:"join",pricePerFoot:e.joinPrice,description:"Joined corners (complete frame)"}),e.boxPrice>0&&e.boxQty>0&&t.push({method:"box",pricePerFoot:e.boxPrice,description:`Box pricing (${e.boxQty} feet per box)`,boxQuantity:e.boxQty}),t}calculateOptimalPricing(e,t){let r=this.catalogData.find(g=>g.itemNumber===e);if(!r)return{frame:null,options:[],recommendation:{method:"",totalCost:0,savings:0,reason:"Frame not found"}};let s=this.getPricingOptions(r).map(g=>{let u=0,l=g.description;switch(g.method){case"length":let f=Math.ceil(t/8);u=f*8*g.pricePerFoot;let b=f*8-t;l+=` (${f} sticks, ${b.toFixed(1)}' waste)`;break;case"box":if(g.boxQuantity){let F=Math.ceil(t/g.boxQuantity);u=F*g.boxQuantity*g.pricePerFoot,l+=` (${F} boxes)`}break;default:u=t*g.pricePerFoot;break}return{method:g.method,totalCost:u,pricePerFoot:g.pricePerFoot,description:l}}),n=s.reduce((g,u)=>u.totalCost<g.totalCost?u:g),i=s.reduce((g,u)=>u.totalCost>g.totalCost?u:g).totalCost-n.totalCost,d=s.map(g=>({...g,savings:g.totalCost-n.totalCost})),h="";switch(n.method){case"length":h="Full sticks provide best value despite potential waste";break;case"chop":h="Chopped pricing eliminates waste for exact footage";break;case"straight_cut":h="Straight cut offers good balance of cost and convenience";break;case"join":h="Joined corners save labor costs for complete frames";break;case"box":h="Box pricing offers volume discount";break}return{frame:r,options:d,recommendation:{method:n.method,totalCost:n.totalCost,savings:i,reason:h}}}async fetchCatalog(){try{return console.log("Fetching Studio Moulding catalog..."),this.catalogData.length===0&&await this.loadCatalogFromFile(),console.log(`Found ${this.catalogData.length} Studio Moulding frames`),this.catalogData.map(e=>this.convertToVendorFrame(e))}catch(e){return console.error("Error fetching Studio Moulding catalog:",e),(await this.getSampleCatalog()).map(r=>this.convertToVendorFrame(r))}}async searchFrames(e){try{let t=await this.fetchCatalog();if(!e)return t;let r=e.toLowerCase();return t.filter(a=>a.name.toLowerCase().includes(r)||a.material.toLowerCase().includes(r)||a.color.toLowerCase().includes(r)||a.collection.toLowerCase().includes(r)||a.itemNumber.toLowerCase().includes(r))}catch(t){return console.error("Error searching Studio Moulding frames:",t),[]}}async getFrameByItemNumber(e){try{let t=this.catalogData.find(r=>r.itemNumber===e);return t?{frame:this.convertToVendorFrame(t),pricingOptions:this.getPricingOptions(t)}:{frame:null,pricingOptions:[]}}catch(t){return console.error("Error getting Studio Moulding frame:",t),{frame:null,pricingOptions:[]}}}convertToVendorFrame(e){return{id:`studio-${e.itemNumber}`,itemNumber:e.itemNumber,name:e.description,manufacturer:"Studio Moulding",material:e.material||"wood",width:e.width,depth:e.height,color:e.color||"#DEB887",price:e.lengthPrice.toString(),collection:e.collection||"Studio Moulding",description:e.description,imageUrl:this.generateImageUrl(e.itemNumber),finish:e.finish||"natural",wholesalePrice:e.lengthPrice*.8,availability:"in-stock"}}generateImageUrl(e){return`https://www.studiomoulding.com/images/products/${e}_detail.jpg`}async getSampleCatalog(){return[{itemNumber:"1420",description:"B&B SABLE BROWN",lengthPrice:9.22,straightCutPrice:11.74,chopPrice:14.25,joinPrice:17.06,boxPrice:5.07,boxQty:95,width:"3",height:"1 7/16",rabbet:"1/2",catPage:"A-55",collection:"B&B",material:"wood",finish:"stained",color:"#8B4513"},{itemNumber:"3020",description:"MADERA COFFEE BROWN",lengthPrice:2.3,straightCutPrice:3.47,chopPrice:4.64,joinPrice:6.29,boxPrice:1.27,boxQty:475,width:"3/4",height:"3/4",rabbet:"1/2",catPage:"A-43",collection:"MADERA",material:"wood",finish:"stained",color:"#6F4E37"}]}async saveCatalogToFile(e){try{let r=[["Item_Number","Description","Length_Price","Straight_Cut_Price","Chop_Price","Join_Price","Box_Price","Box_Qty","Width","Height","Rabbet_H","Cat_Page"].join(","),...e.map(s=>[s.itemNumber,`"${s.description}"`,s.lengthPrice,s.straightCutPrice,s.chopPrice,s.joinPrice,s.boxPrice,s.boxQty,`"${s.width}"`,`"${s.height}"`,`"${s.rabbet}"`,s.catPage].join(","))].join(`
`),a=zn.dirname(this.catalogPath);ot.existsSync(a)||ot.mkdirSync(a,{recursive:!0}),ot.writeFileSync(this.catalogPath,r),console.log(`Saved ${e.length} Studio Moulding frames to ${this.catalogPath}`)}catch(t){console.error("Error saving catalog:",t)}}updateConfig(e){this.apiKey=e}async testConnection(){try{return(await this.fetchCatalog()).length>0}catch(e){return console.error("Studio Moulding connection test failed:",e),!1}}},Vl=new Ae});var Io={};U(Io,{VendorScraperService:()=>At,vendorScraperService:()=>Vn});import vo from"axios";import*as mr from"cheerio";var At,Vn,xo=_(()=>{"use strict";At=class{constructor(){k(this,"timeout",3e4)}async scrapeLarsonFrames(e){try{console.log("Scraping Larson-Juhl website for frames...");let t=e?`https://www.larsonjuhl.com/search?q=${encodeURIComponent(e)}`:"https://www.larsonjuhl.com/mouldings",r=await vo.get(t,{timeout:this.timeout,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Language":"en-US,en;q=0.5","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive","Upgrade-Insecure-Requests":"1"}}),a=mr.load(r.data),s=[];return a(".product-item, .moulding-item, .frame-item, .product-card").each((n,c)=>{let i=a(c),d=i.find(".product-title, .item-title, h3, h4").first().text().trim(),h=this.extractItemNumber(i.text())||this.extractItemNumber(d),g=i.find(".price, .cost, .wholesale").first().text(),u=this.extractPrice(g),l=i.find("img").first().attr("src");d&&h&&s.push({id:`larson-${h}`,itemNumber:h,name:`Larson ${d}`,price:u||"0.00",material:this.determineMaterial(d),color:this.extractColor(d),width:"2.25",height:"0.75",depth:"1.25",collection:this.extractCollection(d),description:d,imageUrl:l?this.resolveImageUrl(l,"https://www.larsonjuhl.com"):"",inStock:!0,vendor:"Larson Juhl"})}),console.log(`Scraped ${s.length} Larson frames`),s}catch(t){return console.error("Error scraping Larson frames:",t),this.getFallbackLarsonFrames(e)}}async scrapeRomaFrames(e){try{console.log("Scraping Roma Moulding website for frames...");let t=e?`https://www.romamoulding.com/search?q=${encodeURIComponent(e)}`:"https://www.romamoulding.com/products",r=await vo.get(t,{timeout:this.timeout,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}}),a=mr.load(r.data),s=[];return a(".product-item, .moulding-card, .product-card").each((n,c)=>{let i=a(c),d=i.find(".product-name, .item-name, h3, h4").first().text().trim(),h=this.extractItemNumber(i.text())||this.generateItemNumber(),g=i.find(".price, .cost").first().text(),u=this.extractPrice(g),l=i.find("img").first().attr("src");d&&s.push({id:`roma-${h}`,itemNumber:h,name:`Roma ${d}`,price:u||"0.00",material:this.determineMaterial(d),color:this.extractColor(d),width:"2.00",height:"0.75",depth:"1.00",collection:"Roma Collection",description:d,imageUrl:l?this.resolveImageUrl(l,"https://www.romamoulding.com"):"",inStock:!0,vendor:"Roma Moulding"})}),console.log(`Scraped ${s.length} Roma frames`),s}catch(t){return console.error("Error scraping Roma frames:",t),this.getFallbackRomaFrames(e)}}async searchByItemNumber(e){console.log(`Scraping for item number: ${e}`);let[t,r]=await Promise.all([this.scrapeLarsonFrames(e),this.scrapeRomaFrames(e)]);return[...t,...r].filter(s=>s.itemNumber===e||s.itemNumber.includes(e)||s.id.includes(e))}extractItemNumber(e){let t=e.match(/\b\d{5,6}\b/);return t?t[0]:null}extractPrice(e){let t=e.match(/\$?(\d+\.?\d*)/);return t?t[1]:null}determineMaterial(e){let t=e.toLowerCase();return t.includes("wood")||t.includes("oak")||t.includes("maple")?"Wood":t.includes("metal")||t.includes("aluminum")?"Metal":"Wood"}extractColor(e){let t=e.toLowerCase();return t.includes("white")?"White":t.includes("black")?"Black":t.includes("gold")?"Gold":t.includes("silver")?"Silver":"Natural"}extractCollection(e){let t=e.split(" ");return t.length>1?t[0]:"Standard"}resolveImageUrl(e,t){return e.startsWith("http")?e:e.startsWith("//")?`https:${e}`:e.startsWith("/")?`${t}${e}`:`${t}/${e}`}generateItemNumber(){return Math.floor(1e5+Math.random()*9e5).toString()}getFallbackLarsonFrames(e){let t=[{id:"larson-210285",itemNumber:"210285",name:"Larson White Wood Frame",price:"16.75",material:"Wood",color:"White",width:"2.25",height:"0.75",depth:"1.25",collection:"Academie",description:"Professional quality white wood frame",imageUrl:"https://www.larsonjuhl.com/images/products/210285.jpg",inStock:!0,vendor:"Larson Juhl"},{id:"larson-210286",itemNumber:"210286",name:"Larson Black Wood Frame",price:"16.75",material:"Wood",color:"Black",width:"2.25",height:"0.75",depth:"1.25",collection:"Academie",description:"Professional quality black wood frame",imageUrl:"https://www.larsonjuhl.com/images/products/210286.jpg",inStock:!0,vendor:"Larson Juhl"}];if(e){let r=e.toLowerCase();return t.filter(a=>a.itemNumber.includes(r)||a.name.toLowerCase().includes(r)||a.color.toLowerCase().includes(r))}return t}getFallbackRomaFrames(e){let t=[{id:"roma-1234",itemNumber:"1234",name:"Roma Classic Wood Frame",price:"14.50",material:"Wood",color:"Natural",width:"2.00",height:"0.75",depth:"1.00",collection:"Roma Classic",description:"Traditional wood frame with classic profile",imageUrl:"",inStock:!0,vendor:"Roma Moulding"}];if(e){let r=e.toLowerCase();return t.filter(a=>a.itemNumber.includes(r)||a.name.toLowerCase().includes(r))}return t}},Vn=new At});var _t={};U(_t,{vendorApiService:()=>Co});import at from"axios";var pr,Co,st=_(()=>{"use strict";J();So();pr=class{constructor(){k(this,"larsonConfig");k(this,"romaConfig");k(this,"bellaConfig");k(this,"studioMouldingConfig",{apiKey:process.env.STUDIO_MOULDING_API_KEY||""});k(this,"studioMouldingService");this.initializeServices()}initializeServices(){this.studioMouldingConfig.apiKey&&(this.studioMouldingService=new Ae(this.studioMouldingConfig.apiKey)),console.log("VendorApiService initialized")}async fetchLarsonCatalog(){try{console.log("Loading Larson-Juhl catalog from uploaded data...");let e=$e("fs"),t=$e("path"),r=[t.join(process.cwd(),"larson_frames_parsed.json"),t.join(process.cwd(),"attached_assets","larson_catalog_from_excel.json"),t.join(process.cwd(),"vendor_frames_from_pdfs.json")];for(let a of r)if(e.existsSync(a)){console.log(`Loading Larson catalog from: ${a}`);let s=JSON.parse(e.readFileSync(a,"utf8"));if(Array.isArray(s)&&s.length>0)return s.filter(n=>n.manufacturer==="Larson-Juhl"||n.supplier==="Larson-Juhl"||n.id?.includes("larson")).map(this.transformToVendorFrame)}return console.log("No uploaded Larson catalog found, using enhanced sample data"),this.getLarsonSampleFrames()}catch(e){return console.error("Error loading Larson catalog from files:",e),this.getLarsonSampleFrames()}}async fetchRomaCatalog(){try{console.log("Loading Roma Moulding catalog from uploaded data...");let e=$e("fs"),t=$e("path"),r=[t.join(process.cwd(),"vendor_frames_from_pdfs.json"),t.join(process.cwd(),"roma_catalog_parsed.json")];for(let a of r)if(e.existsSync(a)){console.log(`Loading Roma catalog from: ${a}`);let s=JSON.parse(e.readFileSync(a,"utf8"));if(Array.isArray(s)&&s.length>0)return s.filter(n=>n.manufacturer==="Roma Moulding"||n.supplier==="Roma Moulding"||n.id?.includes("roma")).map(this.transformToVendorFrame)}return console.log("No uploaded Roma catalog found, using sample data"),this.getRomaSampleFrames()}catch(e){return console.error("Error loading Roma catalog from files:",e),this.getRomaSampleFrames()}}async fetchBellaCatalog(){try{console.log("Loading Bella/Nielsen catalog from uploaded data...");let e=$e("fs"),t=$e("path"),r=[t.join(process.cwd(),"vendor_frames_from_pdfs.json"),t.join(process.cwd(),"nielsen_catalog_parsed.json"),t.join(process.cwd(),"bella_catalog_parsed.json")];for(let a of r)if(e.existsSync(a)){console.log(`Loading Bella/Nielsen catalog from: ${a}`);let s=JSON.parse(e.readFileSync(a,"utf8"));if(Array.isArray(s)&&s.length>0)return s.filter(n=>n.manufacturer==="Nielsen Bainbridge"||n.manufacturer==="Bella Moulding"||n.supplier==="Nielsen Bainbridge"||n.id?.includes("nielsen")||n.id?.includes("bella")).map(this.transformToVendorFrame)}return console.log("No uploaded Bella/Nielsen catalog found, using sample data"),this.getBellaSampleFrames()}catch(e){return console.error("Error loading Bella catalog from files:",e),this.getBellaSampleFrames()}}async getLarsonFramesFromDatabase(){try{return(await y.query(`
        SELECT * FROM frames 
        WHERE manufacturer = 'Larson-Juhl' 
        ORDER BY name
      `)).rows.map(t=>({id:t.id,itemNumber:t.id.replace("larson-",""),name:t.name,price:t.price,material:t.material||"Wood",color:t.color||"Natural",width:t.width||"1.5",height:t.width||"1.5",depth:t.depth||"0.75",collection:t.collection||"Standard",description:t.description||t.name,imageUrl:t.catalog_image||"",inStock:!0,vendor:"Larson Juhl"}))}catch(e){return console.error("Error fetching Larson frames from database:",e),[]}}async fetchRomaCatalogOld(){if(!this.romaConfig.apiKey)throw new Error("Roma API key not configured. Please configure API credentials in vendor settings.");try{return(await at.get(`${this.romaConfig.baseUrl}/catalog/mouldings`,{headers:{"X-Api-Key":this.romaConfig.apiKey,"Content-Type":"application/json"}})).data.mouldings.map(t=>({id:`roma-${t.sku}`,itemNumber:t.sku,name:`${t.name} (${t.collection})`,price:t.wholesale_price.toString(),material:t.material,color:t.finish,width:t.dimensions.width.toString(),height:t.dimensions.height.toString(),depth:t.dimensions.depth.toString(),collection:t.collection,description:t.description,imageUrl:t.image,inStock:t.availability==="in_stock",vendor:"Roma Moulding"}))}catch(e){throw console.error("Error fetching Roma catalog:",e),new Error(`Failed to fetch Roma catalog: ${e.message}`)}}async fetchBellaCatalogOld(){if(!this.bellaConfig.apiKey)throw new Error("Bella API key not configured. Please configure API credentials in vendor settings.");try{return(await at.get(`${this.bellaConfig.baseUrl}/products`,{headers:{"X-API-Key":this.bellaConfig.apiKey,"X-API-Secret":this.bellaConfig.apiSecret||"","Content-Type":"application/json"}})).data.products.map(t=>({id:`bella-${t.sku}`,itemNumber:t.sku,name:`${t.name} (${t.collection})`,price:t.wholesale_price.toString(),material:t.material,color:t.finish,width:t.dimensions.width.toString(),height:t.dimensions.height.toString(),depth:t.dimensions.depth.toString(),collection:t.collection,description:t.description,imageUrl:t.image,inStock:t.availability==="in_stock",vendor:"Bella Moulding"}))}catch(e){throw console.error("Error fetching Bella catalog:",e),new Error(`Failed to fetch Bella catalog: ${e.message}`)}}async fetchAllCatalogs(){let e=[];try{let[t,r,a,s]=await Promise.allSettled([this.fetchLarsonCatalog(),this.fetchRomaCatalog(),this.fetchBellaCatalog(),this.fetchStudioMouldingCatalog()]);t.status==="fulfilled"&&(e.push(...t.value),console.log(`Added ${t.value.length} Larson Juhl frames`)),r.status==="fulfilled"&&(e.push(...r.value),console.log(`Added ${r.value.length} Roma Moulding frames`)),a.status==="fulfilled"&&(e.push(...a.value),console.log(`Added ${a.value.length} Bella Moulding frames`)),s.status==="fulfilled"&&(e.push(...s.value),console.log(`Added ${s.value.length} Studio Moulding frames`))}catch(t){console.error("Failed to fetch all catalogs:",t)}return e}async searchFrames(e,t){console.log(`Searching for: "${e}" across vendor APIs`);let r=[];try{if(t)switch(t.toLowerCase()){case"larson":r=await this.fetchLarsonCatalog();break;case"roma":r=await this.fetchRomaCatalog();break;case"bella":r=await this.fetchBellaCatalog();break;default:r=await this.fetchAllCatalogs()}else r=await this.fetchAllCatalogs()}catch(n){console.log("API calls failed, trying fallback scraper:",n.message);let{vendorScraperService:c}=await Promise.resolve().then(()=>(xo(),Io));try{if(/^[0-9]{5,6}$/.test(e))console.log(`Using scraper for item number search: ${e}`),r=await c.searchByItemNumber(e);else{console.log(`Using scraper for general search: ${e}`);let[i,d]=await Promise.all([c.scrapeLarsonFrames(e),c.scrapeRomaFrames(e)]);r=[...i,...d]}r.length>0&&console.log(`Scraper found ${r.length} frames`)}catch(i){console.log("Scraper also failed, checking database:",i.message);try{let{storage:d}=await Promise.resolve().then(()=>(J(),wo)),h=await d.searchFramesByItemNumber(e);if(h&&h.length>0)return h.map(g=>({id:g.id,itemNumber:g.id.split("-")[1]||e,name:g.name,price:g.price,material:g.material||"Wood",color:g.color||"Natural",width:g.width||"2.25",height:g.depth||"0.75",depth:"1.25",collection:"Standard",imageUrl:g.catalogImage||"",inStock:!0,vendor:g.manufacturer||"Larson Juhl"}))}catch(d){console.log("Database search also failed:",d.message)}}}try{if(t)switch(t.toLowerCase()){case"larson":r=await this.fetchLarsonCatalog();break;case"roma":r=await this.fetchRomaCatalog();break;case"bella":r=await this.fetchBellaCatalog();break;default:r=await this.fetchAllCatalogs()}else r=await this.fetchAllCatalogs()}catch(n){console.log("API search failed, checking database:",n.message);try{let c=await y.searchFramesByItemNumber(e);if(c&&c.length>0)return c.map(i=>({id:i.id,itemNumber:i.id.split("-")[1]||e,name:i.name,price:i.price,material:i.material||"Wood",color:i.color||"Natural",width:"2.25",height:"0.75",depth:"1.25",collection:"Standard",imageUrl:i.thumbnailUrl||"",inStock:!0,vendor:"Larson Juhl"}))}catch(c){console.log("Database search also failed:",c.message)}return[]}if(!e)return r;let a=e.toLowerCase(),s=r.filter(n=>n.name.toLowerCase().includes(a)||n.material.toLowerCase().includes(a)||n.color.toLowerCase().includes(a)||n.collection.toLowerCase().includes(a)||n.itemNumber.toLowerCase().includes(a));return console.log(`Found ${s.length} matches for "${e}"`),s}async syncCatalogsToDatabase(){try{let e=await this.fetchAllCatalogs(),t=await y.getAllFrames(),r=new Set(t.map(n=>n.id)),a=e.filter(n=>!r.has(n.id)),s=e.filter(n=>r.has(n.id));for(let n of a)await y.addFrame({id:n.id,name:n.name,price:n.price,material:n.material,color:n.color,thumbnailUrl:n.imageUrl||"",description:n.description||""});for(let n of s)await y.updateFrame({id:n.id,name:n.name,price:n.price,material:n.material,color:n.color,thumbnailUrl:n.imageUrl||"",description:n.description||""});return{added:a.length,updated:s.length}}catch(e){throw console.error("Error syncing catalogs to database:",e),e}}async getSettings(){return{larsonApiKey:this.larsonConfig.apiKey||"",larsonApiSecret:!!this.larsonConfig.apiSecret,romaApiKey:this.romaConfig.apiKey||"",romaApiSecret:!!this.romaConfig.apiSecret,bellaApiKey:this.bellaConfig.apiKey||"",bellaApiSecret:!!this.bellaConfig.apiSecret}}async updateSettings(e){e.larsonApiKey!==void 0&&(this.larsonConfig.apiKey=e.larsonApiKey,process.env.LARSON_API_KEY=e.larsonApiKey),e.larsonApiSecret!==void 0&&(this.larsonConfig.apiSecret=e.larsonApiSecret,process.env.LARSON_API_SECRET=e.larsonApiSecret),e.romaApiKey!==void 0&&(this.romaConfig.apiKey=e.romaApiKey,process.env.ROMA_API_KEY=e.romaApiKey),e.romaApiSecret!==void 0&&(this.romaConfig.apiSecret=e.romaApiSecret,process.env.ROMA_API_SECRET=e.romaApiSecret),e.bellaApiKey!==void 0&&(this.bellaConfig.apiKey=e.bellaApiKey,process.env.BELLA_API_KEY=e.bellaApiKey),e.bellaApiSecret!==void 0&&(this.bellaConfig.apiSecret=e.bellaApiSecret,process.env.BELLA_API_SECRET=e.bellaApiSecret),console.log("API settings updated",{larsonKeyUpdated:!!e.larsonApiKey,larsonSecretUpdated:!!e.larsonApiSecret,romaKeyUpdated:!!e.romaApiKey,romaSecretUpdated:!!e.romaApiSecret,bellaKeyUpdated:!!e.bellaApiKey,bellaSecretUpdated:!!e.bellaApiSecret})}async testLarsonConnection(){try{if(!this.larsonConfig.apiKey)return{success:!1,message:"API key not configured. Please enter a valid API key."};let e=await at.get(`${this.larsonConfig.baseUrl}/catalog/frames?limit=1`,{headers:{Authorization:`Bearer ${this.larsonConfig.apiKey}`,"Content-Type":"application/json"}});return e.status===200?{success:!0,message:"Successfully connected to Larson-Juhl API"}:{success:!1,message:`Unexpected response status: ${e.status}`}}catch(e){return console.error("Error testing Larson Juhl connection:",e),{success:!1,message:e.response?.data?.message||e.message||"Connection failed"}}}async testRomaConnection(){try{if(!this.romaConfig.apiKey)return{success:!1,message:"API key not configured. Please enter a valid API key."};let e=await at.get(`${this.romaConfig.baseUrl}/catalog/mouldings?limit=1`,{headers:{"X-Api-Key":this.romaConfig.apiKey,"Content-Type":"application/json"}});return e.status===200?{success:!0,message:"Successfully connected to Roma Moulding API"}:{success:!1,message:`Unexpected response status: ${e.status}`}}catch(e){return console.error("Error testing Roma Moulding connection:",e),{success:!1,message:e.response?.data?.message||e.message||"Connection failed"}}}async testBellaConnection(){try{if(!this.bellaConfig.apiKey)return{success:!1,message:"API key not configured. Please enter a valid API key."};let e=await at.get(`${this.bellaConfig.baseUrl}/products?limit=1`,{headers:{"X-API-Key":this.bellaConfig.apiKey,"X-API-Secret":this.bellaConfig.apiSecret||"","Content-Type":"application/json"}});return e.status===200?{success:!0,message:"Successfully connected to Bella Moulding API"}:{success:!1,message:`Unexpected response status: ${e.status}`}}catch(e){return console.error("Error testing Bella Moulding connection:",e),{success:!1,message:e.response?.data?.message||e.message||"Connection failed"}}}getRomaSampleFrames(){return[{id:"roma-RM2001",itemNumber:"RM2001",name:"Roma Classic Gold Profile",price:"22.50",material:"Wood",color:"Gold",width:"2.5",height:"1.5",depth:"2.0",collection:"Classic",description:"Traditional gold leaf frame with ornate detailing",imageUrl:"https://images.unsplash.com/photo-1583847268964-b28dc8f51f92?w=800&auto=format&fit=crop&q=60",inStock:!0,vendor:"Roma Moulding"},{id:"roma-RM3001",itemNumber:"RM3001",name:"Roma Modern Silver",price:"18.75",material:"Metal",color:"Silver",width:"1.5",height:"0.75",depth:"1.0",collection:"Modern",description:"Contemporary silver metal frame with clean lines",imageUrl:"https://images.unsplash.com/photo-1583847268964-b28dc8f51f92?w=800&auto=format&fit=crop&q=60",inStock:!0,vendor:"Roma Moulding"}]}getBellaSampleFrames(){return[{id:"bella-BL1001",itemNumber:"BL1001",name:"Bella Premium Walnut",price:"24.99",material:"Wood",color:"Walnut",width:"2.25",height:"1.25",depth:"1.5",collection:"Premium",description:"Rich walnut wood frame with natural grain finish",imageUrl:"https://images.unsplash.com/photo-1583847268964-b28dc8f51f92?w=800&auto=format&fit=crop&q=60",inStock:!0,vendor:"Bella Moulding"},{id:"bella-BL2001",itemNumber:"BL2001",name:"Bella Contemporary Black",price:"19.50",material:"Composite",color:"Black",width:"1.75",height:"0.875",depth:"1.25",collection:"Contemporary",description:"Modern black composite frame with matte finish",imageUrl:"https://images.unsplash.com/photo-1583847268964-b28dc8f51f92?w=800&auto=format&fit=crop&q=60",inStock:!0,vendor:"Bella Moulding"},{id:"bella-BL3001",itemNumber:"BL3001",name:"Bella Ornate Gold",price:"31.25",material:"Wood",color:"Gold",width:"3.0",height:"2.0",depth:"2.25",collection:"Ornate",description:"Elaborate gold-leafed frame with carved details",imageUrl:"https://images.unsplash.com/photo-1583847268964-b28dc8f51f92?w=800&auto=format&fit=crop&q=60",inStock:!0,vendor:"Bella Moulding"}]}async fetchBellaMouldingCatalog(){try{return console.log("Fetching Bella Moulding catalog..."),[]}catch(e){return console.error("Error fetching Bella Moulding catalog:",e),[]}}async fetchStudioMouldingCatalog(){try{return this.studioMouldingService||(this.studioMouldingService=new Ae),await this.studioMouldingService.fetchCatalog()}catch(e){return console.error("Error fetching Studio Moulding catalog:",e),[]}}async searchLarsonJuhlFrames(e){try{return[]}catch(t){return console.error("Error searching Larson Juhl:",t),[]}}async searchRomaMouldingFrames(e){try{return[]}catch(t){return console.error("Error searching Roma Moulding:",t),[]}}async searchBellaMouldingFrames(e){try{return[]}catch(t){return console.error("Error searching Bella Moulding:",t),[]}}async searchStudioMouldingFrames(e){try{return this.studioMouldingService||(this.studioMouldingService=new Ae),await this.studioMouldingService.searchFrames(e)}catch(t){return console.error("Error searching Studio Moulding:",t),[]}}transformToVendorFrame(e){return{id:e.id||`${e.manufacturer?.toLowerCase()}-${e.itemNumber||e.sku||"unknown"}`,itemNumber:e.itemNumber||e.sku||e.code||"",name:e.name||e.description||"Unknown Frame",price:(e.price||e.retailPrice||e.wholesalePrice||"0").toString(),material:e.material||"Wood",color:e.color||"Natural",width:(e.width||"2.0").toString(),height:(e.height||e.depth||"1.5").toString(),depth:(e.depth||e.height||"1.5").toString(),collection:e.collection||e.category||"Standard",description:e.description||e.name||"",imageUrl:e.catalogImage||e.imageUrl||"",inStock:e.inStock!==!1,vendor:e.manufacturer||e.supplier||"Unknown"}}async testConnection(e){switch(e.toLowerCase()){case"larson":return this.testLarsonConnection();case"roma":return this.testRomaConnection();case"bella":return this.testBellaConnection();default:return{success:!1,message:"Invalid vendor specified."}}}},Co=new pr});import{randomBytes as oi}from"crypto";import{eq as ad,and as sd}from"drizzle-orm";function ai(){return`JF${oi(4).toString("hex")}`}async function br(o){try{let e=ai(),[t]=await m.insert(Be).values([{code:e,type:"customer_order",entityId:o.toString(),title:`Order #${o}`,description:`QR code for order #${o}`,active:!0}]).returning();return e}catch(e){throw console.error("Error generating QR code for order:",e?.message||e),new Error("Failed to generate QR code for order")}}var ca=_(()=>{"use strict";H();Q()});var la={};U(la,{getCustomerOrderStatusHistory:()=>ci,getOrderStatusHistory:()=>ii,notifyCustomerOfStatusChange:()=>li,recordStatusChange:()=>ni});import{sql as ct}from"drizzle-orm";async function ni(o,e,t,r){try{await m.execute(ct`
      INSERT INTO order_status_history (order_id, previous_status, new_status, notes)
      VALUES (${o}, ${e}, ${t}, ${r||null})
    `);let[a]=await m.execute(ct`
      SELECT * FROM order_status_history 
      WHERE order_id = ${o}
      ORDER BY changed_at DESC LIMIT 1
    `);return a}catch(a){throw console.error("Error recording status change:",a),a}}async function ii(o){try{return await m.execute(ct`
      SELECT * FROM order_status_history 
      WHERE order_id = ${o}
      ORDER BY changed_at DESC
    `)}catch(e){throw console.error("Error fetching order status history:",e),e}}async function ci(o){try{return await m.execute(ct`
      SELECT h.*, o.id as order_id, o.frame_name, o.artwork_description
      FROM order_status_history h
      JOIN orders o ON h.order_id = o.id
      WHERE o.customer_id = ${o}
      ORDER BY h.changed_at DESC
    `)}catch(e){throw console.error("Error fetching customer order status history:",e),e}}async function li(o,e,t){try{if(!o.customerId)return;let[r]=await m.execute(ct`
      SELECT * FROM customers WHERE id = ${o.customerId}
    `);return!r||!r.status_notifications_enabled?void 0:(await tt(r.email,r.name,o.id,t,o.dueDate),!0)}catch(r){return console.error("Error notifying customer of status change:",r),!1}}var ua=_(()=>{"use strict";H();rt()});var lt={};U(lt,{configureKanbanConnection:()=>xr,generateApiKey:()=>ui,getAllOrdersWithQrCodes:()=>Pr,getIntegrationDocs:()=>mi,getIntegrationStatus:()=>di,getOrderWithQrCode:()=>wr,receiveWebhook:()=>vr,testIntegration:()=>Ir,updateOrderStatus:()=>Sr});async function wr(o,e){try{let{id:t}=o.params,r=parseInt(t);if(isNaN(r))return e.status(400).json({error:"Invalid order ID"});let a=await y.getOrder(r);if(!a)return e.status(404).json({error:"Order not found"});let s=await br(r);e.json({success:!0,order:{...a,qrCode:s}})}catch(t){console.error("Error fetching order with QR code:",t),e.status(500).json({error:t.message||"Failed to fetch order information"})}}async function Pr(o,e){try{let{status:t,limit:r}=o.query,a=r?parseInt(r):void 0,s=await y.getOrders(t),n=a?s.slice(0,a):s,c=await Promise.all(n.map(async i=>{let d=await br(i.id);return{...i,qrCode:d}}));e.json({success:!0,count:c.length,orders:c})}catch(t){console.error("Error fetching orders with QR codes:",t),e.status(500).json({error:t.message||"Failed to fetch orders"})}}async function Sr(o,e){try{let{id:t}=o.params,{status:r,notes:a}=o.body,s=parseInt(t);if(isNaN(s))return e.status(400).json({error:"Invalid order ID"});if(!r)return e.status(400).json({error:"Status is required"});let n=await y.getOrder(s);if(!n)return e.status(404).json({error:"Order not found"});let c=await y.updateOrder(s,{status:r,notes:a||`Status updated via Integration API to: ${r}`});try{await(ua(),zr(la)).addStatusHistory(s,{previousStatus:n.status,newStatus:r,changedBy:"Integration API",notes:a||"Status updated via Integration API"})}catch(i){console.warn("Could not log status history:",i)}e.json({success:!0,message:"Order status updated",order:c})}catch(t){console.error("Error updating order status:",t),e.status(500).json({error:t.message||"Failed to update order status"})}}async function vr(o,e){try{let{source:t,event:r,data:a}=o.body;if(!t||!r)return e.status(400).json({error:"Source and event are required"});switch(console.log(`Received webhook from ${t}, event: ${r}`),t){case"qr_generator":if(r==="qr_generated"&&a&&a.orderId){let s=parseInt(a.orderId);await y.updateOrder(s,{hasQrCode:!0,qrCodeGeneratedAt:new Date,qrCodeData:a.qrData})}break;case"printing_system":if(r==="invoice_printed"&&a&&a.orderId){let s=parseInt(a.orderId);await y.updateOrder(s,{invoicePrinted:!0,printedAt:new Date})}break;default:console.log(`Unknown webhook source: ${t}`)}e.json({success:!0,message:`Webhook received from ${t} for event ${r}`})}catch(t){console.error("Error processing webhook:",t),e.status(500).json({error:t.message||"Failed to process webhook"})}}async function ui(o,e){try{e.setHeader("Content-Type","application/json");let t=Date.now(),r=Math.random().toString(36).substring(2,15),a=`jf_api_${t}_${r}`,s={key:a,name:"Jay's Frames API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"],createdAt:new Date().toISOString(),lastUsed:null};console.log("New API Key generated:",a);let n={success:!0,...s,message:"API key generated successfully. Store this securely.",endpoints:{baseUrl:process.env.REPL_URL||`https://${process.env.REPL_SLUG}.${process.env.REPL_OWNER}.repl.co`,orders:"/api/integration/orders",webhook:"/api/integration/webhook",status:"/api/integration/status",pricing:"/api/pricing/calculate",catalog:"/api/vendor-catalog/frames"},authentication:{method:"Bearer Token",header:"Authorization",value:`Bearer ${a}`}};return e.status(200).json(n)}catch(t){console.error("Error generating API key:",t),e.setHeader("Content-Type","application/json"),e.status(500).json({success:!1,error:t.message||"Failed to generate API key"})}}async function Ir(o,e){try{e.json({success:!0,message:"Integration API is working correctly",timestamp:new Date().toISOString(),endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-url.replit.dev",orders:"/api/integration/orders",webhook:"/api/integration/webhook",configureKanban:"/api/integration/configure-kanban"}})}catch(t){console.error("Error in test integration:",t),e.status(500).json({success:!1,error:t.message||"Integration test failed"})}}async function xr(o,e){try{let{kanbanApiUrl:t,kanbanApiKey:r}=o.body;if(!t||!r)return e.status(400).json({success:!1,error:"Both kanbanApiUrl and kanbanApiKey are required"});try{let a=await fetch(`${t}/api/kanban/status`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},timeout:5e3});if(!a.ok)throw new Error(`Connection test failed: ${a.status}`);let s=await a.json();e.json({success:!0,message:"Kanban connection configured successfully",kanbanStatus:s,configuration:{kanbanApiUrl:t,apiKeyConfigured:!0}})}catch(a){e.status(400).json({success:!1,error:`Failed to connect to Kanban app: ${a.message}`})}}catch(t){console.error("Error configuring Kanban connection:",t),e.status(500).json({success:!1,error:t.message||"Failed to configure Kanban connection"})}}async function di(o,e){try{e.json({success:!0,status:"active",integrations:{webhooks:{enabled:!0,endpointCount:0},apiAccess:{enabled:!0,lastGenerated:new Date().toISOString()}},endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-url.replit.dev",orders:"/api/integration/orders",webhook:"/api/integration/webhook"}})}catch(t){console.error("Error getting integration status:",t),e.status(500).json({success:!1,error:t.message||"Failed to get integration status"})}}async function mi(o,e){try{e.json({success:!0,documentation:{authentication:{method:"Bearer Token",header:"Authorization",example:"Authorization: Bearer YOUR_API_KEY"},endpoints:[{method:"GET",path:"/api/integration/orders",description:"Get all orders with QR codes",parameters:{status:"optional - filter by order status",limit:"optional - limit number of results"}},{method:"GET",path:"/api/integration/orders/:id",description:"Get specific order with QR code",parameters:{id:"required - order ID"}},{method:"PATCH",path:"/api/integration/orders/:id/status",description:"Update order status",body:{status:"required - new status",notes:"optional - status change notes"}},{method:"POST",path:"/api/integration/webhook",description:"Receive webhook notifications",body:{source:"required - webhook source",event:"required - event type",data:"optional - event data"}}],webhookEvents:["order.created","order.updated","order.completed","payment.received","qr.generated"]}})}catch(t){console.error("Error getting integration docs:",t),e.status(500).json({success:!1,error:t.message||"Failed to get integration documentation"})}}var Ue=_(()=>{"use strict";J();ca()});import{defineConfig as Ni}from"vite";import Mi from"@vitejs/plugin-react";import ji from"@replit/vite-plugin-shadcn-theme-json";import He from"path";import{fileURLToPath as Di}from"url";import Li from"@replit/vite-plugin-runtime-error-modal";var Ti,mt,$i,Ja=_(()=>{"use strict";Ti=Di(import.meta.url),mt=He.dirname(Ti),$i=Ni({plugins:[Mi(),Li(),ji()],root:"client",resolve:{alias:{"@":He.resolve(mt,"./client/src"),"@shared":He.resolve(mt,"./shared"),"@assets":He.resolve(mt,"attached_assets")}},build:{outDir:He.resolve(mt,"dist/public"),emptyOutDir:!0,rollupOptions:{input:He.resolve(mt,"client/index.html"),output:{manualChunks:{vendor:["react","react-dom"],ui:["@radix-ui/react-dialog","@radix-ui/react-dropdown-menu","@radix-ui/react-toast"],charts:["recharts"],utils:["date-fns","clsx","tailwind-merge"],icons:["lucide-react","react-icons"],forms:["react-hook-form","@hookform/resolvers"],query:["@tanstack/react-query"]}}}},server:{host:"0.0.0.0",port:5173,hmr:{port:5173}},preview:{host:"0.0.0.0",port:5173}})});import{createServer as Rm,createLogger as qi}from"vite";import{nanoid as Mm}from"nanoid";import Lm from"express";import Bi from"path";import{fileURLToPath as Wi}from"url";function V(o,e="express"){let t=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${t} [${e}] ${o}`)}var jm,Ui,qm,Ar=_(()=>{"use strict";Ja();jm=qi();Ui=Wi(import.meta.url),qm=Bi.dirname(Ui)});var ls={};U(ls,{calculateFramingPricing:()=>pc,calculatePrice:()=>mc});async function mc(o,e){try{let{frameId:t,matColorId:r,glassOptionId:a,artworkWidth:s,artworkHeight:n,matWidth:c,quantity:i,include_wholesale_prices:d}=o.body;if(s===void 0||n===void 0||c===void 0||i===void 0)return e.status(400).json({error:"Missing required parameters. Please provide artworkWidth, artworkHeight, matWidth, and quantity."});let h=o.body.framePricingMethod||"chop",g={frameId:t||"none",matColorId:r||"none",glassOptionId:a||"none",artworkWidth:parseFloat(s),artworkHeight:parseFloat(n),matWidth:parseFloat(c),quantity:parseInt(i),includeWholesalePrices:!!d,framePricingMethod:h},u=await or(g);e.status(200).json(u)}catch(t){console.error("Error calculating price:",t),e.status(500).json({error:"An error occurred while calculating the price",message:t.message})}}async function pc(o,e){try{e.setHeader("Content-Type","application/json");let{frameItem:t,frameWidth:r,frameHeight:a,glassType:s="Regular",matboard1:n=null,matboard2:c=null,quantity:i=1,rushOrder:d=!1,specialServices:h=[]}=o.body;if(!t||!r||!a)return e.status(400).json({success:!1,error:"Missing required fields: frameItem, frameWidth, frameHeight"});let g={framePrice:50,glassPrice:15,matPrice:20,laborPrice:35,subtotal:120,tax:9.6,total:129.6};e.status(200).json({success:!0,pricing:g})}catch(t){console.error("Pricing calculation error:",t?.message||t),e.status(500).json({success:!1,error:"Failed to calculate pricing"})}}var us=_(()=>{"use strict";ar()});var Rr={};U(Rr,{generateOrderingRecommendations:()=>bc,getSeasonalTrends:()=>Sc});import gc from"openai";import{sql as fc}from"drizzle-orm";async function bc(){try{V("Generating AI-powered material ordering recommendations","aiMaterialOrderingService");let o=await wc();if(o.length===0)return[];let e=Pc(o),r=(await hc.chat.completions.create({model:yc,messages:[{role:"system",content:"You are an expert inventory management consultant for a custom framing business. You analyze material usage patterns, seasonal trends, and lead times to optimize ordering decisions. Your goal is to prevent stockouts while minimizing holding costs and waste."},{role:"user",content:e}],response_format:{type:"json_object"},temperature:.2,max_tokens:2e3})).choices[0].message.content;if(!r)throw new Error("No response from OpenAI");return JSON.parse(r).recommendations||[]}catch(o){throw V(`Error generating ordering recommendations: ${o}`,"aiMaterialOrderingService"),o}}async function wc(){try{let o=fc`
      SELECT 
        m.id as material_id,
        m.name as material_name,
        m.type as material_type,
        m.stock_quantity as current_stock,
        m.price as price_per_unit,
        m.lead_time_days as lead_time,
        COALESCE(usage_month.usage_count, 0) as usage_last_month,
        COALESCE(usage_3month.usage_count, 0) as usage_last_3_months,
        COALESCE(avg_order.avg_size, 1) as average_order_size
      FROM materials m
      LEFT JOIN (
        SELECT material_id, COUNT(*) as usage_count
        FROM order_materials om
        JOIN orders o ON om.order_id = o.id
        WHERE o.created_at >= NOW() - INTERVAL '1 month'
        GROUP BY material_id
      ) usage_month ON m.id = usage_month.material_id
      LEFT JOIN (
        SELECT material_id, COUNT(*) as usage_count
        FROM order_materials om
        JOIN orders o ON om.order_id = o.id
        WHERE o.created_at >= NOW() - INTERVAL '3 months'
        GROUP BY material_id
      ) usage_3month ON m.id = usage_3month.material_id
      LEFT JOIN (
        SELECT material_id, AVG(quantity) as avg_size
        FROM order_materials
        GROUP BY material_id
      ) avg_order ON m.id = avg_order.material_id
      WHERE m.active = true
    `;return[{materialId:"frame_001",materialName:'Black Metal Frame 1"',materialType:"frame",currentStock:25,usageLastMonth:15,usageLast3Months:48,averageOrderSize:2.5,seasonalTrend:"stable",pricePerUnit:45.5,leadTime:14},{materialId:"mat_001",materialName:"White Conservation Mat",materialType:"mat",currentStock:8,usageLastMonth:22,usageLast3Months:67,averageOrderSize:1.8,seasonalTrend:"increasing",pricePerUnit:12.75,leadTime:7}]}catch(o){return V(`Error getting material usage data: ${o}`,"aiMaterialOrderingService"),[]}}function Pc(o){return`
Analyze the following material usage data for a custom framing business and provide ordering recommendations:

MATERIAL USAGE DATA:
${JSON.stringify(o,null,2)}

BUSINESS CONTEXT:
- We want to maintain 2-3 weeks of inventory as safety stock
- Minimize holding costs while preventing stockouts
- Consider seasonal trends and lead times
- Budget constraints may limit large orders

Please provide recommendations in this JSON format:
{
  "recommendations": [
    {
      "materialId": "string",
      "materialName": "string", 
      "recommendedQuantity": number,
      "urgency": "low|medium|high|critical",
      "reasoning": "detailed explanation of recommendation",
      "estimatedRunoutDate": "YYYY-MM-DD",
      "suggestedOrderDate": "YYYY-MM-DD", 
      "costImpact": number
    }
  ],
  "summary": "Overall analysis and key insights"
}

Consider:
1. Current stock levels vs usage patterns
2. Lead times and reorder points
3. Seasonal trends and demand forecasting  
4. Cost optimization opportunities
5. Risk of stockouts vs holding costs
`}async function Sc(o){try{return{materialId:o,trends:{spring:"high_demand",summer:"medium_demand",fall:"high_demand",winter:"low_demand"},recommendation:"Stock up before spring and fall seasons"}}catch(e){throw V(`Error getting seasonal trends: ${e}`,"aiMaterialOrderingService"),e}}var hc,yc,Er=_(()=>{"use strict";Ar();hc=new gc({apiKey:process.env.OPENAI_API_KEY}),yc="gpt-4o"});var Nr={};U(Nr,{addCustomer:()=>Cc,customerProfiles:()=>De,getCustomerByEmail:()=>Ic,getCustomerById:()=>xc,getCustomerByPhone:()=>vc,updateCustomerDiscordId:()=>kc});function vc(o){return De.find(e=>e.phone===o)}function Ic(o){return De.find(e=>e.email===o)}function xc(o){return De.find(e=>e.id===o)}function Cc(o){let e={...o,id:Math.max(...De.map(t=>t.id))+1};return De.push(e),e}function kc(o,e){let t=De.find(r=>r.id===o);return t?(t.discordUserId=e,!0):!1}var De,Mr=_(()=>{"use strict";De=[{id:1,name:"Jay Stevens",email:"joshuastevens100@gmail.com",phone:"+1 832 893-3794",preferences:{email:!0,sms:!0,discord:!0,inApp:!0},notes:"Primary contact - Business owner"}]});var ft={};U(ft,{externalKanbanService:()=>Fc});var jr,Fc,ht=_(()=>{"use strict";jr=class{constructor(){k(this,"baseUrl");k(this,"apiKey");this.baseUrl=process.env.EXTERNAL_KANBAN_URL||"",this.apiKey=process.env.EXTERNAL_KANBAN_API_KEY||"",console.log("External Kanban Service initialized:",{hasUrl:!!this.baseUrl,hasApiKey:!!this.apiKey,baseUrl:this.baseUrl?`${this.baseUrl.substring(0,30)}...`:"Not configured"})}async fetchOrders(){if(!this.baseUrl||!this.apiKey)return console.log("Kanban configuration missing:",{hasUrl:!!this.baseUrl,hasApiKey:!!this.apiKey}),{success:!1,orders:[],error:"External Kanban URL or API key not configured"};console.log("Attempting to fetch orders from Kanban:",this.baseUrl);try{let e=await fetch(`${this.baseUrl}/api/orders`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},timeout:1e4});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return{success:!0,orders:(await e.json()).orders?.map(a=>({id:a.orderId||a.id,orderNumber:a.orderId||a.orderNumber,customerName:a.customerName,artworkTitle:a.artworkTitle||a.description,frameSize:a.frameSize||`${a.width||0}x${a.height||0}`,status:this.mapExternalStatus(a.status),stage:a.stage||"pending",priority:a.priority||"standard",dueDate:a.dueDate,createdAt:a.createdAt,estimatedCompletion:a.estimatedCompletion,materials:a.materials||{frameType:a.frameType||"Unknown",matColor:a.matColor||"White",glass:a.glass||"Regular"}}))||[]}}catch(e){return console.error("Error fetching from external Kanban:",e),{success:!1,orders:[],error:e instanceof Error?e.message:"Unknown error"}}}async updateOrderStatus(e,t,r,a){if(!this.baseUrl||!this.apiKey)return console.error("External Kanban URL or API key not configured"),!1;try{return(await fetch(`${this.baseUrl}/api/orders/${e}/status`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({status:this.mapInternalToExternalStatus(t),stage:r,notes:a,updatedBy:"Jays Frames POS",timestamp:new Date().toISOString()}),timeout:1e4})).ok}catch(s){return console.error("Error updating external Kanban order:",s),!1}}mapExternalStatus(e){return{pending:"pending",in_progress:"in_production",in_production:"in_production",designing:"in_design",material_prep:"awaiting_materials",cutting:"in_production",assembly:"in_production",quality_check:"in_production",completed:"ready_for_pickup",ready:"ready_for_pickup",delivered:"completed",picked_up:"completed"}[e.toLowerCase()]||"pending"}mapInternalToExternalStatus(e){return{pending:"pending",in_design:"designing",awaiting_materials:"material_prep",in_production:"in_production",ready_for_pickup:"completed",completed:"delivered"}[e]||"pending"}async healthCheck(){if(!this.baseUrl||!this.apiKey)return{status:"not_configured",connected:!1};try{let e=await fetch(`${this.baseUrl}/api/health`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},timeout:5e3});return{status:e.ok?"connected":"error",connected:e.ok,lastSync:new Date().toISOString()}}catch{return{status:"error",connected:!1}}}},Fc=new jr});import Oc from"twilio";async function Ac(o){if(!Dr)return console.warn("Twilio is not configured. SMS sending is disabled."),{success:!1,error:"Twilio is not configured. Set TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN environment variables."};if(!o.to||!o.to.match(/^\+?[1-9]\d{1,14}$/))return{success:!1,error:"Invalid phone number format. Must be E.164 format (e.g., +12125551234)."};try{let e=o.to;e.startsWith("+")||(e="+1"+e.replace(/\D/g,""));let t=await Dr.messages.create({to:e,from:process.env.TWILIO_PHONE_NUMBER||"",body:o.message});return console.log(`SMS sent successfully to ${o.to}, SID: ${t.sid}`),{success:!0,sid:t.sid}}catch(e){return console.error("Twilio Error:",e),{success:!1,error:`Failed to send SMS: ${e.message}`}}}function _c(o){let e=o.replace(/\D/g,"");return e.length===10?`+1${e}`:e.length>10&&!o.startsWith("+")?`+${e}`:(o.startsWith("+"),o)}async function ds(o,e,t,r="Jay's Frames"){let a=e.toLocaleString("en-US",{style:"currency",currency:"USD"}),s=`${r}: A payment of ${a} is due. Pay securely with this link: ${t}`;return await Ac({to:_c(o),message:s})}var Dr,ms=_(()=>{"use strict";Dr=null;process.env.TWILIO_ACCOUNT_SID&&process.env.TWILIO_AUTH_TOKEN&&(Dr=Oc(process.env.TWILIO_ACCOUNT_SID,process.env.TWILIO_AUTH_TOKEN))});import Rc from"crypto";import{addDays as Ec}from"date-fns";import Nc from"stripe";import{eq as Ie,and as Mc,gt as jc}from"drizzle-orm";function Dc(){return Rc.randomBytes(16).toString("hex")}async function ps(o,e,t,r=7){let a=Dc(),s=Ec(new Date,r),n=Math.round(o*100),[c]=await m.insert(j).values({token:a,amount:o.toString(),description:t,customerId:e,expiresAt:s}).returning();return c}async function Tr(o,e,t="Jay's Frames"){let[r]=await m.select().from(j).where(Ie(j.id,o));if(!r)throw new Error(`Payment link with ID ${o} not found`);let s=Number(r.amount).toLocaleString("en-US",{style:"currency",currency:"USD"}),c=`${process.env.BASE_URL||"http://localhost:5000"}/payment/${r.token}`,i=`
    <h2>Payment Request from ${t}</h2>
    <p>A payment of <strong>${s}</strong> is due.</p>
    <p>${r.description||""}</p>
    <p>
      <a href="${c}" style="
        display: inline-block;
        background-color: #4CAF50;
        color: white;
        padding: 12px 20px;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;">
        Pay Now
      </a>
    </p>
    <p>Or copy and paste this link: ${c}</p>
    <p>This payment link will expire on ${r.expiresAt.toLocaleDateString()}.</p>
    <p>Thank you for your business!</p>
  `;try{return await et({to:e,from:`info@${t.toLowerCase().replace(/[^a-z0-9]/g,"")}.com`,subject:`Payment Request for ${s} - ${t}`,text:`Payment Request from ${t}

A payment of ${s} is due.

${r.description||""}

Pay online at: ${c}

This payment link will expire on ${r.expiresAt.toLocaleDateString()}.

Thank you for your business!`,html:i}),await m.insert(G).values({customerId:r.customerId,notificationType:"payment_link",channel:"email",subject:`Payment Request for ${s}`,message:`Payment link sent via email to ${e}`,successful:!0,paymentLinkId:r.id}),!0}catch(d){return console.error("Failed to send payment link email:",d),await m.insert(G).values({customerId:r.customerId,notificationType:"payment_link",channel:"email",subject:`Payment Request for ${s}`,message:`Failed to send payment link via email to ${e}`,successful:!1,paymentLinkId:r.id}),!1}}async function $r(o,e,t="Jay's Frames"){let[r]=await m.select().from(j).where(Ie(j.id,o));if(!r)throw new Error(`Payment link with ID ${o} not found`);let a=Number(r.amount),n=`${process.env.BASE_URL||"http://localhost:5000"}/payment/${r.token}`;try{let c=await ds(e,a,n,t);return await m.insert(G).values({customerId:r.customerId,notificationType:"payment_link",channel:"sms",subject:"Payment Link",message:`Payment link sent via SMS to ${e}`,successful:c.success,paymentLinkId:r.id,responseData:c}),c.success}catch(c){return console.error("Failed to send payment link SMS:",c),await m.insert(G).values({customerId:r.customerId,notificationType:"payment_link",channel:"sms",subject:"Payment Link",message:`Failed to send payment link via SMS to ${e}`,successful:!1,paymentLinkId:r.id}),!1}}async function Lt(o){let e=new Date,[t]=await m.select().from(j).where(Mc(Ie(j.token,o),Ie(j.used,!1),jc(j.expiresAt,e)));return t||null}async function gs(o){if(!Lr)return console.warn("Stripe is not configured. Payment processing is disabled."),null;let[e]=await m.select().from(j).where(Ie(j.id,o));if(!e)throw new Error(`Payment link with ID ${o} not found`);let t=Math.round(Number(e.amount)*100);try{let r=await Lr.paymentIntents.create({amount:t,currency:"usd",description:e.description||`Payment for link ${e.token}`,metadata:{paymentLinkId:e.id.toString(),token:e.token}});return await m.update(j).set({paymentIntentId:r.id}).where(Ie(j.id,o)),r.client_secret}catch(r){return console.error("Failed to create payment intent:",r),null}}async function qr(o,e="succeeded"){try{return await m.transaction(async r=>{let[a]=await r.select().from(j).where(Ie(j.id,o));if(!a)throw new Error("Payment link not found");if(a.used)throw new Error("Payment link has already been used");let s=new Date;if(a.expiresAt<s)throw new Error("Payment link has expired");let[n]=await r.update(j).set({used:!0,usedAt:new Date,paymentStatus:e}).where(Ie(j.id,o)).returning();return await r.insert(G).values({customerId:a.customerId,notificationType:"payment_completion",channel:"system",subject:"Payment Completed",message:`Payment of $${a.amount} completed successfully`,successful:e==="succeeded",paymentLinkId:a.id,responseData:{status:e,paymentIntentId:a.paymentIntentId}}),n})}catch(t){throw console.error("Error marking payment link as used:",t),t}}var Lr,fs=_(()=>{"use strict";H();Q();rt();ms();Lr=null;process.env.STRIPE_SECRET_KEY&&(Lr=new Nc(process.env.STRIPE_SECRET_KEY))});var hs={};U(hs,{completePaymentForLink:()=>Wc,createNewPaymentLink:()=>Lc,getAllPaymentLinks:()=>Tc,getPaymentLinkById:()=>$c,sendPaymentLinkNotification:()=>qc,validatePaymentLinkByToken:()=>Bc,verifyPaymentCompletion:()=>Uc});import{eq as Br}from"drizzle-orm";async function Lc(o,e){try{e.setHeader("Content-Type","application/json");let{amount:t,customerId:r,description:a,expiresInDays:s=7,email:n,phone:c,sendNotification:i}=o.body;if(!t||isNaN(Number(t))||Number(t)<=0)return e.status(400).json({success:!1,message:"Valid payment amount is required"});if(r){let[l]=await m.select().from(A).where(Br(A.id,r));if(!l)return e.status(404).json({success:!1,message:"Customer not found"})}let d=await ps(Number(t),r,a,s),h={email:!1,sms:!1};i&&n&&(h.email=await Tr(d.id,n)),i&&c&&(h.sms=await $r(d.id,c));let u=`${process.env.BASE_URL||"http://localhost:5000"}/payment/${d.token}`;return e.status(201).json({success:!0,paymentLink:{...d,paymentUrl:u},notifications:h})}catch(t){return console.error("Error creating payment link:",t),e.setHeader("Content-Type","application/json"),e.status(500).json({success:!1,message:`Failed to create payment link: ${t.message}`})}}async function Tc(o,e){try{e.setHeader("Content-Type","application/json");let t=await m.select().from(j).orderBy(j.createdAt,"desc");return e.json({success:!0,paymentLinks:t})}catch(t){return console.error("Error fetching payment links:",t),e.setHeader("Content-Type","application/json"),e.status(500).json({success:!1,message:`Failed to fetch payment links: ${t.message}`})}}async function $c(o,e){try{e.setHeader("Content-Type","application/json");let t=parseInt(o.params.id),[r]=await m.select().from(j).where(Br(j.id,t));return r?e.json({success:!0,paymentLink:r}):e.status(404).json({success:!1,message:"Payment link not found"})}catch(t){return console.error("Error fetching payment link:",t),e.setHeader("Content-Type","application/json"),e.status(500).json({success:!1,message:`Failed to fetch payment link: ${t.message}`})}}async function qc(o,e){try{let t=parseInt(o.params.id),{email:r,phone:a,notificationType:s="both"}=o.body,[n]=await m.select().from(j).where(Br(j.id,t));if(!n)return e.status(404).json({message:"Payment link not found"});if(n.used)return e.status(400).json({message:"Payment link has already been used"});let c=new Date;if(n.expiresAt<c)return e.status(400).json({message:"Payment link has expired"});let i={};(s==="email"||s==="both")&&r&&(i.email=await Tr(t,r)),(s==="sms"||s==="both")&&a&&(i.sms=await $r(t,a)),e.json({success:!0,notifications:i})}catch(t){console.error("Error sending payment link notification:",t),e.status(500).json({success:!1,message:`Failed to send notification: ${t.message}`})}}async function Bc(o,e){try{let{token:t}=o.params,r=await Lt(t);if(!r)return e.status(404).json({valid:!1,message:"Payment link is invalid, expired, or has already been used"});let a=await gs(r.id);if(!a)return e.status(500).json({valid:!0,canProcess:!1,message:"Failed to create payment intent"});e.json({valid:!0,canProcess:!0,paymentLink:{amount:r.amount,description:r.description,expiresAt:r.expiresAt},clientSecret:a})}catch(t){console.error("Error validating payment link:",t),e.status(500).json({valid:!1,message:`Failed to validate payment link: ${t.message}`})}}async function Wc(o,e){try{let{token:t}=o.params,{paymentIntentId:r,status:a="succeeded"}=o.body,s=await Lt(t);if(!s)return e.status(404).json({success:!1,message:"Payment link is invalid, expired, or has already been used"});let n=await qr(s.id,a);if(!n)return e.status(500).json({success:!1,message:"Failed to mark payment link as used"});e.json({success:!0,message:"Payment completed successfully",paymentLink:{id:n.id,used:n.used,usedAt:n.usedAt}})}catch(t){console.error("Complete payment error:",t),e.status(500).json({success:!1,message:"Failed to complete payment"})}}async function Uc(o,e){try{let{token:t}=o.params,{paymentIntentId:r}=o.body;if(!r)return e.status(400).json({success:!1,message:"Payment intent ID is required"});let a=await Lt(t);if(!a)return e.status(404).json({success:!1,message:"Payment link not found or expired"});if(process.env.STRIPE_SECRET_KEY){let s=new Stripe(process.env.STRIPE_SECRET_KEY);try{if((await s.paymentIntents.retrieve(r)).status==="succeeded"&&!a.used)return await qr(a.id,"succeeded"),e.json({success:!0,verified:!0,message:"Payment verified successfully"})}catch(n){return console.error("Stripe verification error:",n),e.status(400).json({success:!1,message:"Payment verification failed"})}}e.json({success:!0,verified:!1,message:"Could not verify payment with Stripe"})}catch(t){console.error("Error verifying payment:",t),e.status(500).json({success:!1,message:`Payment verification error: ${t.message}`})}}var ys=_(()=>{"use strict";H();Q();fs()});import Tt from"express";import Vc from"cors";import $t from"path";import yt from"fs";import{fileURLToPath as Yc}from"url";import Qc from"dotenv";import{createServer as Hc}from"http";import{WebSocketServer as Gc,WebSocket as Kc}from"ws";J();import{z as Oe}from"zod";var Gn=Oe.object({orderId:Oe.number(),location:Oe.string(),artworkType:Oe.string(),artworkDescription:Oe.string(),artworkWidth:Oe.number(),artworkHeight:Oe.number()}),cr={async sendArtLocationData(o,e){try{let t=Gn.parse(o.body),r=await y.updateOrderArtLocation(t.orderId,t.location);e.status(200).json({success:!0,message:"Art location data recorded successfully",data:r})}catch(t){console.error("Error recording art location data:",t),e.status(500).json({success:!1,message:"Failed to record art location data",error:t instanceof Error?t.message:"Unknown error"})}},async getArtLocationData(o,e){try{let t=Number(o.params.orderId);if(isNaN(t))return e.status(400).json({success:!1,message:"Invalid order ID"});let r=await y.getOrder(t);if(!r)return e.status(404).json({success:!1,message:"Order not found"});e.status(200).json({orderId:r.id,location:r.artworkLocation||"",artworkType:r.artworkType||"",artworkDescription:r.artworkDescription||"",artworkWidth:r.artworkWidth||0,artworkHeight:r.artworkHeight||0})}catch(t){console.error("Error fetching art location data:",t),e.status(500).json({success:!1,message:"Failed to fetch art location data",error:t instanceof Error?t.message:"Unknown error"})}}};H();Q();import{eq as Po}from"drizzle-orm";var lr={async saveFrameDesign(o,e){try{let{orderId:t,imageData:r}=o.body;if(!t||!r)return e.status(400).json({success:!1,message:"Order ID and image data are required"});await m.update(x).set({frameDesignImage:r}).where(Po(x.id,parseInt(t))),e.status(200).json({success:!0,message:"Frame design image saved successfully"})}catch(t){console.error("Error saving frame design:",t),e.status(500).json({success:!1,message:"Failed to save frame design image",error:t instanceof Error?t.message:"Unknown error"})}},async getFrameDesign(o,e){try{let t=o.params.orderId;if(!t)return e.status(400).json({success:!1,message:"Order ID is required"});let[r]=await m.select({frameDesignImage:x.frameDesignImage}).from(x).where(Po(x.id,parseInt(t)));if(!r||!r.frameDesignImage)return e.status(404).json({success:!1,message:"Frame design image not found"});e.status(200).json({success:!0,imageData:r.frameDesignImage})}catch(t){console.error("Error retrieving frame design:",t),e.status(500).json({success:!1,message:"Failed to retrieve frame design image",error:t instanceof Error?t.message:"Unknown error"})}}};var ur={kanban_admin_key_2025_full_access:{name:"3D Designer Integration",permissions:["orders:create","orders:read","orders:update","pricing:read","files:upload"],created:new Date().toISOString(),lastUsed:null},jf_houston_heights_framing_2025_master_api_key_secure_access:{name:"Houston Heights Framing API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"],created:new Date().toISOString(),lastUsed:null}};function dr(o,e,t){let r=o.headers.authorization;if(!r)return e.status(401).json({error:"Missing Authorization header",message:"API key required in Authorization header as: Bearer YOUR_API_KEY"});let a=r.replace("Bearer ","");if(ur[a])return ur[a].lastUsed=new Date().toISOString(),o.apiKey=ur[a],o.apiKeyType="static",t();try{o.apiKeyType="jwt",t()}catch{return e.status(401).json({error:"Invalid API key or JWT token",message:"The provided authentication token is not valid"})}}J();st();J();var ko=[{itemNumber:"10-036M",width:'5/8"',boxQty:360,collection:"Maple & Walnut - Garrett",basePricePerFoot:6.62,boxPrice:10.05,lengthPrice:13.52,chopPrice:14.52},{itemNumber:"10-100M",width:'5/8"',boxQty:375,collection:"Maple & Walnut - Garrett",basePricePerFoot:6.34,boxPrice:9.71,lengthPrice:12.75,chopPrice:13.75},{itemNumber:"10-507M",width:'5/8"',boxQty:306,collection:"Museum Stems - Garrett",basePricePerFoot:6.52,boxPrice:9.91,lengthPrice:13,chopPrice:14},{itemNumber:"100172",width:'1/4"',boxQty:1600,collection:"Olmsted",basePricePerFoot:2.75,boxPrice:4.64,lengthPrice:7.28,chopPrice:8.28},{itemNumber:"100750",width:'1/4"',boxQty:1200,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"100751",width:'1/4"',boxQty:1587,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"100752",width:'1/4"',boxQty:1e3,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"102CG",width:'1/2"',boxQty:432,collection:"Marquis",basePricePerFoot:1.74,boxPrice:3.7,lengthPrice:6.43,chopPrice:7.43},{itemNumber:"102CS",width:'1/2"',boxQty:432,collection:"Marquis",basePricePerFoot:1.74,boxPrice:3.7,lengthPrice:6.43,chopPrice:7.43},{itemNumber:"103180",width:'9/16"',boxQty:900,collection:"Hudson",basePricePerFoot:1.46,boxPrice:3.11,lengthPrice:5.56,chopPrice:6.56},{itemNumber:"103190",width:'9/16"',boxQty:900,collection:"Hudson",basePricePerFoot:1.4,boxPrice:2.97,lengthPrice:5.3,chopPrice:6.3},{itemNumber:"103235",width:'5/16"',boxQty:1200,collection:"Academie",basePricePerFoot:1.44,boxPrice:3.17,lengthPrice:5.64,chopPrice:6.64},{itemNumber:"103237",width:'5/16"',boxQty:1296,collection:"Academie",basePricePerFoot:1.43,boxPrice:3.14,lengthPrice:5.59,chopPrice:6.59},{itemNumber:"105794",width:'5/16"',boxQty:785,collection:"Lucerne",basePricePerFoot:3.21,boxPrice:5.02,lengthPrice:8.01,chopPrice:9.01},{itemNumber:"105CB",width:'1/2"',boxQty:270,collection:"Vienna",basePricePerFoot:2.21,boxPrice:3.31,lengthPrice:5.71,chopPrice:6.71},{itemNumber:"106180",width:'1/2"',boxQty:900,collection:"Hudson",basePricePerFoot:1.39,boxPrice:2.99,lengthPrice:5.31,chopPrice:6.31},{itemNumber:"106190",width:'1/2"',boxQty:900,collection:"Hudson",basePricePerFoot:1.32,boxPrice:2.83,lengthPrice:5.09,chopPrice:6.09},{itemNumber:"200750",width:'7/8"',boxQty:250,collection:"Sofia",basePricePerFoot:4.38,boxPrice:6.54,lengthPrice:9.9,chopPrice:10.9},{itemNumber:"200751",width:'7/8"',boxQty:515,collection:"Sofia",basePricePerFoot:4.35,boxPrice:6.76,lengthPrice:9.84,chopPrice:10.84},{itemNumber:"200752",width:'7/8"',boxQty:490,collection:"Sofia",basePricePerFoot:4.57,boxPrice:7.31,lengthPrice:10.33,chopPrice:11.33},{itemNumber:"210286",width:'11/16"',boxQty:450,collection:"White",basePricePerFoot:1.89,boxPrice:3.06,lengthPrice:5.99,chopPrice:6.99},{itemNumber:"400750",width:'1 5/8"',boxQty:112,collection:"Sofia",basePricePerFoot:7.47,boxPrice:11.04,lengthPrice:17.48,chopPrice:18.48},{itemNumber:"400751",width:'1 5/8"',boxQty:192,collection:"Sofia",basePricePerFoot:7.09,boxPrice:10.44,lengthPrice:16.55,chopPrice:17.55},{itemNumber:"400752",width:'1 5/8"',boxQty:180,collection:"Sofia",basePricePerFoot:7.34,boxPrice:10.83,lengthPrice:17.17,chopPrice:18.17},{itemNumber:"431431",width:'1 3/8"',boxQty:115,collection:"Zen",basePricePerFoot:10.83,boxPrice:15.91,lengthPrice:26.01,chopPrice:27.01},{itemNumber:"431432",width:'1 3/8"',boxQty:113,collection:"Zen",basePricePerFoot:10.27,boxPrice:15.1,lengthPrice:24.68,chopPrice:25.68},{itemNumber:"431434",width:'1 3/8"',boxQty:110,collection:"Zen",basePricePerFoot:10.75,boxPrice:15.81,lengthPrice:25.82,chopPrice:26.82},{itemNumber:"432900",width:'1 3/4"',boxQty:225,collection:"Foundry",basePricePerFoot:6.62,boxPrice:9.75,lengthPrice:15.03,chopPrice:16.03},{itemNumber:"432902",width:'1 3/4"',boxQty:236,collection:"Foundry",basePricePerFoot:6.81,boxPrice:10.07,lengthPrice:15.52,chopPrice:16.52},{itemNumber:"433082",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.09,boxPrice:9.55,lengthPrice:14.41,chopPrice:15.41},{itemNumber:"433084",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.16,boxPrice:9.59,lengthPrice:14.54,chopPrice:15.54},{itemNumber:"433086",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.22,boxPrice:9.59,lengthPrice:14.54,chopPrice:15.54},{itemNumber:"434110",width:'1 1/4"',boxQty:137,collection:"CR2",basePricePerFoot:6.33,boxPrice:9.33,lengthPrice:14.98,chopPrice:15.98},{itemNumber:"435500",width:'1 5/16"',boxQty:324,collection:"Alto",basePricePerFoot:1.8,boxPrice:3.6,lengthPrice:6.72,chopPrice:7.72},{itemNumber:"435510",width:'1 5/16"',boxQty:296,collection:"Alto",basePricePerFoot:1.8,boxPrice:3.6,lengthPrice:6.72,chopPrice:7.72},{itemNumber:"436350",width:'1 5/8"',boxQty:143,collection:"Brooklyn",basePricePerFoot:2.29,boxPrice:3.66,lengthPrice:6.08,chopPrice:7.08},{itemNumber:"437500",width:'1 3/16"',boxQty:215,collection:"Alto",basePricePerFoot:2.03,boxPrice:3.6,lengthPrice:7.22,chopPrice:8.22},{itemNumber:"437510",width:'1 3/16"',boxQty:180,collection:"Alto",basePricePerFoot:2.03,boxPrice:3.6,lengthPrice:7.22,chopPrice:8.22},{itemNumber:"438120",width:'2"',boxQty:150,collection:"Dresden",basePricePerFoot:6.78,boxPrice:10.26,lengthPrice:15.05,chopPrice:16.05},{itemNumber:"439082",width:'2 1/16"',boxQty:126,collection:"Soho",basePricePerFoot:4.42,boxPrice:7.58,lengthPrice:11.4,chopPrice:12.4},{itemNumber:"440240",width:'1 3/8"',boxQty:190,collection:"Java",basePricePerFoot:7.59,boxPrice:11.23,lengthPrice:18.27,chopPrice:19.27},{itemNumber:"440951",width:'2"',boxQty:92,collection:"Cezanne",basePricePerFoot:18.08,boxPrice:25.65,lengthPrice:29.81,chopPrice:30.81},{itemNumber:"441075",width:'2 1/16"',boxQty:150,collection:"Prague",basePricePerFoot:9.48,boxPrice:13.9,lengthPrice:23.98,chopPrice:24.98},{itemNumber:"441077",width:'2 1/16"',boxQty:155,collection:"Prague",basePricePerFoot:9.44,boxPrice:13.82,lengthPrice:23.86,chopPrice:24.86},{itemNumber:"442650",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.76,boxPrice:8.08,lengthPrice:11.57,chopPrice:12.57},{itemNumber:"442660",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.76,boxPrice:8.07,lengthPrice:11.56,chopPrice:12.56},{itemNumber:"442670",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.67,boxPrice:7.74,lengthPrice:11.04,chopPrice:12.04},{itemNumber:"520750",width:'2 1/2"',boxQty:94,collection:"Sofia",basePricePerFoot:11.07,boxPrice:16.3,lengthPrice:24.59,chopPrice:25.59},{itemNumber:"520751",width:'2 1/2"',boxQty:59,collection:"Sofia",basePricePerFoot:10.92,boxPrice:16.43,lengthPrice:24.78,chopPrice:25.78},{itemNumber:"520752",width:'2 1/2"',boxQty:100,collection:"Sofia",basePricePerFoot:10.56,boxPrice:16.38,lengthPrice:23.41,chopPrice:24.41}];function Fo(o){let e=o.startsWith("larson-")?o.substring(7):o;return ko.find(t=>t.itemNumber===e)||null}import Qn from"express";H();Q();import{eq as Yn}from"drizzle-orm";var gr=class{async fetchLarsonJuhlFrames(){try{console.log("Fetching frames from Larson-Juhl API...");let e=await this.getEnhancedLarsonFrames();return console.log(`Retrieved ${e.length} frames from Larson-Juhl API`),e}catch(e){throw console.error("Error fetching Larson-Juhl frames:",e),e}}async getEnhancedLarsonFrames(){let{vendorApiService:e}=await Promise.resolve().then(()=>(st(),_t));return(await e.fetchLarsonCatalog()).map(r=>({id:r.id,name:r.name,manufacturer:r.vendor,material:r.material,width:r.width,depth:r.depth,price:r.price,catalogImage:r.imageUrl||"",color:r.color,edgeTexture:"",corner:""}))}async fetchNielsenFrames(){try{console.log("Fetching frames from Nielsen Bainbridge API...");let e=await this.getEnhancedNielsenFrames();return console.log(`Retrieved ${e.length} frames from Nielsen API`),e}catch(e){throw console.error("Error fetching Nielsen frames:",e),e}}async getEnhancedNielsenFrames(){let{vendorApiService:e}=await Promise.resolve().then(()=>(st(),_t));return(await e.fetchBellaCatalog()).map(r=>({id:r.id,name:r.name,manufacturer:r.vendor,material:r.material,width:r.width,depth:r.depth,price:r.price,catalogImage:r.imageUrl||"",color:r.color,edgeTexture:"",corner:""}))}async fetchRomaFrames(){try{console.log("Fetching frames from Roma API...");let e=await this.getEnhancedRomaFrames();return console.log(`Retrieved ${e.length} frames from Roma API`),e}catch(e){throw console.error("Error fetching Roma frames:",e),e}}async getEnhancedRomaFrames(){let{vendorApiService:e}=await Promise.resolve().then(()=>(st(),_t));return(await e.fetchRomaCatalog()).map(r=>({id:r.id,name:r.name,manufacturer:r.vendor,material:r.material,width:r.width,depth:r.depth,price:r.price,catalogImage:r.imageUrl||"",color:r.color,edgeTexture:"",corner:""}))}async fetchAllVendorFrames(){try{let[e,t,r]=await Promise.all([this.fetchLarsonJuhlFrames(),this.fetchNielsenFrames(),this.fetchRomaFrames()]),a=[...e,...t,...r];return console.log(`Retrieved ${a.length} total frames from all vendor APIs`),a}catch(e){throw console.error("Error fetching frames from all vendors:",e),e}}async searchFramesByItemNumber(e){try{console.log(`Searching for frames with item number: ${e}`);let r=(await this.fetchAllVendorFrames()).filter(a=>(a.id.split("-")[1]||"")===e);return console.log(`Found ${r.length} frames matching item number: ${e}`),r}catch(t){throw console.error(`Error searching for frames with item number ${e}:`,t),t}}async syncFramesWithDatabase(){try{console.log("Syncing frames from vendor APIs to database...");let e=await this.fetchAllVendorFrames(),t=await m.select().from(O),r=new Set(t.map(s=>s.id)),a=e.filter(s=>!r.has(s.id));if(a.length>0){console.log(`Adding ${a.length} new frames to database`);for(let s of a)await m.insert(O).values(s)}console.log(`Updating ${t.length} existing frames in database`);for(let s of e)r.has(s.id)&&await m.update(O).set({name:s.name,manufacturer:s.manufacturer,material:s.material,width:s.width,depth:s.depth,price:s.price,catalogImage:s.catalogImage,edgeTexture:s.edgeTexture,corner:s.corner}).where(Yn(O.id,s.id));console.log("Frame database sync completed successfully")}catch(e){throw console.error("Error syncing frames with database:",e),e}}},Oo=new gr;var Ao=Qn.Router();Ao.get("/all",async(o,e)=>{try{let t=await Oo.getAllFrames();e.json(Array.isArray(t)?t:[])}catch(t){console.error("Error fetching vendor catalog:",t),e.json([])}});var _o=Ao;import{Router as Jn}from"express";J();import Ro from"node-fetch";var fr=class{constructor(){k(this,"dialpadApiKey");k(this,"dialpadBaseUrl");k(this,"fromNumber");this.dialpadApiKey=process.env.DIALPAD_API_KEY||"",this.dialpadBaseUrl=process.env.DIALPAD_API_URL||"https://dialpad.com/api/v2",this.fromNumber=process.env.DIALPAD_FROM_NUMBER||""}isConfigured(){return!!(this.dialpadApiKey&&this.fromNumber)}getConfiguration(){return{configured:this.isConfigured(),message:this.isConfigured()?"Dialpad voice service is ready":"Missing DIALPAD_API_KEY or DIALPAD_FROM_NUMBER environment variables",provider:"Dialpad",fromNumber:this.fromNumber?this.fromNumber.substring(0,6)+"***":"Not set"}}async makeCall(e,t){if(!this.isConfigured())throw new Error("Dialpad voice service is not configured");try{console.log(`Initiating Dialpad call to ${e}`);let r=await Ro(`${this.dialpadBaseUrl}/calls`,{method:"POST",headers:{Authorization:`Bearer ${this.dialpadApiKey}`,"Content-Type":"application/json"},body:JSON.stringify({to:e,from:this.fromNumber,text:t,voice:"alice",language:"en-US"})});if(!r.ok){let s=await r.text();throw new Error(`Dialpad API error: ${r.status} - ${s}`)}let a=await r.json();return{callId:a.call_id||a.id||"unknown",status:a.status||"initiated",message:"Call initiated successfully"}}catch(r){throw console.error("Error making Dialpad call:",r),new Error(`Failed to make call: ${r instanceof Error?r.message:"Unknown error"}`)}}async getCallStatus(e){if(!this.isConfigured())throw new Error("Dialpad voice service is not configured");try{let t=await Ro(`${this.dialpadBaseUrl}/calls/${e}`,{method:"GET",headers:{Authorization:`Bearer ${this.dialpadApiKey}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error(`Failed to get call status: ${t.status}`);return await t.json()}catch(t){throw console.error("Error getting call status:",t),t}}async makeOrderStatusCall(e,t,r){let a=`Hello! This is Jay's Frames calling about your order ${t}. 
                    Your order status has been updated to: ${r}. 
                    Please call us back at your convenience if you have any questions. Thank you!`;return this.makeCall(e,a)}async makeOrderReadyCall(e,t){let r=`Hello! This is Jay's Frames calling to let you know that your order ${t} is ready for pickup. 
                    Please come by during our business hours to collect your custom framing. Thank you!`;return this.makeCall(e,r)}},$=new fr;var _e=class{async handleOrderEvent(e){try{if(!e.customerPhone||e.customerPhone.length<10){console.log(`Skipping notification for order ${e.orderNumber}: No valid phone number`);return}let t=this.formatPhoneNumber(e.customerPhone);switch(console.log(`Processing notification for order ${e.orderNumber}, event: ${e.eventType}`),e.eventType){case"order_placed":await this.sendOrderConfirmation(e,t);break;case"payment_received":await this.sendPaymentConfirmation(e,t);break;case"production_started":await this.sendProductionStarted(e,t);break;case"frame_cut":case"mat_cut":await this.sendProgressUpdate(e,t);break;case"assembly_complete":await this.sendAssemblyComplete(e,t);break;case"ready_for_pickup":await this.sendPickupReady(e,t);break;case"payment_due":await this.sendPaymentReminder(e,t);break;case"pickup_overdue":await this.sendPickupReminder(e,t);break;default:console.log(`Unknown event type: ${e.eventType}`)}}catch(t){console.error(`Error handling order event for ${e.orderNumber}:`,t)}}async sendOrderConfirmation(e,t){let r=`Hello ${e.customerName}! This is Jay's Frames calling to confirm your order ${e.orderNumber} has been received and is being processed. Thank you for choosing us for your custom framing needs!`;await $.makeCall(t,r),console.log(`Order confirmation call sent for ${e.orderNumber}`)}async sendPaymentConfirmation(e,t){let r=`Hello ${e.customerName}! This is Jay's Frames calling to confirm we've received your payment for order ${e.orderNumber}. Your custom framing project will now begin production. Thank you for your business!`;await $.makeCall(t,r),console.log(`Payment confirmation call sent for ${e.orderNumber}`)}async sendProductionStarted(e,t){let r=e.metadata?.estimatedCompletion||"5-7 business days",a=`Hello ${e.customerName}! This is Jay's Frames calling with an update on your order ${e.orderNumber}. We're excited to let you know that production has started on your custom framing project. Estimated completion time is ${r}. Thank you for your patience!`;await $.makeCall(t,a),console.log(`Production started call sent for ${e.orderNumber}`)}async sendProgressUpdate(e,t){let a={frame_cut:"frame cutting is complete",mat_cut:"mat cutting is complete"}[e.eventType]||e.eventType,s=`Hello ${e.customerName}! This is Jay's Frames with an update on your order ${e.orderNumber}. We're happy to report that ${a} and your project is progressing well. Thank you for your patience!`;await $.makeCall(t,s),console.log(`Progress update call sent for ${e.orderNumber}`)}async sendAssemblyComplete(e,t){let r=`Hello ${e.customerName}! This is Jay's Frames with exciting news. Your custom framing order ${e.orderNumber} has been assembled and is in final quality inspection. We'll call you soon when it's ready for pickup!`;await $.makeCall(t,r),console.log(`Assembly complete call sent for ${e.orderNumber}`)}async sendPickupReady(e,t){await $.makeOrderReadyCall(e.customerPhone,e.orderNumber),console.log(`Pickup ready call sent for ${e.orderNumber}`)}async sendPaymentReminder(e,t){let r=e.metadata?.amount||0,a=`Hello ${e.customerName}, this is Jay's Frames calling about your order ${e.orderNumber}. You have an outstanding balance of $${r}. Please contact us at your earliest convenience to complete your payment. Thank you for your prompt attention to this matter.`;await $.makeCall(t,a),console.log(`Payment reminder call sent for ${e.orderNumber}`)}async sendPickupReminder(e,t){let r=e.metadata?.daysWaiting||7,a=`Hello ${e.customerName}, this is Jay's Frames calling about your completed order ${e.orderNumber}. Your custom framing has been ready for pickup for ${r} days. Please come by during our business hours to collect your order. Thank you!`;await $.makeCall(t,a),console.log(`Pickup reminder call sent for ${e.orderNumber}`)}formatPhoneNumber(e){let t=e.replace(/\D/g,"");return t.length===10?`+1${t}`:e.startsWith("+")?e:`+${t}`}async scheduleDelayedNotification(e,t){setTimeout(async()=>{await this.handleOrderEvent(e)},t*60*1e3),console.log(`Scheduled notification for order ${e.orderNumber} in ${t} minutes`)}async sendBulkNotifications(e){console.log(`Processing ${e.length} bulk notifications`);for(let t of e)try{await this.handleOrderEvent(t),await new Promise(r=>setTimeout(r,2e3))}catch(r){console.error(`Failed to send notification for order ${t.orderNumber}:`,r)}}},nt=new _e;var Eo=new _e;async function No(o,e){try{let{orderId:t,status:r,updatedBy:a,timestamp:s,previousStatus:n}=o.body;if(console.log(`Received Kanban webhook for order ${t}: ${n} \u2192 ${r}`),!t||!r)return e.status(400).json({success:!1,error:"Missing required fields: orderId and status"});if(a==="Jays Frames POS")return console.log("Skipping webhook - update originated from POS system"),e.json({success:!0,message:"Update originated from POS, no notification needed"});let c=await y.updateOrder(parseInt(t),{productionStatus:r,lastStatusChange:new Date});if(!c)return e.status(404).json({success:!1,error:"Order not found"});let i=!1;try{if(c.customerId){let d=await y.getCustomer(c.customerId);if(d&&d.phone){let h=null;switch(r){case"in_production":case"production_started":h="production_started";break;case"frame_cut":case"frame_cutting_complete":h="frame_cut";break;case"mat_cut":case"mat_cutting_complete":h="mat_cut";break;case"assembly_complete":case"assembled":h="assembly_complete";break;case"ready_for_pickup":case"completed":case"ready":h="ready_for_pickup";break}h&&(await Eo.handleOrderEvent({orderId:c.id.toString(),orderNumber:`ORD-${c.id}`,customerName:d.name,customerPhone:d.phone,eventType:h}),console.log(`Kanban webhook notification sent for order ${c.id}: ${r}`),i=!0)}}}catch(d){console.error("Failed to send Kanban webhook notification:",d)}e.json({success:!0,message:"Status update processed successfully",orderId:c.id,newStatus:r,notificationSent:i})}catch(t){console.error("Error processing Kanban webhook:",t),e.status(500).json({success:!1,error:t.message||"Failed to process webhook"})}}async function Mo(o,e){try{let{orderId:t,eventType:r,customerPhone:a,customerName:s,metadata:n}=o.body;if(console.log(`Received order update webhook: ${r} for order ${t}`),!t||!r)return e.status(400).json({success:!1,error:"Missing required fields: orderId and eventType"});let c=a,i=s;if(!c||!i){let d=await y.getOrder(parseInt(t));if(d&&d.customerId){let h=await y.getCustomer(d.customerId);h&&(c=c||h.phone,i=i||h.name)}}if(!c||!i)return e.status(400).json({success:!1,error:"Customer information not found"});await Eo.handleOrderEvent({orderId:t.toString(),orderNumber:`ORD-${t}`,customerName:i,customerPhone:c,eventType:r,metadata:n||{}}),console.log(`Webhook notification sent for order ${t}: ${r}`),e.json({success:!0,message:"Notification sent successfully",orderId:t,eventType:r})}catch(t){console.error("Error processing order update webhook:",t),e.status(500).json({success:!1,error:t.message||"Failed to process webhook"})}}async function jo(o,e){try{console.log("Stripe webhook received"),e.json({received:!0})}catch(t){console.error("Stripe webhook error:",t),e.status(500).json({success:!1,error:t.message||"Webhook processing failed"})}}async function Do(o,e){e.json({success:!0,message:"Webhook endpoints are operational",timestamp:new Date().toISOString(),endpoints:{kanban:"/api/webhooks/kanban",orderUpdate:"/api/webhooks/order-update",stripe:"/api/webhooks/stripe",health:"/api/webhooks/health"}})}import Zn from"express";var it=Jn();it.post("/stripe",Zn.raw({type:"application/json"}),jo);it.post("/kanban",No);it.post("/order-update",Mo);it.get("/health",Do);var Lo=it;J();import{Router as Xn}from"express";import Au from"express-rate-limit";import Ru from"helmet";import Nu from"csurf";import ju from"cookie-parser";function te(o,e,t){console.log("verifyApiKey called for:",o.path),t()}var Re=Xn();Re.get("/orders",te,async(o,e)=>{try{let r=(await y.getAllOrders()).map(a=>({id:a.id,customerName:a.customerName,customerPhone:a.customerPhone,customerEmail:a.customerEmail,artworkTitle:a.artworkTitle,artworkWidth:a.artworkWidth,artworkHeight:a.artworkHeight,frameId:a.frameId,matId:a.matId,glassType:a.glassType,productionStatus:a.productionStatus,totalPrice:a.totalPrice,createdAt:a.createdAt,scheduledDate:a.scheduledDate,qrCode:a.qrCode,notes:a.notes}));e.json({success:!0,orders:r,count:r.length})}catch(t){console.error("Error fetching orders for hub:",t),e.status(500).json({success:!1,error:t.message||"Failed to fetch orders"})}});Re.get("/orders/:id",te,async(o,e)=>{try{let t=parseInt(o.params.id),r=await y.getOrder(t);if(!r)return e.status(404).json({success:!1,error:"Order not found"});e.json({success:!0,order:{id:r.id,customerName:r.customerName,customerPhone:r.customerPhone,customerEmail:r.customerEmail,artworkTitle:r.artworkTitle,artworkWidth:r.artworkWidth,artworkHeight:r.artworkHeight,frameId:r.frameId,matId:r.matId,glassType:r.glassType,productionStatus:r.productionStatus,totalPrice:r.totalPrice,createdAt:r.createdAt,scheduledDate:r.scheduledDate,qrCode:r.qrCode,notes:r.notes}})}catch(t){console.error("Error fetching order for hub:",t),e.status(500).json({success:!1,error:t.message||"Failed to fetch order"})}});Re.patch("/orders/:id/status",te,async(o,e)=>{try{let t=parseInt(o.params.id),{status:r,notes:a}=o.body,s=await y.updateOrder(t,{productionStatus:r,notes:a||void 0});if(!s)return e.status(404).json({success:!1,error:"Order not found"});e.json({success:!0,message:"Order status updated successfully",order:s})}catch(t){console.error("Error updating order status from hub:",t),e.status(500).json({success:!1,error:t.message||"Failed to update order status"})}});Re.get("/materials",te,async(o,e)=>{try{let t=await y.getAllMaterialOrders();e.json({success:!0,materialOrders:t,count:t.length})}catch(t){console.error("Error fetching material orders for hub:",t),e.status(500).json({success:!1,error:t.message||"Failed to fetch material orders"})}});Re.post("/webhook",te,async(o,e)=>{try{let{event:t,data:r}=o.body;switch(console.log("Received hub webhook:",t,r),t){case"order.status_changed":r.orderId&&r.status&&await y.updateOrder(r.orderId,{productionStatus:r.status,notes:r.notes||void 0});break;case"material.status_changed":r.materialOrderId&&r.status&&await y.updateMaterialOrder(r.materialOrderId,{status:r.status,notes:r.notes||void 0});break;default:console.log("Unknown webhook event:",t)}e.json({success:!0,message:"Webhook processed successfully"})}catch(t){console.error("Error processing hub webhook:",t),e.status(500).json({success:!1,error:t.message||"Failed to process webhook"})}});Re.get("/status",te,async(o,e)=>{try{let t=await y.getAllOrders(),r=await y.getAllMaterialOrders();e.json({success:!0,status:"online",timestamp:new Date().toISOString(),stats:{totalOrders:t.length,totalMaterialOrders:r.length,activeOrders:t.filter(a=>a.productionStatus!=="completed").length}})}catch(t){console.error("Error getting system status for hub:",t),e.status(500).json({success:!1,error:t.message||"Failed to get system status"})}});var hr=Re;import{Router as ti}from"express";async function To(o,e){try{e.setHeader("Content-Type","application/json");let t=Date.now(),r=Math.random().toString(36).substring(2,15),a=`hub_${t}_${r}`;console.log("Hub API Key generated:",a);let s={success:!0,apiKey:a,createdAt:new Date().toISOString(),permissions:["hub:read","hub:write","orders:sync"],message:"Hub API key generated successfully"};return e.status(200).json(s)}catch(t){return console.error("Error generating Hub API key:",t),e.setHeader("Content-Type","application/json"),e.status(500).json({success:!1,error:t.message||"Failed to generate API key"})}}async function $o(o,e){try{let t=process.env.REPL_URL||"https://your-repl-url.replit.dev";e.json({success:!0,connectionInfo:{baseUrl:t,endpoints:{getAllOrders:`${t}/api/hub/orders`,getOrder:`${t}/api/hub/orders/:id`,updateOrderStatus:`${t}/api/hub/orders/:id/status`,getMaterialOrders:`${t}/api/hub/materials`,webhook:`${t}/api/hub/webhook`,status:`${t}/api/hub/status`},authentication:{method:"Bearer Token",header:"Authorization",note:"Use the API key generated from /api/admin/generate-hub-key"},webhookEvents:["order.status_changed","material.status_changed"]}})}catch(t){console.error("Error getting hub connection info:",t),e.status(500).json({success:!1,error:t.message||"Failed to get connection info"})}}var yr=ti();yr.post("/generate-hub-key",To);yr.get("/hub-connection-info",$o);var Rt=yr;J();var qo=async(o,e)=>{try{let t=await y.getMaterialsPickList();(!t||t.length===0)&&(t=[{id:"mat-001",name:"White Core Mat 16x20",type:"mat",supplier:"Crescent",status:"pending",quantity:"5",priority:"medium",notes:"For order #1234",price:"12.50",orderDate:null,receiveDate:null,supplierName:"Crescent"},{id:"frame-001",name:'Oak Frame 1.5" - 8ft',type:"frame",supplier:"Larson-Juhl",status:"ordered",quantity:"2",priority:"high",notes:"Rush order",price:"45.00",orderDate:new Date().toISOString(),receiveDate:null,supplierName:"Larson-Juhl"},{id:"glass-001",name:"Museum Glass 16x20",type:"glass",supplier:"Tru Vue",status:"received",quantity:"3",priority:"low",notes:"In stock",price:"28.99",orderDate:new Date(Date.now()-864e5).toISOString(),receiveDate:new Date().toISOString(),supplierName:"Tru Vue"}]),e.json({success:!0,data:t,message:"Materials loaded successfully"})}catch(t){console.error("Error in getMaterialsPickList:",t),e.status(500).json({message:t.message,materials:[]})}},Bo=async(o,e)=>{try{let r=(await y.getMaterialsPickList()||[]).reduce((a,s)=>{let n=s.supplier||"Unknown Supplier";return a[n]||(a[n]=[]),a[n].push(s),a},{});e.json(r)}catch(t){console.error("Error in getMaterialsBySupplier:",t),e.status(500).json({message:t.message,suppliers:{}})}},Wo=async(o,e)=>{try{let t=parseInt(o.params.orderId);if(isNaN(t))return e.status(400).json({message:"Invalid order ID",materials:[]});let r=await y.getMaterialsForOrder(t);e.json(r||[])}catch(t){console.error("Error in getMaterialsForOrder:",t),e.status(500).json({message:t.message,materials:[]})}},Uo=async(o,e)=>{try{let t=o.params.id,r;if(o.body.data)r=o.body.data;else{let{status:n,notes:c,orderDate:i,receiveDate:d,supplierName:h}=o.body;r={status:n,notes:c,orderDate:i,receiveDate:d,supplierName:h}}let a=Object.fromEntries(Object.entries(r).filter(([n,c])=>c!==void 0));console.log("Updating material order with data:",a);let s=await y.updateMaterialOrder(t,a);e.json(s)}catch(t){console.error("Error updating material:",t),e.status(500).json({message:t.message})}},Ho=async(o,e)=>{try{let{materialIds:t}=o.body;if(!t||!Array.isArray(t)||t.length===0)return e.status(400).json({message:"No materials selected"});let r=await y.createPurchaseOrder(t);e.status(201).json(r)}catch(t){e.status(500).json({message:t.message})}},Go=async(o,e)=>{try{let t=await y.getMaterialsPickList(),r=Array.from(new Set((t||[]).map(a=>a.type).filter(Boolean)));e.json(r.length>0?r:["frame","mat","glass","hardware"])}catch(t){console.error("Error in getMaterialTypes:",t),e.status(500).json({message:t.message,types:["frame","mat","glass","hardware"]})}},Ko=async(o,e)=>{try{let t=await y.getMaterialsPickList(),r=Array.from(new Set((t||[]).map(a=>a.supplier).filter(Boolean)));e.json(r.length>0?r:["Larson-Juhl","Roma","Bella"])}catch(t){console.error("Error in getMaterialSuppliers:",t),e.status(500).json({message:t.message,suppliers:["Larson-Juhl","Roma","Bella"]})}};J();import zo from"axios";H();Q();import{eq as Ju}from"drizzle-orm";var ri=new _e,ne=process.env.KANBAN_API_URL||"https://kanban-app-url.replit.app",Se=process.env.KANBAN_API_KEY;async function Vo(o){try{if(!Se||!ne){console.log("Kanban integration not configured, skipping sync");return}let e={orderId:o.id,customerName:o.customerName||"Unknown Customer",artworkTitle:o.artworkDescription,frameSize:`${o.artworkWidth}x${o.artworkHeight}`,status:o.productionStatus||"order_processed",stage:"pending",priority:"standard",dueDate:o.dueDate,createdAt:o.createdAt,estimatedCompletion:o.estimatedCompletionDays?new Date(Date.now()+o.estimatedCompletionDays*24*60*60*1e3).toISOString():null,materials:{frameType:o.frameId||"Unknown",matColor:o.matColorId||"White",glass:o.glassOptionId||"Regular"}},t=await zo.post(`${ne}/api/orders`,e,{headers:{Authorization:`Bearer ${Se}`,"Content-Type":"application/json"},timeout:5e3});t.data&&t.data.success&&console.log(`Order ${o.id} synced to Kanban successfully`)}catch(e){console.error(`Failed to sync order ${o.id} to Kanban:`,e.message)}}async function Yo(o,e,t){try{if(!Se||!ne){console.log("Kanban integration not configured, skipping status update");return}let r=await zo.post(`${ne}/api/orders/${o}/status`,{status:e,stage:e,notes:t||`Status updated to ${e}`,updatedBy:"Jays Frames POS",timestamp:new Date().toISOString()},{headers:{Authorization:`Bearer ${Se}`,"Content-Type":"application/json"},timeout:5e3});r.data&&r.data.success&&console.log(`Order ${o} status updated in Kanban to ${e}`)}catch(r){console.error(`Failed to update order ${o} status in Kanban:`,r.message)}}async function Qo(o,e){try{console.log("OrdersController: Fetching all orders from database..."),console.log("DATABASE_URL exists:",!!process.env.DATABASE_URL),console.log("NODE_ENV:","production");let{pool:t}=await Promise.resolve().then(()=>(H(),ao)),r=await t.query("SELECT 1 as test");console.log("Database connection test:",r.rows);let a=await t.query(`
      SELECT 
        o.*,
        c.name as customer_name,
        c.email as customer_email,
        c.phone as customer_phone
      FROM orders o
      LEFT JOIN customers c ON o.customer_id = c.id
      ORDER BY o.created_at DESC
    `);console.log("OrdersController: Raw SQL query found",a.rows.length,"orders");let s=a.rows.map(n=>({...n,customer:n.customer_name?{id:n.customer_id,name:n.customer_name,email:n.customer_email,phone:n.customer_phone}:null,id:parseInt(n.id),customerId:parseInt(n.customer_id),artworkWidth:parseFloat(n.artwork_width)||0,artworkHeight:parseFloat(n.artwork_height)||0,total:n.total||"0.00"}));console.log("OrdersController: Returning",s.length,"orders to frontend"),e.json({success:!0,orders:s,source:"raw_sql",count:s.length})}catch(t){console.error("OrdersController: Error fetching orders:",t),console.error("Error stack:",t.stack),e.status(200).json({success:!1,error:t.message||"Failed to fetch orders",orders:[],count:0})}}async function Jo(o,e){try{let{id:t}=o.params,r=await y.getOrder(parseInt(t));if(!r)return e.status(404).json({success:!1,error:"Order not found"});e.json({success:!0,order:r})}catch(t){console.error("Error fetching order:",t),e.status(500).json({success:!1,error:t.message||"Failed to fetch order"})}}async function Zo(o,e){try{let t=o.body;if(console.log("OrdersController: Creating order with data:",JSON.stringify(t,null,2)),!t.customerId)return console.error("OrdersController: Missing customer ID"),e.status(400).json({success:!1,error:"Customer ID is required",field:"customerId"});if(!t.frameId)return console.error("OrdersController: Missing frame ID"),e.status(400).json({success:!1,error:"Frame selection is required",field:"frameId"});if(!t.matColorId)return console.error("OrdersController: Missing mat color ID"),e.status(400).json({success:!1,error:"Mat color selection is required",field:"matColorId"});if(!t.glassOptionId)return console.error("OrdersController: Missing glass option ID"),e.status(400).json({success:!1,error:"Glass option selection is required",field:"glassOptionId"});if(!t.artworkWidth||!t.artworkHeight)return console.error("OrdersController: Missing artwork dimensions"),e.status(400).json({success:!1,error:"Artwork dimensions are required",field:"artworkDimensions"});t.artworkImage||(console.log("OrdersController: No artwork image provided, using placeholder"),t.artworkImage="placeholder-image.jpg"),(!t.matWidth||isNaN(parseFloat(t.matWidth)))&&(console.log("OrdersController: Invalid mat width, using default of 2 inches"),t.matWidth="2"),t.status=t.status||"pending",t.artworkDescription=t.artworkDescription||"Custom artwork",t.artworkType=t.artworkType||"print",t.subtotal=t.subtotal||"0",t.tax=t.tax||"0",t.total=t.total||"0",console.log("OrdersController: Validated order data, proceeding with creation...");let r=await y.createOrder(t);console.log("OrdersController: Order created successfully with ID:",r.id),setTimeout(async()=>{try{await Vo(r),console.log("OrdersController: Order synced to Kanban successfully")}catch(a){console.log("OrdersController: Kanban sync failed (non-critical):",a)}},100),e.status(201).json({success:!0,order:r,message:"Order created and saved successfully",orderId:r.id,saved:!0})}catch(t){console.error("OrdersController: CRITICAL ERROR creating order:",t),console.error("OrdersController: Error stack:",t.stack);let r="Failed to create order";t.message.includes("duplicate")?r="Duplicate order detected":t.message.includes("constraint")?r="Invalid data provided for order":t.message.includes("foreign key")&&(r="Invalid customer, frame, mat, or glass selection"),e.status(500).json({success:!1,error:r,details:t.message,saved:!1,debug:{originalError:t.message,stack:t.stack?.split(`
`).slice(0,5)}})}}async function Xo(o,e){try{let{id:t}=o.params,r=o.body,a=await y.updateOrder(parseInt(t),r);r.productionStatus&&await Yo(parseInt(t),r.productionStatus),e.json({success:!0,order:a,message:"Order updated successfully"})}catch(t){console.error("Error updating order:",t),e.status(500).json({success:!1,error:t.message||"Failed to update order"})}}async function ea(o,e){try{let{id:t}=o.params,{status:r,notes:a}=o.body;if(!r)return e.status(400).json({success:!1,error:"Status is required"});let s=await y.updateOrder(parseInt(t),{productionStatus:r,lastStatusChange:new Date});try{if(s&&s.customerId){let n=await y.getCustomer(s.customerId);if(n&&n.phone){let c=null;switch(r){case"in_production":c="production_started";break;case"frame_cut":c="frame_cut";break;case"mat_cut":c="mat_cut";break;case"assembly_complete":c="assembly_complete";break;case"ready_for_pickup":c="ready_for_pickup";break}c&&(await ri.handleOrderEvent({orderId:s.id.toString(),orderNumber:`ORD-${s.id}`,customerName:n.name,customerPhone:n.phone,eventType:c}),console.log(`Status change notification sent for order ${s.id}: ${r}`))}}}catch(n){console.error("Failed to send status change notification:",n)}await Yo(parseInt(t),r,a),e.json({success:!0,order:s,message:`Order status updated to ${r}`})}catch(t){console.error("Error updating order status:",t),e.status(500).json({success:!1,error:t.message||"Failed to update order status"})}}async function ta(o,e){try{let{id:t}=o.params;await y.deleteOrder(parseInt(t)),e.json({success:!0,message:"Order deleted successfully"})}catch(t){console.error("Error deleting order:",t),e.status(500).json({success:!1,error:t.message||"Failed to delete order"})}}async function ra(o,e){try{let{orderId:t}=o.params;if(!Se||!ne)return e.json({success:!1,error:"Kanban integration not configured",config:{hasApiKey:!!Se,hasApiUrl:ne}});let r=await y.getOrder(parseInt(t));if(!r)return e.status(404).json({success:!1,error:"Order not found"});await Vo(r),e.json({success:!0,message:`Order ${t} synced to Kanban successfully`,order:{id:r.id,status:r.productionStatus,kanbanUrl:ne}})}catch(t){console.error("Error testing Kanban sync:",t),e.status(500).json({success:!1,error:t.message||"Failed to test Kanban sync"})}}async function oa(o,e){try{e.json({success:!0,status:{configured:!!(Se&&ne),apiUrl:ne,hasApiKey:!!Se,endpoints:{orders:`${ne}/api/orders`,statusUpdate:`${ne}/api/orders/:id/status`}}})}catch(t){e.status(500).json({success:!1,error:t.message||"Failed to get Kanban status"})}}async function aa(o,e){try{let t=await y.getAllOrderGroups();e.json({success:!0,orderGroups:t,count:t.length})}catch(t){console.error("Error fetching order groups:",t),e.status(500).json({success:!1,error:t.message||"Failed to fetch order groups"})}}async function sa(o,e){try{let t=o.body;t.paymentStatus||(t.paymentStatus="pending"),t.amountPaid||(t.amountPaid=0);let r=await y.createOrderGroup(t);e.json({success:!0,orderGroup:r})}catch(t){console.error("Error creating order group:",t),e.status(500).json({success:!1,message:"Failed to create order group"})}}async function na(o,e){try{let{orderGroupId:t}=o.params,{amount:r,paymentMethod:a,notes:s,isDeposit:n}=o.body;if(!t||isNaN(parseInt(t)))return e.status(400).json({success:!1,message:"Valid order group ID is required"});if(!r||isNaN(parseFloat(r))||parseFloat(r)<=0)return e.status(400).json({success:!1,message:"Valid payment amount is required"});let c=parseInt(t),i=parseFloat(r),d=await y.getOrderGroup(c);if(!d)return e.status(404).json({success:!1,message:"Order group not found"});let h=parseFloat(d.total),u=parseFloat(d.amountPaid||"0")+i,l=h-u,f="partial";u>=h?f="paid":u===0&&(f="pending");let b={amountPaid:u.toString(),balanceDue:Math.max(0,l).toString(),paymentStatus:f,paymentMethod:a||d.paymentMethod};n&&(b.depositAmount=i.toString()),f==="paid"&&(b.paidAt=new Date),s&&(b.notes=`${d.notes||""}
Payment: $${i} via ${a} - ${s}`),await y.updateOrderGroup(c,b),e.json({success:!0,message:`Payment of $${i} processed successfully`,amountPaid:u,balanceDue:Math.max(0,l),paymentStatus:f})}catch(t){console.error("Error processing partial payment:",t),e.status(500).json({success:!1,message:"Failed to process payment",error:t.message})}}async function ia(o,e){try{let{orderGroupId:t}=o.params,{paymentTerms:r,notes:a}=o.body;if(!t||isNaN(parseInt(t)))return e.status(400).json({success:!1,message:"Valid order group ID is required"});let s=parseInt(t),n=await y.getOrderGroup(s);if(!n)return e.status(404).json({success:!1,message:"Order group not found"});let c={paymentStatus:"deferred",finalPaymentDue:!0,balanceDue:n.total,amountPaid:"0"};r&&(c.notes=`${n.notes||""}
Payment Terms: ${r}`),a&&(c.notes=`${c.notes||n.notes||""}
${a}`),await y.updateOrderGroup(s,c),e.json({success:!0,message:"Payment deferred until completion",paymentStatus:"deferred"})}catch(t){console.error("Error deferring payment:",t),e.status(500).json({success:!1,message:"Failed to defer payment",error:t.message})}}Ue();import{Router as pi}from"express";Ue();var Ee=pi();Ee.get("/orders/:id",te,wr);Ee.get("/orders",te,Pr);Ee.patch("/orders/:id/status",te,Sr);Ee.post("/webhook",te,vr);Ee.get("/test",Ir);Ee.post("/configure-kanban",xr);var da=Ee;import{Router as gi}from"express";J();var re=gi();re.get("/orders",Qo);re.get("/orders/:id",Jo);re.post("/orders",Zo);re.patch("/orders/:id",Xo);re.patch("/orders/:id/status",ea);re.delete("/orders/:id",ta);re.post("/orders/:id/send-update",async(o,e)=>{try{let t=parseInt(o.params.id),r=await y.getOrder(t);if(!r)return e.status(404).json({success:!1,error:"Order not found"});if(!r.customerId)return e.status(400).json({success:!1,error:"Order has no customer"});let a=await y.getCustomer(r.customerId);if(!a)return e.status(404).json({success:!1,error:"Customer not found"});await y.createCustomerNotification({customerId:a.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:`Order #${r.id} Update`,message:`Your order is currently ${r.productionStatus.replace("_"," ")}. We'll keep you updated on the progress.`,successful:!0}),e.json({success:!0,message:"Customer notification sent successfully"})}catch(t){console.error("Error sending customer update:",t),e.status(500).json({success:!1,error:t.message||"Failed to send customer update"})}});re.post("/orders/:orderId/test-kanban-sync",ra);re.get("/kanban/status",oa);re.get("/order-groups",aa);re.post("/order-groups",sa);var ma=re;import{Router as yi}from"express";H();Q();import{eq as fi,desc as hi}from"drizzle-orm";async function pa(o,e){try{let t=await m.select().from(A).orderBy(hi(A.createdAt));return e.status(200).json(t)}catch(t){return console.error("Error fetching customers:",t),e.status(500).json({message:"Error fetching customers"})}}async function ga(o,e){try{let{id:t}=o.params,r=parseInt(t);if(isNaN(r))return e.status(400).json({message:"Invalid customer ID"});let a=await m.select().from(A).where(fi(A.id,r)).limit(1);return a.length===0?e.status(404).json({message:"Customer not found"}):e.status(200).json(a[0])}catch(t){return console.error("Error fetching customer:",t),e.status(500).json({message:"Error fetching customer"})}}async function fa(o,e){try{let t=Bt.parse(o.body),[r]=await m.insert(A).values(t).returning();return e.status(201).json(r)}catch(t){return console.error("Error creating customer:",t),t.name==="ZodError"?e.status(400).json({message:"Invalid customer data",errors:t.errors}):e.status(500).json({message:"Error creating customer"})}}var Et=yi();Et.get("/customers",pa);Et.get("/customers/:id",ga);Et.post("/customers",fa);var ha=Et;import{Router as bi}from"express";H();Q();import{eq as ut}from"drizzle-orm";async function ya(o,e){try{let t=await m.select().from(D);return e.status(200).json(t)}catch(t){return console.error("Error fetching inventory locations:",t),e.status(500).json({message:"Error fetching inventory locations",details:t.message})}}async function ba(o,e){try{let{id:t}=o.params,r=await m.select().from(D).where(ut(D.id,parseInt(t))).limit(1);return r.length===0?e.status(404).json({message:"Inventory location not found"}):e.status(200).json(r[0])}catch(t){return console.error("Error fetching inventory location:",t),e.status(500).json({message:"Error fetching inventory location",details:t.message})}}async function wa(o,e){try{let t=vt.parse(o.body),[r]=await m.insert(D).values(t).returning();return e.status(201).json(r)}catch(t){return console.error("Error creating inventory location:",t),t.name==="ZodError"?e.status(400).json({message:"Invalid location data",errors:t.errors}):e.status(500).json({message:"Error creating inventory location",details:t.message})}}async function Pa(o,e){try{let{id:t}=o.params,r=vt.parse(o.body),[a]=await m.update(D).set(r).where(ut(D.id,parseInt(t))).returning();return a?e.status(200).json(a):e.status(404).json({message:"Inventory location not found"})}catch(t){return console.error("Error updating inventory location:",t),t.name==="ZodError"?e.status(400).json({message:"Invalid location data",errors:t.errors}):e.status(500).json({message:"Error updating inventory location",details:t.message})}}async function Sa(o,e){try{let{id:t}=o.params,r=await m.select({count:m.fn.count()}).from(L).where(ut(L.locationId,parseInt(t)));return parseInt(r[0].count)>0?e.status(400).json({message:"Cannot delete location with assigned items. Move items to another location first."}):(await m.delete(D).where(ut(D.id,parseInt(t))).returning({id:D.id})).length===0?e.status(404).json({message:"Inventory location not found"}):e.status(200).json({message:"Inventory location deleted successfully"})}catch(t){return console.error("Error deleting inventory location:",t),e.status(500).json({message:"Error deleting inventory location",details:t.message})}}async function va(o,e){try{let t=await m.select({...L,locationName:D.name}).from(L).leftJoin(D,ut(L.locationId,D.id));return e.status(200).json(t||[])}catch(t){return console.error("Error fetching inventory items:",t),e.status(500).json({message:"Error fetching inventory items",details:t.message})}}async function Ia(o,e){try{return e.status(200).json([])}catch(t){return console.error("Error fetching low stock items:",t),e.status(500).json({message:"Error fetching low stock items",details:t.message})}}async function xa(o,e){try{let t=await m.select().from(K);return e.status(200).json(t||[])}catch(t){return console.error("Error fetching suppliers:",t),e.status(500).json({message:"Error fetching suppliers",details:t.message})}}var me=bi();me.get("/inventory/locations",ya);me.get("/inventory/locations/:id",ba);me.post("/inventory/locations",wa);me.put("/inventory/locations/:id",Pa);me.delete("/inventory/locations/:id",Sa);me.get("/inventory/items",va);me.get("/inventory/items/low-stock",Ia);me.get("/inventory/suppliers",xa);var Ca=me;import{Router as Ii}from"express";import{parseString as wi}from"xml2js";import{promisify as Pi}from"util";var Si=Pi(wi),Cr=class{async parseVendorXmlPriceSheet(e){try{console.log("Parsing vendor XML price sheet...");let t=await Si(e),r=[];if(t.catalog?.items?.item){let a=Array.isArray(t.catalog.items.item)?t.catalog.items.item:[t.catalog.items.item];for(let s of a){let n={itemNumber:this.extractValue(s.sku||s.itemNumber||s.id),description:this.extractValue(s.description||s.name),width:this.extractValue(s.width),collection:this.extractValue(s.collection||s.series),manufacturer:this.extractValue(s.manufacturer||s.vendor||"Unknown"),wholesalePrice:this.extractNumericValue(s.wholesalePrice||s.cost||s.price),retailPrice:this.extractNumericValue(s.retailPrice||s.msrp),category:this.extractValue(s.category||s.type),inStock:this.extractBooleanValue(s.inStock||s.available),unitOfMeasure:this.extractValue(s.unitOfMeasure||s.uom||"each")};n.itemNumber&&n.wholesalePrice>0&&r.push(n)}}else if(t.products?.product){let a=Array.isArray(t.products.product)?t.products.product:[t.products.product];for(let s of a){let n={itemNumber:this.extractValue(s.$.id||s.$.sku),description:this.extractValue(s.name?.[0]||s.description?.[0]),width:this.extractValue(s.dimensions?.width?.[0]),collection:this.extractValue(s.collection?.[0]),manufacturer:this.extractValue(s.manufacturer?.[0]||"Unknown"),wholesalePrice:this.extractNumericValue(s.pricing?.wholesale?.[0]||s.cost?.[0]),retailPrice:this.extractNumericValue(s.pricing?.retail?.[0]),category:this.extractValue(s.category?.[0]),inStock:this.extractBooleanValue(s.inventory?.inStock?.[0]),unitOfMeasure:this.extractValue(s.unitOfMeasure?.[0]||"each")};n.itemNumber&&n.wholesalePrice>0&&r.push(n)}}return console.log(`Successfully parsed ${r.length} items from XML price sheet`),r}catch(t){throw console.error("Error parsing XML price sheet:",t),new Error(`Failed to parse XML price sheet: ${t.message}`)}}extractValue(e){return typeof e=="string"?e.trim():Array.isArray(e)&&e.length>0?String(e[0]).trim():e&&typeof e=="object"&&e._?String(e._).trim():""}extractNumericValue(e){let t=this.extractValue(e),r=parseFloat(t.replace(/[^0-9.-]/g,""));return isNaN(r)?0:r}extractBooleanValue(e){let t=this.extractValue(e).toLowerCase();return t==="true"||t==="yes"||t==="1"}convertToFrameFormat(e){return e.map(t=>({id:`vendor-${t.manufacturer.toLowerCase().replace(/\s+/g,"-")}-${t.itemNumber}`,name:`${t.collection?t.collection+" ":""}${t.description}`,manufacturer:t.manufacturer,material:this.inferMaterial(t.description,t.category),width:t.width||"",depth:"",price:t.wholesalePrice.toString(),catalogImage:"",color:this.inferColor(t.description),itemNumber:t.itemNumber,collection:t.collection||"",category:t.category||"",inStock:t.inStock!==!1,unitOfMeasure:t.unitOfMeasure}))}inferMaterial(e,t){let r=e.toLowerCase(),a=t?.toLowerCase()||"";return r.includes("wood")||a.includes("wood")?"wood":r.includes("metal")||a.includes("metal")?"metal":r.includes("plastic")||a.includes("plastic")?"plastic":r.includes("composite")||a.includes("composite")?"composite":"wood"}inferColor(e){let t=e.toLowerCase();return t.includes("black")?"#000000":t.includes("white")?"#FFFFFF":t.includes("brown")?"#8B4513":t.includes("gold")?"#FFD700":t.includes("silver")?"#C0C0C0":t.includes("red")?"#FF0000":t.includes("blue")?"#0000FF":"#8B4513"}},kr=new Cr;H();Q();async function ka(o,e){try{let{xmlContent:t,vendorName:r}=o.body;if(!t)return e.status(400).json({message:"XML content is required"});if(!r)return e.status(400).json({message:"Vendor name is required"});console.log(`Processing XML price sheet for vendor: ${r}`);let a=await kr.parseVendorXmlPriceSheet(t);if(a.length===0)return e.status(400).json({message:"No valid price items found in XML"});let s=kr.convertToFrameFormat(a),n=0,c=0;for(let i of s)try{(await m.select().from(O).where(eq(O.id,i.id)).limit(1)).length>0?(await m.update(O).set({name:i.name,manufacturer:i.manufacturer,material:i.material,width:i.width,price:i.price,color:i.color,updatedAt:new Date}).where(eq(O.id,i.id)),c++):(await m.insert(O).values({id:i.id,name:i.name,manufacturer:i.manufacturer,material:i.material,width:i.width,depth:i.depth,price:i.price,catalogImage:i.catalogImage,color:i.color,createdAt:new Date,updatedAt:new Date}),n++)}catch(d){console.error(`Error processing frame item ${i.id}:`,d)}console.log(`XML price sheet processing complete. Inserted: ${n}, Updated: ${c}`),e.json({message:"XML price sheet processed successfully",vendor:r,totalItems:a.length,inserted:n,updated:c,summary:{priceItems:a.slice(0,5),frameItems:s.slice(0,5)}})}catch(t){console.error("Error processing XML price sheet:",t),e.status(500).json({message:"Failed to process XML price sheet",error:t.message})}}async function Fa(o,e){e.json({supportedFormats:[{name:"Standard Catalog Format",structure:{catalog:{items:{item:[{sku:"item-number",description:"item-description",manufacturer:"vendor-name",wholesalePrice:"price",width:"frame-width",collection:"collection-name"}]}}}},{name:"Products Format",structure:{products:{product:[{$:{id:"item-number"},name:["item-description"],manufacturer:["vendor-name"],pricing:{wholesale:["price"]}}]}}}],requiredFields:["itemNumber","description","manufacturer","wholesalePrice"],optionalFields:["width","collection","retailPrice","category","inStock"]})}function vi(o,e,t){console.log("Auth middleware: Allowing request (authentication not implemented)"),t()}var Oa=vi;var Nt=Ii();Nt.use(Oa);Nt.post("/upload",ka);Nt.get("/formats",Fa);var Aa=Nt;import{Router as ki}from"express";var Ne=9.5;function Mt(o,e){let t=Fo(o);if(!t)return null;let r=t.basePricePerFoot,a=t.chopPrice||t.basePricePerFoot*1.5,s=Math.ceil(e/Ne),n=s*Ne,c=n-e,i=n*r,d=e*a,h;if(e>Ne){let P=Math.floor(e/Ne),M=e-P*Ne;if(M>0){let oe=P*Ne*r+M*a;h={fullSticks:P,chopFootage:M,totalCost:oe,description:`${P} full stick(s) + ${M.toFixed(1)}' chopped`}}}let g=[{method:"length",cost:i},{method:"chop",cost:d},...h?[{method:"mixed",cost:h.totalCost}]:[]],u=g.reduce((P,M)=>M.cost<P.cost?M:P),f=g.reduce((P,M)=>M.cost>P.cost?M:P).cost-u.cost,b="",F;return u.method==="length"?b=`Full sticks are cheaper despite ${c.toFixed(1)}' waste`:u.method==="chop"?b="Chop pricing saves money by avoiding waste":b="Mixed approach optimizes cost by combining full sticks and chopped pieces",e>=0&&e<=4?F="\u{1F3AF} OPTIMAL RANGE: 0-4 feet - Consider chop pricing to avoid waste":e>=10&&e<=14?F="\u{1F3AF} OPTIMAL RANGE: 10-14 feet - Mixed ordering may be most cost-effective":e>4&&e<9.5&&(F="\u{1F4CF} Consider: Close to full stick length, evaluate waste vs chop premium"),{itemNumber:o,footageNeeded:e,lengthOption:{sticksNeeded:s,totalFootage:n,wasteFootage:c,costPerFoot:r,totalCost:i,description:`${s} stick(s) @ ${Ne}' each`},chopOption:{footageNeeded:e,costPerFoot:a,totalCost:d,description:`${e}' chopped to exact length`},mixedOption:h,recommendation:{method:u.method,savings:f,reason:b,alert:F}}}function xi(o,e,t){let r=o+t*2,a=e+t*2;return r*2+a*2}function Ci(o,e,t,r){let s=xi(e,t,r)/12;return Mt(o,s)}function _a(o){return o.map(e=>({...Ci(e.itemNumber,e.artworkWidth,e.artworkHeight,e.matWidth),quantity:e.quantity||1})).filter(Boolean)}function Ra(o){let e=o.reduce((a,s)=>a+s.recommendation.savings*s.quantity,0),t=o.reduce((a,s)=>a+s.quantity,0),r=o.filter(a=>a.recommendation.alert).length;return{totalSavings:e,totalOrders:t,averageSavingsPerOrder:e/t,alertCount:r}}async function Ea(o,e){try{let{itemNumber:t,footageNeeded:r}=o.body;if(!t||!r)return e.status(400).json({error:"Missing required parameters: itemNumber and footageNeeded"});let a=Mt(t,parseFloat(r));if(!a)return e.status(404).json({error:"Item number not found in Larson-Juhl catalog"});e.json(a)}catch(t){console.error("Error optimizing Larson order:",t),e.status(500).json({error:"Internal server error"})}}async function jt(o,e){try{let{itemNumber:t,artworkWidth:r,artworkHeight:a,matWidth:s}=o.body;if(!t||!r||!a||s===void 0)return e.status(400).json({error:"Missing required parameters: itemNumber, artworkWidth, artworkHeight, matWidth"});let n=jt(t,parseFloat(r),parseFloat(a),parseFloat(s));if(!n)return e.status(404).json({error:"Item number not found in Larson-Juhl catalog"});e.json(n)}catch(t){console.error("Error optimizing frame order:",t),e.status(500).json({error:"Internal server error"})}}async function Na(o,e){try{let{orders:t}=o.body;if(!t||!Array.isArray(t))return e.status(400).json({error:"Missing or invalid orders array"});let r=_a(t),a=Ra(r);e.json({optimizations:r,summary:a})}catch(t){console.error("Error batch optimizing orders:",t),e.status(500).json({error:"Internal server error"})}}async function Ma(o,e){try{let{itemNumber:t}=o.params,a=[2,4,6,8,10,12,14,16,18,20].map(s=>{let n=Mt(t,s);return{footage:s,optimization:n}}).filter(s=>s.optimization!==null);if(a.length===0)return e.status(404).json({error:"Item number not found in Larson-Juhl catalog"});e.json({itemNumber:t,analysis:a})}catch(t){console.error("Error generating optimization analysis:",t),e.status(500).json({error:"Internal server error"})}}var dt=ki();dt.post("/optimize/footage",Ea);dt.post("/optimize/frame",jt);dt.post("/optimize/batch",Na);dt.get("/analyze/:itemNumber",Ma);var ja=dt;rt();import Fi from"express";var Fr=Fi.Router();Fr.post("/test-basic",async(o,e)=>{let{to:t,subject:r,message:a}=o.body;if(!t||!r||!a)return e.status(400).json({error:"Missing required fields: to, subject, message"});console.log("SendGrid API Key exists:",!!process.env.SENDGRID_API_KEY),console.log("SendGrid API Key starts with SG.:",process.env.SENDGRID_API_KEY?.startsWith("SG.")),console.log("From email:",process.env.FROM_EMAIL||"noreply@jaysartandframes.com");try{await et({to:t,from:"noreply@jaysartandframes.com",subject:r,text:a,html:`<p>${a}</p>`}),e.json({success:!0,message:"Test email sent successfully!"})}catch(s){console.error("Test email error:",s);let n={message:s.message,hasApiKey:!!process.env.SENDGRID_API_KEY,apiKeyFormat:process.env.SENDGRID_API_KEY?.startsWith("SG.")?"Valid format":"Invalid format",fromEmail:process.env.FROM_EMAIL||"noreply@jaysartandframes.com"};e.status(500).json({error:"Failed to send test email",details:s.message,debug:n})}});Fr.post("/test-order-status",async(o,e)=>{let{customerEmail:t,customerName:r="Test Customer",orderId:a=12345,orderStatus:s="order_processed"}=o.body;if(!t)return e.status(400).json({error:"Missing required field: customerEmail"});try{await tt(t,r,a,s,new Date(Date.now()+7*24*60*60*1e3)),e.json({success:!0,message:"Order status email sent successfully!"})}catch(n){console.error("Order status email error:",n),e.status(500).json({error:"Failed to send order status email",details:n.message})}});var Da=Fr;import{Router as Oi}from"express";var La=async(o,e)=>{try{let{to:t,message:r,voice:a,language:s,twiml:n,url:c,recordCall:i}=o.body;if(!t)return e.status(400).json({error:"Phone number is required"});if(!r&&!n&&!c)return e.status(400).json({error:"Must provide either message, twiml, or url parameter"});if(!$.isConfigured())return e.status(503).json({error:"Voice calling is not configured. Please check Dialpad credentials."});let d=await $.makeCall({to:formatPhoneNumber(t),message:r,voice:a,language:s,twiml:n,url:c,recordCall:i});d.success?e.json({success:!0,callSid:d.sid,message:"Voice call initiated successfully"}):e.status(400).json({error:d.error})}catch(t){console.error("Error making voice call:",t),e.status(500).json({error:"Failed to make voice call"})}},Ta=async(o,e)=>{try{let{to:t,orderNumber:r,status:a,estimatedCompletion:s}=o.body;if(!t||!r||!a)return e.status(400).json({error:"Phone number, order number, and status are required"});if(!$.isConfigured())return e.status(503).json({error:"Voice calling is not configured. Please check Dialpad credentials."});let n=await $.makeOrderStatusCall({to:formatPhoneNumber(t),orderNumber:r,status:a,estimatedCompletion:s});n.success?e.json({success:!0,callSid:n.sid,message:"Order status call initiated successfully"}):e.status(400).json({error:n.error})}catch(t){console.error("Error making order status call:",t),e.status(500).json({error:"Failed to make order status call"})}},$a=async(o,e)=>{try{let{to:t,customerName:r,amount:a,orderNumber:s,dueDate:n}=o.body;if(!t||!r||!a||!s)return e.status(400).json({error:"Phone number, customer name, amount, and order number are required"});if(!$.isConfigured())return e.status(503).json({error:"Voice calling is not configured. Please check Dialpad credentials."});let c=await $.makeCall({to:formatPhoneNumber(t),customerName:r,amount:parseFloat(a),orderNumber:s,dueDate:n});c.success?e.json({success:!0,callSid:c.sid,message:"Payment reminder call initiated successfully"}):e.status(400).json({error:c.error})}catch(t){console.error("Error making payment reminder call:",t),e.status(500).json({error:"Failed to make payment reminder call"})}},qa=async(o,e)=>{try{let{to:t,customerName:r,orderNumber:a,daysWaiting:s}=o.body;if(!t||!r||!a||s===void 0)return e.status(400).json({error:"Phone number, customer name, order number, and days waiting are required"});if(!$.isConfigured())return e.status(503).json({error:"Voice calling is not configured. Please check Dialpad credentials."});let n=await $.makeCall(r,formatPhoneNumber(t),a,parseInt(s));n.success?e.json({success:!0,callSid:n.sid,message:"Pickup reminder call initiated successfully"}):e.status(400).json({error:n.error})}catch(t){console.error("Error making pickup reminder call:",t),e.status(500).json({error:"Failed to make pickup reminder call"})}},Ba=async(o,e)=>{try{let{to:t,customerName:r,orderNumber:a}=o.body;if(!t||!r||!a)return e.status(400).json({error:"Phone number, customer name, and order number are required"});if(!$.isConfigured())return e.status(503).json({error:"Voice calling is not configured. Please check Dialpad credentials."});let s=await $.makeOrderReadyCall(r,formatPhoneNumber(t),a);s.success?e.json({success:!0,callSid:s.sid,message:"Order completion call initiated successfully"}):e.status(400).json({error:s.error})}catch(t){console.error("Error making order completion call:",t),e.status(500).json({error:"Failed to make order completion call"})}},Wa=async(o,e)=>{try{let{callSid:t}=o.params;if(!t)return e.status(400).json({error:"Call SID is required"});if(!$.isConfigured())return e.status(503).json({error:"Voice calling is not configured. Please check Dialpad credentials."});let r=await $.getCallStatus(t);r.success?e.json({success:!0,status:r.status}):e.status(400).json({error:r.error})}catch(t){console.error("Error getting call status:",t),e.status(500).json({error:"Failed to get call status"})}},Ua=async(o,e)=>{try{let t=$.isConfigured();e.json({configured:t,message:t?"Voice calling is properly configured":"Voice calling requires DIALPAD_API_KEY, DIALPAD_CLIENT_ID, and DIALPAD_CLIENT_SECRET"})}catch(t){console.error("Error checking voice call configuration:",t),e.status(500).json({error:"Failed to check voice call configuration"})}};var ve=Oi();ve.get("/configuration",Ua);ve.post("/make-call",La);ve.post("/order-status",Ta);ve.post("/order-complete",Ba);ve.post("/pickup-reminder",qa);ve.post("/payment-reminder",$a);ve.get("/status/:callSid",Wa);var Ha=ve;import{Router as Ai}from"express";var Me=Ai();Me.post("/order-complete/:orderNumber",(o,e)=>{let{orderNumber:t}=o.params,{customerName:r}=o.query;e.set("Content-Type","text/xml");let a=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Amy">Hello ${r||"valued customer"}! This is Jay's Frames calling with great news.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Amy">Your custom framing order number ${t} is now complete and ready for pickup.</Say>
    <Pause length="1"/>
    <Play>https://demo.twilio.com/docs/classic.mp3</Play>
    <Say voice="Polly.Amy">We're excited for you to see the beautiful result. Please come by during our business hours to collect your order.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Amy">Thank you for choosing Jay's Frames. Have a wonderful day!</Say>
</Response>`;e.send(a)});Me.post("/payment-reminder/:orderNumber",(o,e)=>{let{orderNumber:t}=o.params,{customerName:r,amount:a,dueDate:s}=o.query;e.set("Content-Type","text/xml");let n=s?` Payment is due by ${s}.`:"",c=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Brian">Hello ${r||"valued customer"}, this is Jay's Frames calling about your order number ${t}.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Brian">You have an outstanding balance of ${a||"your order total"}.${n}</Say>
    <Pause length="1"/>
    <Say voice="Polly.Brian">Please contact us at your earliest convenience to complete your payment.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Brian">Thank you for your prompt attention to this matter.</Say>
</Response>`;e.send(c)});Me.post("/pickup-reminder/:orderNumber",(o,e)=>{let{orderNumber:t}=o.params,{customerName:r,daysWaiting:a}=o.query;e.set("Content-Type","text/xml");let s=parseInt(a||"1"),c=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Emma">Hello ${r||"valued customer"}, this is Jay's Frames.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Emma">Your custom framing order number ${t} has been ready for pickup for ${s} ${s===1?"day":"days"}.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Emma">Please come by during our business hours to collect your beautiful framed artwork.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Emma">We look forward to seeing you soon. Thank you!</Say>
</Response>`;e.send(c)});Me.post("/promotional/:campaignId",(o,e)=>{let{campaignId:t}=o.params,{customerName:r}=o.query;e.set("Content-Type","text/xml");let a=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Amy">Hello ${r||"valued customer"}! Thank you for being a loyal customer of Jay's Frames.</Say>
    <Pause length="1"/>
    <Play>https://demo.twilio.com/docs/classic.mp3</Play>
    <Say voice="Polly.Amy">We have an exciting special offer just for you! Visit our shop this week for twenty percent off all custom matting services.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Amy">This exclusive offer expires soon, so don't miss out on transforming your favorite artwork.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Amy">Thank you for choosing Jay's Frames. We can't wait to help you create something beautiful!</Say>
</Response>`;e.send(a)});Me.post("/interactive-survey/:orderNumber",(o,e)=>{let{orderNumber:t}=o.params,{customerName:r}=o.query;e.set("Content-Type","text/xml");let a=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Amy">Hello ${r||"valued customer"}! This is Jay's Frames calling about your recent order number ${t}.</Say>
    <Pause length="1"/>
    <Gather numDigits="1" action="/api/twiml/survey-response" method="POST" timeout="10">
        <Say voice="Polly.Amy">We'd love to hear about your experience. Please press 1 if you're extremely satisfied, 2 for satisfied, or 3 if you have concerns.</Say>
    </Gather>
    <Say voice="Polly.Amy">Thank you for your time. Have a wonderful day!</Say>
</Response>`;e.send(a)});Me.post("/survey-response",(o,e)=>{let{Digits:t}=o.body;e.set("Content-Type","text/xml");let r="";switch(t){case"1":r="Thank you for rating us as extremely satisfied! We appreciate your business and look forward to serving you again.";break;case"2":r="Thank you for your positive feedback! We appreciate your business.";break;case"3":r="Thank you for your feedback. We will have a manager contact you shortly to address your concerns.";break;default:r="Thank you for your time. Have a wonderful day!"}let a=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Amy">${r}</Say>
</Response>`;e.send(a)});var Ga=Me;import{Router as _i}from"express";var Or=class{async triggerNotification(e,t){try{let{orderId:r,orderNumber:a,customerName:s,customerPhone:n,eventType:c,metadata:i}=e.body;if(!r||!a||!s||!n||!c){t.status(400).json({success:!1,error:"Missing required fields: orderId, orderNumber, customerName, customerPhone, eventType"});return}let d=["order_placed","payment_received","production_started","frame_cut","mat_cut","assembly_complete","ready_for_pickup","payment_due","pickup_overdue"];if(!d.includes(c)){t.status(400).json({success:!1,error:`Invalid event type. Must be one of: ${d.join(", ")}`});return}let h={orderId:r,orderNumber:a,customerName:s,customerPhone:n,eventType:c,metadata:i};await nt.handleOrderEvent(h),t.json({success:!0,message:`Notification triggered for order ${a}`,eventType:c})}catch(r){console.error("Error triggering notification:",r),t.status(500).json({success:!1,error:"Failed to trigger notification"})}}async scheduleNotification(e,t){try{let{orderId:r,orderNumber:a,customerName:s,customerPhone:n,eventType:c,delayMinutes:i,metadata:d}=e.body;if(!i||i<1){t.status(400).json({success:!1,error:"delayMinutes must be a positive number"});return}let h={orderId:r,orderNumber:a,customerName:s,customerPhone:n,eventType:c,metadata:d};await nt.scheduleDelayedNotification(h,i),t.json({success:!0,message:`Notification scheduled for order ${a} in ${i} minutes`,scheduledFor:new Date(Date.now()+i*60*1e3).toISOString()})}catch(r){console.error("Error scheduling notification:",r),t.status(500).json({success:!1,error:"Failed to schedule notification"})}}async sendBulkNotifications(e,t){try{let{events:r}=e.body;if(!Array.isArray(r)||r.length===0){t.status(400).json({success:!1,error:"events must be a non-empty array"});return}for(let a of r)if(!a.orderId||!a.orderNumber||!a.customerName||!a.customerPhone||!a.eventType){t.status(400).json({success:!1,error:"Each event must have orderId, orderNumber, customerName, customerPhone, and eventType"});return}await nt.sendBulkNotifications(r),t.json({success:!0,message:`Bulk notifications sent for ${r.length} orders`,count:r.length})}catch(r){console.error("Error sending bulk notifications:",r),t.status(500).json({success:!1,error:"Failed to send bulk notifications"})}}async checkOverdueOrders(e,t){try{console.log("Checking for overdue pickup orders..."),t.json({success:!0,message:"Overdue orders check completed"})}catch(r){console.error("Error checking overdue orders:",r),t.status(500).json({success:!1,error:"Failed to check overdue orders"})}}async getNotificationStatus(e,t){try{let r=!!(process.env.TWILIO_ACCOUNT_SID&&process.env.TWILIO_AUTH_TOKEN&&process.env.TWILIO_PHONE_NUMBER),a=[{type:"order_placed",description:"Order confirmation call"},{type:"payment_received",description:"Payment confirmation call"},{type:"production_started",description:"Production started notification"},{type:"frame_cut",description:"Frame cutting complete update"},{type:"mat_cut",description:"Mat cutting complete update"},{type:"assembly_complete",description:"Assembly complete notification"},{type:"ready_for_pickup",description:"Order ready for pickup call"},{type:"payment_due",description:"Payment reminder call"},{type:"pickup_overdue",description:"Pickup reminder call"}];t.json({success:!0,configured:r,message:r?"Order notifications are configured and ready":"Twilio credentials required",supportedEventTypes:a,endpoints:{trigger:"/api/order-notifications/trigger",schedule:"/api/order-notifications/schedule",bulk:"/api/order-notifications/bulk",checkOverdue:"/api/order-notifications/check-overdue"}})}catch(r){console.error("Error getting notification status:",r),t.status(500).json({success:!1,error:"Failed to get notification status"})}}async testNotification(e,t){try{let{phone:r,eventType:a="ready_for_pickup"}=e.body;if(!r){t.status(400).json({success:!1,error:"Phone number is required for test notification"});return}let s={orderId:"TEST-001",orderNumber:"TEST-001",customerName:"Test Customer",customerPhone:r,eventType:a,metadata:{amount:125.5,daysWaiting:3,dueDate:"Friday",estimatedCompletion:"2-3 business days"}};await nt.handleOrderEvent(s),t.json({success:!0,message:`Test notification sent to ${r}`,eventType:a,testData:s})}catch(r){console.error("Error sending test notification:",r),t.status(500).json({success:!1,error:"Failed to send test notification"})}}},X=new Or;var je=_i();je.post("/trigger",X.triggerNotification.bind(X));je.post("/schedule",X.scheduleNotification.bind(X));je.post("/bulk",X.sendBulkNotifications.bind(X));je.post("/check-overdue",X.checkOverdueOrders.bind(X));je.get("/status",X.getNotificationStatus.bind(X));je.post("/test",X.testNotification.bind(X));var Ka=je;H();Q();import{Router as Ri}from"express";import Ei from"stripe";import{eq as za}from"drizzle-orm";var Ya=Ri(),Va=process.env.STRIPE_SECRET_KEY?new Ei(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"}):null;Ya.post("/payment-status",async(o,e)=>{try{let{payment_intent_id:t,client_secret:r}=o.body;if(!Va)return e.status(500).json({success:!1,message:"Payment processing is not configured"});if(!t)return e.status(400).json({success:!1,message:"Payment intent ID is required"});let a=await Va.paymentIntents.retrieve(t),s=await m.select().from(B).where(za(B.stripePaymentIntentId,t)).limit(1),n=null;s.length>0&&(n=s[0].id,a.status==="succeeded"&&await m.update(B).set({status:"confirmed",paymentStatus:"paid",paymentMethod:"card",paidAt:new Date}).where(za(B.id,n))),e.json({success:!0,status:a.status,orderGroupId:n,amount:a.amount,currency:a.currency})}catch(t){console.error("Error checking payment status:",t),e.status(500).json({success:!1,message:"Failed to verify payment status"})}});var Qa=Ya;H();Ar();import Hi from"openai";var Dt=process.env.OPENAI_API_KEY?new Hi({apiKey:process.env.OPENAI_API_KEY}):null,Za="gpt-4o";async function Xa(o){return{recommendations:(await m.query.frames.findMany()).slice(0,3),matRecommendations:["White","Off-White","Cream"],reasonings:{general:"AI recommendations unavailable. Showing popular frame options."},suggestedPairings:{}}}async function es(o){try{if(!Dt)return V("OpenAI not available, returning fallback recommendations","recommendationService"),Xa(o);V("Getting frame recommendations with OpenAI","recommendationService");let e=await m.query.frames.findMany();if(!e.length)throw new Error("No frames found in database");V(`Found ${e.length} frames for recommendation context`,"recommendationService");let t=Gi(o,e),a=(await Dt.chat.completions.create({model:Za,messages:[{role:"system",content:"You are an expert custom framing consultant with extensive knowledge of frame styles, materials, and design principles. Your recommendations should be based on the available frames in the database and should match the artwork specifications and customer preferences."},{role:"user",content:t}],response_format:{type:"json_object"},temperature:.7,max_tokens:1e3})).choices[0].message.content;if(!a)throw new Error("No response from OpenAI");let s=JSON.parse(a);return{recommendations:await ts(s.recommendedFrameIds,e),matRecommendations:s.matRecommendations||[],reasonings:s.reasonings||{},suggestedPairings:s.suggestedPairings||{}}}catch(e){V(`Error getting frame recommendations: ${e}`,"recommendationService"),V("Falling back to simpler recommendations","recommendationService");let t=os(o,allFrames),r=as(o);return{recommendations:t,matRecommendations:r,reasonings:{fallback:"AI failed, using fallback recommendations"},suggestedPairings:{}}}}function Gi(o,e){let t=e.map(r=>({id:r.id,name:r.name,manufacturer:r.manufacturer,material:r.material,width:r.width,price:r.price,color:r.color,style:r.style||"standard",finish:r.finish||"standard"}));return`
I need personalized frame recommendations for custom framing. 

ARTWORK DETAILS:
- Type: ${o.artworkType}
- Description: ${o.artworkDescription}
- Dimensions: ${o.artworkWidth}" \xD7 ${o.artworkHeight}"

${o.colorPreference?`- Color preference: ${o.colorPreference}`:""}
${o.stylePreference?`- Style preference: ${o.stylePreference}`:""}
${o.budgetLevel?`- Budget level: ${o.budgetLevel}`:""}
${o.roomDecor?`- Room decor: ${o.roomDecor}`:""}
${o.customerPreference?`- Customer preference: ${o.customerPreference}`:""}

AVAILABLE FRAMES:
${JSON.stringify(t,null,2)}

Please recommend 3-5 frames that would best suit this artwork based on the details provided. Consider the style, color, and material of the frame in relation to the artwork. Also suggest appropriate mat colors that would pair well with the recommended frames.

Response must be in the following JSON format:
{
  "recommendedFrameIds": ["frame-id-1", "frame-id-2", "frame-id-3"],
  "matRecommendations": ["White", "Black", "Gold", "etc"],
  "reasonings": {
    "frame-id-1": "Explanation for why this frame was recommended",
    "frame-id-2": "Explanation for why this frame was recommended"
  },
  "suggestedPairings": {
    "frame-id-1": ["White mat", "Black mat"],
    "frame-id-2": ["Cream mat", "Tan mat"]
  }
}

Make sure the recommendedFrameIds field only contains IDs that are actually in the available frames list.
`}async function ts(o,e){let t={};e.forEach(a=>{t[a.id]=a});let r=[];for(let a of o)t[a]&&r.push(t[a]);if(r.length===0&&o.length>0){V("No exact matches found for recommendations, trying fuzzy matching","recommendationService");for(let a of o){let s=e.filter(c=>c.id.includes(a)||a.includes(c.id));if(s.length>0){r.push(s[0]);continue}let n=a.split(/[-_\s]+/);for(let c of n){if(c.length<3)continue;let i=e.filter(d=>d.name.toLowerCase().includes(c.toLowerCase()));if(i.length>0){r.push(i[0]);break}}}}return r}async function rs(o,e){try{if(!Dt)return V("OpenAI not available, returning fallback recommendations for image analysis","recommendationService"),Xa(e);V("Getting frame recommendations from image analysis","recommendationService");let t=await m.query.frames.findMany();if(!t.length)throw new Error("No frames found in database");let r=t.map(i=>({id:i.id,name:i.name,manufacturer:i.manufacturer,material:i.material,width:i.width,price:i.price,color:i.color,style:i.style||"standard",finish:i.finish||"standard"})),s=(await Dt.chat.completions.create({model:Za,messages:[{role:"system",content:"You are an expert custom framing consultant with extensive knowledge of frame styles, materials, and design principles. Analyze the artwork in the image and recommend appropriate frames from the available options."},{role:"user",content:[{type:"text",text:`
I need personalized frame recommendations for this artwork. 
Please analyze the image and recommend frames that would complement it.

${e.artworkType?`- Type: ${e.artworkType}`:""}
${e.artworkDescription?`- Description: ${e.artworkDescription}`:""}
${e.artworkWidth&&e.artworkHeight?`- Dimensions: ${e.artworkWidth}" \xD7 ${e.artworkHeight}"`:""}
${e.colorPreference?`- Color preference: ${e.colorPreference}`:""}
${e.stylePreference?`- Style preference: ${e.stylePreference}`:""}
${e.budgetLevel?`- Budget level: ${e.budgetLevel}`:""}

AVAILABLE FRAMES:
${JSON.stringify(r,null,2)}

First, describe the artwork's colors, style, and subject matter.
Then recommend 3-5 frames that would best suit this artwork.
Consider the style, color, and material of the frame in relation to the artwork.
Also suggest appropriate mat colors that would pair well with the recommended frames.

Response must be in the following JSON format:
{
  "artworkAnalysis": "Description of the artwork colors, style, and subject matter",
  "recommendedFrameIds": ["frame-id-1", "frame-id-2", "frame-id-3"],
  "matRecommendations": ["White", "Black", "Gold", "etc"],
  "reasonings": {
    "frame-id-1": "Explanation for why this frame was recommended",
    "frame-id-2": "Explanation for why this frame was recommended"
  },
  "suggestedPairings": {
    "frame-id-1": ["White mat", "Black mat"],
    "frame-id-2": ["Cream mat", "Tan mat"]
  }
}

Make sure the recommendedFrameIds field only contains IDs that are actually in the available frames list.
`},{type:"image_url",image_url:{url:`data:image/jpeg;base64,${o}`}}]}],response_format:{type:"json_object"},temperature:.7,max_tokens:1200})).choices[0].message.content;if(!s)throw new Error("No response from OpenAI");let n=JSON.parse(s);return{recommendations:await ts(n.recommendedFrameIds,t),matRecommendations:n.matRecommendations||[],reasonings:{...n.reasonings||{},artworkAnalysis:n.artworkAnalysis||"No analysis provided"},suggestedPairings:n.suggestedPairings||{}}}catch(t){V(`Error getting frame recommendations from image: ${t}`,"recommendationService"),V("Falling back to simpler recommendations","recommendationService");let r=os(e,allFrames),a=as(e);return{recommendations:r,matRecommendations:a,reasonings:{fallback:"AI failed, using fallback recommendations"},suggestedPairings:{}}}}function os(o,e){let{artworkType:t,colorPreference:r,stylePreference:a,budgetLevel:s}=o,n=e;if(s&&(n=n.filter(c=>{let i=parseFloat(c.price.toString());switch(s){case"economy":return i<=50;case"standard":return i>50&&i<=150;case"premium":return i>150;default:return!0}})),a){let c=a.toLowerCase();n=n.filter(i=>{let d=i.name.toLowerCase(),h=(i.style||"").toLowerCase();return d.includes(c)||h.includes(c)})}if(r){let c=r.toLowerCase();n=n.filter(i=>{let d=(i.color||"").toLowerCase(),h=i.name.toLowerCase();return d.includes(c)||h.includes(c)})}if(t){let c=t.toLowerCase();c.includes("photograph")||c.includes("photo")?n=n.filter(i=>i.material==="metal"||i.name.toLowerCase().includes("simple")||i.name.toLowerCase().includes("clean")):c.includes("painting")||c.includes("oil")?n=n.filter(i=>i.material==="wood"||i.name.toLowerCase().includes("ornate")||i.name.toLowerCase().includes("traditional")):(c.includes("print")||c.includes("poster"))&&(n=n.filter(i=>i.material==="metal"||i.name.toLowerCase().includes("modern")))}return n.length===0&&(n=e),n.sort((c,i)=>parseFloat(c.price.toString())-parseFloat(i.price.toString())).slice(0,5)}function as(o){let{artworkType:e,colorPreference:t}=o,r=["White","Off-White","Black","Cream"];if(t){let a=t.toLowerCase();if(a.includes("warm"))return["Cream","Off-White","Light Gray","Tan"];if(a.includes("cool"))return["White","Light Blue","Light Gray","Black"];if(a.includes("neutral"))return["White","Off-White","Light Gray","Cream"]}if(e){let a=e.toLowerCase();if(a.includes("photograph"))return["White","Off-White","Black","Light Gray"];if(a.includes("watercolor"))return["White","Cream","Off-White","Light Blue"];if(a.includes("charcoal")||a.includes("pencil"))return["White","Off-White","Light Gray","Cream"]}return r}ke();ke();var pe=class{static async analyzeArtwork(e,t){try{let{image:r,description:a,dimensions:s}=e.body;if(!r&&!a)return t.status(400).json({error:"Either image or description is required"});if(process.env.OPENAI_API_KEY&&r){let c=await Ki(r,a,s);return t.json(c)}else{let c=_r(a||"",s);return t.json(c)}}catch(r){console.error("Error in artwork analysis:",r),t.status(500).json({error:"Failed to analyze artwork",fallback:_r(e.body.description||"",e.body.dimensions)})}}static async generateFrameRecommendations(e,t){try{let{analysis:r,availableFrames:a,availableMats:s}=e.body,n=Ji(r,a,s);t.json({recommendations:n})}catch(r){console.error("Error generating recommendations:",r),t.status(500).json({error:"Failed to generate recommendations"})}}static async getRecommendationsFromImage(e,t){try{let{artworkDescription:r,artworkType:a,artworkWidth:s,artworkHeight:n,image:c}=e.body,i=(r||"").toLowerCase(),d="modern",h="neutral",g=["neutral"];i.includes("abstract")||i.includes("contemporary")?d="modern":i.includes("classical")||i.includes("traditional")?d="traditional":i.includes("landscape")||i.includes("nature")?d="natural":(i.includes("portrait")||i.includes("people"))&&(d="portrait"),i.includes("bright")||i.includes("vibrant")?h="energetic":i.includes("dark")||i.includes("moody")?h="dramatic":(i.includes("calm")||i.includes("peaceful"))&&(h="serene"),g=["red","blue","green","yellow","purple","orange","black","white"].filter(f=>i.includes(f)),g.length===0&&(g=["neutral"]);let l={style:d,mood:h,dominantColors:g,complexity:i.includes("detailed")?"high":"medium",orientation:s>n?"landscape":"portrait"};Xt(`Generated artwork analysis: ${JSON.stringify(l)}`,"aiController"),t.json(l)}catch(r){Xt(`Error in getRecommendations: ${r}`,"aiController"),t.status(500).json({error:"Failed to generate recommendations",analysis:{style:"modern",mood:"neutral",dominantColors:["neutral"],complexity:"medium",orientation:"landscape"}})}}};async function Ki(o,e,t){try{let{OpenAI:r}=await import("openai"),a=new r({apiKey:process.env.OPENAI_API_KEY}),s=`Analyze this artwork image${e?` with description: "${e}"`:""} and provide a comprehensive analysis for custom framing purposes.

Please analyze:
1. Artistic style (modern, traditional, abstract, realistic, etc.)
2. Mood and emotional tone (energetic, serene, dramatic, playful, etc.)
3. Dominant colors and color palette
4. Subject matter and themes
5. Complexity level (simple, moderate, complex)
6. Art movement or period if identifiable

Based on your analysis, recommend:
- Frame styles that would complement the artwork
- Mat colors that would enhance the piece
- Glass types suitable for the artwork

Respond in JSON format with this structure:
{
  "style": "string",
  "mood": "string", 
  "dominantColors": ["color1", "color2"],
  "complexity": "string",
  "orientation": "landscape|portrait|square",
  "subjects": ["subject1", "subject2"],
  "artMovement": "string",
  "colorPalette": {
    "primary": "color",
    "secondary": ["color1", "color2"],
    "accent": ["color1", "color2"]
  },
  "recommendations": {
    "frameStyles": ["style1", "style2"],
    "matColors": ["color1", "color2"],
    "glassTypes": ["type1", "type2"]
  }
}`,n=await a.chat.completions.create({model:"gpt-4o",messages:[{role:"user",content:[{type:"text",text:s},{type:"image_url",image_url:{url:o.startsWith("data:")?o:`data:image/jpeg;base64,${o}`}}]}],response_format:{type:"json_object"},max_tokens:1e3}),c=JSON.parse(n.choices[0].message.content||"{}");return t&&(c.orientation=t.width>t.height?"landscape":t.width<t.height?"portrait":"square"),c}catch(r){return console.error("OpenAI analysis failed, falling back to rules:",r),_r(e||"",t)}}function _r(o,e){let t=o.toLowerCase(),r="modern";t.includes("abstract")||t.includes("contemporary")?r="abstract":t.includes("classical")||t.includes("traditional")||t.includes("renaissance")?r="traditional":t.includes("landscape")||t.includes("nature")||t.includes("botanical")?r="natural":t.includes("portrait")||t.includes("people")||t.includes("figure")?r="portrait":(t.includes("minimalist")||t.includes("simple"))&&(r="minimalist");let a="neutral";t.includes("bright")||t.includes("vibrant")||t.includes("energetic")?a="energetic":t.includes("dark")||t.includes("moody")||t.includes("dramatic")?a="dramatic":t.includes("calm")||t.includes("peaceful")||t.includes("serene")?a="serene":(t.includes("playful")||t.includes("fun")||t.includes("whimsical"))&&(a="playful");let n=["red","blue","green","yellow","purple","orange","black","white","pink","brown"].filter(l=>t.includes(l));n.length===0&&n.push("neutral");let c=[];(t.includes("landscape")||t.includes("nature"))&&c.push("landscape"),(t.includes("portrait")||t.includes("people"))&&c.push("portrait"),t.includes("abstract")&&c.push("abstract"),(t.includes("still life")||t.includes("objects"))&&c.push("still life"),(t.includes("animal")||t.includes("wildlife"))&&c.push("animals");let i="medium";t.includes("detailed")||t.includes("complex")||t.includes("intricate")?i="high":(t.includes("simple")||t.includes("minimalist")||t.includes("clean"))&&(i="low");let d="portrait";e&&(d=e.width>e.height?"landscape":e.width<e.height?"portrait":"square");let h=zi(r,a),g=Vi(n,a,r),u=Yi(r,i);return{style:r,mood:a,dominantColors:n,complexity:i,orientation:d,subjects:c,artMovement:Qi(r,t),colorPalette:{primary:n[0]||"neutral",secondary:n.slice(1,3),accent:n.slice(3,5)},recommendations:{frameStyles:h,matColors:g,glassTypes:u}}}function zi(o,e){let t=[];switch(o){case"modern":case"abstract":case"minimalist":t.push("sleek metal","simple black","white contemporary");break;case"traditional":case"classical":t.push("ornate gold","carved wood","antique bronze");break;case"natural":case"landscape":t.push("natural wood","rustic barn wood","walnut");break;case"portrait":t.push("elegant black","classic gold","mahogany wood");break;default:t.push("versatile black","neutral wood","simple metal")}return e==="dramatic"?t.unshift("bold black","dark metal"):e==="serene"?t.unshift("light wood","white frame"):e==="energetic"&&t.unshift("colorful frame","metallic accent"),t.slice(0,4)}function Vi(o,e,t){let r=[];return r.push("white","cream","off-white"),o.includes("blue")&&r.push("navy","light blue","gray"),o.includes("red")&&r.push("burgundy","cream","gold"),o.includes("green")&&r.push("forest green","sage","cream"),o.includes("black")&&r.push("black","charcoal","white"),t==="traditional"?r.push("antique white","museum board","gold"):t==="modern"&&r.push("pure white","light gray","black"),e==="dramatic"?r.unshift("black","charcoal"):e==="serene"&&r.unshift("soft white","pale blue"),[...new Set(r)].slice(0,6)}function Yi(o,e){let t=["standard glass"];return(o==="traditional"||e==="high")&&t.push("museum glass","conservation clear"),(o==="modern"||o==="minimalist")&&t.push("anti-reflective","low-iron glass"),t.push("UV protective glass","acrylic glazing"),t.slice(0,4)}function Qi(o,e){if(e.includes("impressionist")||e.includes("monet"))return"Impressionism";if(e.includes("cubist")||e.includes("picasso"))return"Cubism";if(e.includes("surreal")||e.includes("dali"))return"Surrealism";if(e.includes("pop art")||e.includes("warhol"))return"Pop Art";if(e.includes("renaissance")||e.includes("da vinci"))return"Renaissance";if(e.includes("baroque"))return"Baroque";if(e.includes("romantic"))return"Romanticism";if(o==="abstract")return"Abstract Expressionism";if(o==="traditional")return"Classical";if(o==="modern")return"Contemporary"}function Ji(o,e,t){let r=[];for(let a of e.slice(0,10))for(let s of t.slice(0,15)){let n=Zi(o,a,s);n>.6&&r.push({frame:a,mat:s,score:n,reasoning:Xi(o,a,s)})}return r.sort((a,s)=>s.score-a.score).slice(0,8)}function Zi(o,e,t){let r=.5,a=e.name.toLowerCase(),s=t.name.toLowerCase(),n=t.hexColor.toLowerCase();return o.recommendations.frameStyles.map(d=>d.toLowerCase()).some(d=>a.includes(d.split(" ")[0]))&&(r+=.2),o.recommendations.matColors.map(d=>d.toLowerCase()).some(d=>s.includes(d)||n.includes(d))&&(r+=.2),o.mood==="dramatic"&&(a.includes("black")||n.includes("000"))&&(r+=.1),o.mood==="serene"&&(a.includes("white")||n.includes("fff"))&&(r+=.1),Math.min(r,1)}function Xi(o,e,t){let r=[];return o.style==="modern"&&e.name.toLowerCase().includes("sleek")&&r.push("Sleek frame complements modern artwork style"),o.mood==="serene"&&t.name.toLowerCase().includes("white")&&r.push("White mat enhances the peaceful mood"),o.dominantColors.includes("blue")&&t.name.toLowerCase().includes("blue")&&r.push("Mat color harmonizes with dominant blue tones"),r.length>0?r.join(". ")+".":`Good overall match for ${o.style} ${o.subjects.join(" and ")} artwork.`}var zm=pe.getRecommendationsFromImage;H();Q();xt();ke();import{eq as ss}from"drizzle-orm";async function ec(o,e){try{let t=await m.select().from(O);if(console.log(`Frame Controller: Found ${t.length} frames in database`),!t||t.length===0){console.log("Frame Controller: No frames in database, returning default frames");let n=[{id:"larson-210286",name:"Larson Black Wood Frame",manufacturer:"Larson-Juhl",material:"Wood",width:"2.25",depth:"0.75",price:"16.75",catalogImage:"https://www.larsonjuhl.com/contentassets/products/mouldings/210286_fab.jpg",edgeTexture:null,corner:null},{id:"larson-210285",name:"Larson White Wood Frame",manufacturer:"Larson-Juhl",material:"Wood",width:"2.25",depth:"0.75",price:"16.75",catalogImage:"https://www.larsonjuhl.com/contentassets/products/mouldings/210285_fab.jpg",edgeTexture:null,corner:null}].map(c=>pt(c));return e.json(n)}if(!Array.isArray(t))return console.warn("Frames data is not an array, returning empty array"),e.json([]);let a=t.filter(s=>s&&typeof s=="object"&&s.id&&s.name).map(s=>pt(s));console.log(`Frame Controller: Returning ${a.length} enhanced frames`),e.json(a)}catch(t){console.error("Error fetching frames:",t?.message||t),e.status(500).json({error:"Failed to fetch frames",message:t?.message||"Unknown error occurred",frames:[]})}}async function tc(o,e){try{let{id:t}=o.params,[r]=await m.select().from(O).where(ss(O.id,t));if(!r)return e.status(404).json({error:"Frame not found"});if(typeof r!="object"||!r.id||!r.name)return console.warn("Frame data is invalid, returning empty object"),e.json({});let a=pt(r);e.json(a)}catch(t){console.error("Error fetching frame by ID:",t),e.status(500).json({error:"Failed to fetch frame",message:t instanceof Error?t.message:"Unknown error"})}}async function rc(o,e){try{let{manufacturer:t}=o.params,r=await m.select().from(O).where(ss(O.manufacturer,t));if(!Array.isArray(r))return console.warn("Frames data is not an array, returning empty array"),e.json([]);let s=r.filter(n=>n&&typeof n=="object"&&n.id&&n.name).map(n=>pt(n));e.json(s)}catch(t){console.error("Error fetching frames by manufacturer:",t),e.status(500).json({error:"Failed to fetch frames by manufacturer",message:t instanceof Error?t.message:"Unknown error"})}}async function oc(o,e){try{let{query:t}=o.params;if(console.log(`Frame Controller: Searching for frames with query: ${t}`),!t)return e.status(400).json({error:"Search query is required"});let a=(await m.select().from(O)).filter(n=>(n.id.split("-")[1]||"").includes(t)||n.id.toLowerCase().includes(t.toLowerCase())||n.name.toLowerCase().includes(t.toLowerCase())||n.manufacturer.toLowerCase().includes(t.toLowerCase()));if(a.length===0){console.log("Frame Controller: No database matches, searching static catalog");let{frameCatalog:n}=await Promise.resolve().then(()=>(xt(),to));a=n.filter(i=>(i.id.split("-")[1]||"").includes(t)||i.id.toLowerCase().includes(t.toLowerCase())||i.name.toLowerCase().includes(t.toLowerCase())||i.manufacturer.toLowerCase().includes(t.toLowerCase()))}let s=a.map(n=>pt(n));console.log(`Frame Controller: Found ${s.length} matching frames`),e.json({frames:s,count:s.length})}catch(t){console.error("Error searching frames:",t?.message||t),e.status(500).json({error:"Failed to search frames",message:t?.message||"Unknown error occurred",frames:[]})}}function pt(o){let e={Gold:"#D4AF37",Silver:"#C0C0C0",Black:"#000000",White:"#F5F5F5",Brown:"#8B4513",Walnut:"#5C4033",Cherry:"#722F37",Mahogany:"#4E2728",Oak:"#D8BE75",Natural:"#E5D3B3"},t="#8B4513";for(let[r,a]of Object.entries(e))if(o.name.toLowerCase().includes(r.toLowerCase())||o.material&&o.material.toLowerCase().includes(r.toLowerCase())){t=a;break}return(o.name.toLowerCase().includes("black")||o.material&&o.material.toLowerCase().includes("black"))&&(t="#000000"),{...o,color:t}}var ac=async(o,e)=>{try{e.json(N)}catch(t){We.error("Error fetching frames:",t),e.status(500).json({error:"Failed to fetch frames"})}},sc=async(o,e)=>{try{e.json(N)}catch(t){We.error("Error fetching all frames:",t),e.status(500).json({error:"Failed to fetch frames"})}},nc=async(o,e)=>{try{let{vendor:t}=o.params,r=N.filter(a=>a.manufacturer?.toLowerCase()===t.toLowerCase());e.json(r)}catch(t){We.error(`Error fetching ${o.params.vendor} frames:`,t),e.status(500).json({error:"Failed to fetch vendor frames"})}},gt={getAllFrames:ec,getFrameById:tc,getFramesByManufacturer:rc,searchFrames:oc,getFrames:ac,getAllFrames2:sc,getFramesByVendor:nc};H();kt();ke();async function ic(){let o=Date.now();try{return await m.execute("SELECT 1"),{service:"database",status:"healthy",responseTime:Date.now()-o,circuitBreakerState:W.database.getState().state}}catch(e){return{service:"database",status:"unhealthy",responseTime:Date.now()-o,error:e.message,circuitBreakerState:W.database.getState().state}}}async function cc(){let o=Date.now();try{return process.env.OPENAI_API_KEY?{service:"openai",status:"healthy",responseTime:Date.now()-o,circuitBreakerState:W.openai.getState().state}:{service:"openai",status:"degraded",responseTime:Date.now()-o,error:"API key not configured",circuitBreakerState:W.openai.getState().state}}catch(e){return{service:"openai",status:"unhealthy",responseTime:Date.now()-o,error:e.message,circuitBreakerState:W.openai.getState().state}}}async function lc(){let o=Date.now();try{return process.env.STRIPE_SECRET_KEY?{service:"stripe",status:"healthy",responseTime:Date.now()-o,circuitBreakerState:W.stripe.getState().state}:{service:"stripe",status:"degraded",responseTime:Date.now()-o,error:"API key not configured",circuitBreakerState:W.stripe.getState().state}}catch(e){return{service:"stripe",status:"unhealthy",responseTime:Date.now()-o,error:e.message,circuitBreakerState:W.stripe.getState().state}}}async function uc(){let o=Date.now();try{return!process.env.SUPABASE_URL||!process.env.SUPABASE_ANON_KEY?{service:"supabase",status:"degraded",responseTime:Date.now()-o,error:"Configuration missing",circuitBreakerState:W.supabase.getState().state}:{service:"supabase",status:"healthy",responseTime:Date.now()-o,circuitBreakerState:W.supabase.getState().state}}catch(e){return{service:"supabase",status:"unhealthy",responseTime:Date.now()-o,error:e.message,circuitBreakerState:W.supabase.getState().state}}}async function ns(o,e){try{let t=await Promise.all([ic(),cc(),lc(),uc()]),r=t.every(s=>s.status==="healthy")?"healthy":t.some(s=>s.status==="unhealthy")?"unhealthy":"degraded",a={status:r,timestamp:new Date().toISOString(),checks:t,system:{uptime:process.uptime(),memory:process.memoryUsage(),nodeVersion:process.version}};se.info("Health check completed",{operation:"health_check",status:r,unhealthyServices:t.filter(s=>s.status==="unhealthy").map(s=>s.service)}),e.status(r==="healthy"?200:503).json(a)}catch(t){se.error("Health check failed",{error:t,severity:"high",operation:"health_check"}),e.status(500).json({status:"unhealthy",timestamp:new Date().toISOString(),error:"Health check system failure"})}}kt();ke();J();Qt();async function is(o,e){let t=Date.now(),r=[];try{let d=Date.now();await y.getFrames(),r.push({service:"database",status:"healthy",responseTime:Date.now()-d})}catch(d){r.push({service:"database",status:"unhealthy",responseTime:Date.now()-t,error:d.message})}try{let d=Date.now();await Ze.set("health-check","ok",1e3);let h=await Ze.get("health-check");r.push({service:"cache",status:h==="ok"?"healthy":"degraded",responseTime:Date.now()-d})}catch(d){r.push({service:"cache",status:"degraded",responseTime:Date.now()-t,error:d.message})}let a={database:W.database.getState(),openai:W.openai.getState(),stripe:W.stripe.getState(),supabase:W.supabase.getState()},s=r.some(d=>d.status==="unhealthy"),n=r.some(d=>d.status==="degraded"),c=s?"unhealthy":n?"degraded":"healthy",i={status:c,timestamp:new Date().toISOString(),responseTime:Date.now()-t,checks:r,circuitBreakers:a,system:{uptime:process.uptime(),memory:process.memoryUsage(),nodeVersion:process.version,environment:"production"}};se.info("System health check completed",{operation:"systemHealthCheck",status:c,responseTime:i.responseTime,failedServices:r.filter(d=>d.status!=="healthy").map(d=>d.service)}),e.status(c==="healthy"?200:503).json(i)}async function cs(o,e){try{let t=Date.now();await y.getFrames(),e.json({status:"ok",timestamp:new Date().toISOString(),responseTime:Date.now()-t})}catch(t){e.status(503).json({status:"error",error:t.message,timestamp:new Date().toISOString()})}}import zc from"stripe";async function bs(o){o.post("/api/art-locations",cr.sendArtLocationData),o.get("/api/art-locations/:orderId",cr.getArtLocationData),o.post("/api/frame-designs",lr.saveFrameDesign),o.get("/api/frame-designs/:orderId",lr.getFrameDesign),o.use("/api/webhooks",Lo),o.get("/api/health",(g,u)=>{u.json({status:"ok",timestamp:new Date().toISOString(),environment:"production"})}),o.get("/api/health/integrations",ns),o.get("/api/system-health",is),o.get("/api/ping",cs),o.get("/api/dashboard/config",(g,u)=>{let l=process.env.DASHBOARD_API_URL;u.json({configured:!!l,url:l?`${l.substring(0,30)}...`:null,fullUrl:l,message:l?"Dashboard API is configured and ready":"Dashboard API URL not configured. Add DASHBOARD_API_URL to your secrets.",endpoints:l?{metrics:`${l}/api/metrics`,orders:`${l}/api/orders`,status:`${l}/api/status`}:null})}),o.get("/api/dashboard-proxy/health",async(g,u)=>{let l=process.env.DASHBOARD_API_URL;if(!l)return u.status(400).json({error:"Dashboard API URL not configured"});try{let b=await(await fetch(`${l}/api/health`)).json();u.json(b)}catch(f){u.status(500).json({error:f.message})}}),o.get("/api/dashboard-proxy/metrics",async(g,u)=>{let l=process.env.DASHBOARD_API_URL;if(!l)return u.status(400).json({error:"Dashboard API URL not configured"});try{let b=await(await fetch(`${l}/api/metrics`)).json();u.json(b)}catch(f){u.status(500).json({error:f.message})}}),o.get("/api/dashboard-proxy/status",async(g,u)=>{let l=process.env.DASHBOARD_API_URL;if(!l)return u.status(400).json({error:"Dashboard API URL not configured"});try{let b=await(await fetch(`${l}/api/status`)).json();u.json(b)}catch(f){u.status(500).json({error:f.message})}}),o.post("/api/dashboard-proxy/test",async(g,u)=>{let l=process.env.DASHBOARD_API_URL;if(!l)return u.status(400).json({error:"Dashboard API URL not configured"});try{(await fetch(`${l}/api/health`)).ok?u.json({success:!0,message:"Dashboard connection successful"}):u.status(500).json({error:"Dashboard connection failed"})}catch(f){u.status(500).json({error:f.message})}}),o.all("/api/dashboard-proxy/*",async(g,u)=>{let l=process.env.DASHBOARD_API_URL;if(!l)return u.status(503).json({success:!1,error:"Dashboard API URL not configured. Please add DASHBOARD_API_URL to your secrets."});try{let f=g.params[0],b={method:g.method,headers:{"Content-Type":"application/json",...g.headers.authorization&&{Authorization:g.headers.authorization}}};["POST","PUT","PATCH"].includes(g.method)&&g.body&&(b.body=JSON.stringify(g.body));let F=await fetch(`${l}/${f}`,b);if(!F.ok)throw new Error(`Dashboard API responded with status: ${F.status}`);let P=await F.json();u.status(F.status).json(P)}catch(f){console.error("Dashboard API proxy error:",f),u.status(500).json({success:!1,error:"Failed to connect to Dashboard API",details:f instanceof Error?f.message:"Unknown error"})}}),o.get("/api/vendor-catalog/all",(g,u)=>{u.json([])}),o.get("/api/vendor-catalog/larson",(g,u)=>{u.json([])}),o.get("/api/vendor-catalog/roma",(g,u)=>{u.json([])}),o.get("/api/vendor-catalog/nielsen",(g,u)=>{u.json([])}),o.get("/api/larson-catalog/crescent",(g,u)=>{u.json([])}),o.get("/api/crescent-matboards",async(g,u)=>{try{let f=(await y.getAllMatColors()).filter(b=>b.manufacturer&&b.manufacturer.toLowerCase().includes("crescent"));u.json(f)}catch(l){console.error("Error fetching Crescent matboards:",l),u.status(500).json({error:l.message})}}),o.get("/api/frames",gt.getAllFrames),o.get("/api/frames/search/:query",gt.searchFrames),o.get("/api/frames/:id",gt.getFrameById),o.get("/api/frames/manufacturer/:manufacturer",gt.getFramesByManufacturer),o.get("/api/mat-colors",async(g,u)=>{try{await y.initializeMatColors();let l=await y.getAllMatColors();console.log(`Mat colors API returning ${l.length} colors`),u.json(l)}catch(l){console.error("Error fetching mat colors:",l),u.status(500).json({error:l.message})}}),o.get("/api/glass-options",async(g,u)=>{try{let l=await y.getAllGlassOptions();u.json(l)}catch(l){console.error("Error fetching glass options:",l),u.status(500).json({error:l.message})}}),o.get("/api/wholesale-orders",(g,u)=>{u.json([])}),o.get("/api/qr-codes",(g,u)=>{u.json([])}),o.get("/api/hub/material-orders",(g,u)=>{u.json([])}),o.post("/api/material-orders",async(g,u)=>{try{let{materialId:l,quantity:f,orderId:b,notes:F}=g.body;if(!l||!f)return u.status(400).json({error:"Material ID and quantity are required"});let P={id:Math.floor(Math.random()*1e4),materialId:l,quantity:f,orderId:b||null,notes:F||"",status:"pending",createdAt:new Date().toISOString()};u.json({success:!0,materialOrder:P,message:"Material order created successfully"})}catch(l){console.error("Error creating material order:",l),u.status(500).json({error:"Failed to create material order"})}}),o.get("/api/auth/status",(g,u)=>{u.json({authenticated:!1,user:null})}),o.get("/api/discord/bot-info",(g,u)=>{u.json({status:"disabled",message:"Discord integration temporarily disabled for deployment stability"})}),o.post("/api/discord/test-notification",async(g,u)=>{u.status(503).json({error:"Discord integration temporarily disabled",message:"Discord notifications are currently unavailable"})}),o.get("/api/recommendations/frames",async(g,u)=>{try{let l={artworkType:g.query.artworkType,artworkDescription:g.query.artworkDescription,artworkWidth:parseFloat(g.query.artworkWidth)||16,artworkHeight:parseFloat(g.query.artworkHeight)||20,colorPreference:g.query.colorPreference,stylePreference:g.query.stylePreference,budgetLevel:g.query.budgetLevel,roomDecor:g.query.roomDecor,customerPreference:g.query.customerPreference},f=await es(l);u.json(f)}catch(l){console.error("Error getting frame recommendations:",l),u.status(500).json({error:"Failed to get recommendations",message:l.message})}}),o.post("/api/recommendations/from-image",async(g,u)=>{try{let{imageBase64:l,...f}=g.body;if(!l)return u.status(400).json({error:"Image data required"});let b=await rs(l,f);u.json(b)}catch(l){console.error("Error getting image-based recommendations:",l),u.status(500).json({error:"Failed to analyze image",message:l.message})}}),o.post("/api/ai/analyze-artwork",pe.analyzeArtwork),o.post("/api/ai/generate-recommendations",pe.generateFrameRecommendations),o.post("/api/pricing/calculate",async(g,u)=>{try{let{calculatePrice:l}=await Promise.resolve().then(()=>(us(),ls));await l(g,u)}catch(l){console.error("Error in pricing calculation:",l),u.status(500).json({error:"Failed to calculate pricing"})}}),o.get("/api/ai/material-recommendations",async(g,u)=>{try{let f=await(await Promise.resolve().then(()=>(Er(),Rr))).generateOrderingRecommendations();u.json({recommendations:f})}catch(l){console.error("Error getting material recommendations:",l),u.status(500).json({error:"Failed to generate recommendations",message:l.message})}}),o.get("/api/ai/seasonal-trends/:materialId",async(g,u)=>{try{let{materialId:l}=g.params,b=await(await Promise.resolve().then(()=>(Er(),Rr))).getSeasonalTrends(l);u.json(b)}catch(l){console.error("Error getting seasonal trends:",l),u.status(500).json({error:"Failed to get trends",message:l.message})}}),o.post("/api/notifications/send",async(g,u)=>{try{let{customerPhone:l,customerEmail:f,orderId:b,type:F,message:P,discordUserId:M}=g.body,{getCustomerByPhone:oe,getCustomerByEmail:Y,updateCustomerDiscordId:ge}=await Promise.resolve().then(()=>(Mr(),Nr)),fe=l?oe(l):f?Y(f):null;if(!fe)return u.status(404).json({error:"Customer not found"});let bt=b||Math.floor(Math.random()*1e3)+100;console.log(`Notification request for customer ${fe.name}: ${F} - ${P}`),u.json({success:!0,customer:{name:fe.name,phone:fe.phone,email:fe.email,hasDiscord:!1},orderNumber:bt,message:"Notification logged (Discord integration disabled for deployment stability)"})}catch(l){console.error("Error sending customer notification:",l),u.status(500).json({error:"Failed to send notification",details:l instanceof Error?l.message:"Unknown error"})}}),o.get("/api/customers/search",async(g,u)=>{try{let{phone:l,email:f}=g.query,{getCustomerByPhone:b,getCustomerByEmail:F}=await Promise.resolve().then(()=>(Mr(),Nr)),P=l?b(l):f?F(f):null;if(!P)return u.status(404).json({error:"Customer not found"});u.json({customer:{id:P.id,name:P.name,phone:P.phone,email:P.email,hasDiscord:!!P.discordUserId,preferences:P.preferences,notes:P.notes}})}catch{u.status(500).json({error:"Failed to search customer"})}}),o.get("/api/kanban/external/orders",async(g,u)=>{try{let{externalKanbanService:l}=await Promise.resolve().then(()=>(ht(),ft)),f=await l.fetchOrders();u.json(f)}catch{u.status(500).json({success:!1,orders:[],error:"Failed to fetch orders from external Kanban app"})}}),o.get("/api/kanban/external/health",async(g,u)=>{try{let{externalKanbanService:l}=await Promise.resolve().then(()=>(ht(),ft)),f=await l.healthCheck();u.json(f)}catch{u.status(500).json({status:"error",connected:!1,error:"Failed to check external Kanban health"})}}),o.get("/api/integrations/test-all",async(g,u)=>{try{let l={dashboard:{connected:!1,error:null},kanban:{connected:!1,error:null}},f=process.env.DASHBOARD_API_URL;if(f)try{let P=await fetch(`${f}/api/health`,{method:"GET",timeout:5e3});l.dashboard.connected=P.ok,P.ok||(l.dashboard.error=`HTTP ${P.status}`)}catch(P){l.dashboard.error=P instanceof Error?P.message:"Connection failed"}else l.dashboard.error="Dashboard API URL not configured";let b=process.env.EXTERNAL_KANBAN_URL,F=process.env.EXTERNAL_KANBAN_API_KEY;if(b&&F)try{let P=await fetch(`${b}/api/health`,{method:"GET",headers:{Authorization:`Bearer ${F}`,"Content-Type":"application/json"},timeout:5e3});l.kanban.connected=P.ok,P.ok||(l.kanban.error=`HTTP ${P.status}`)}catch(P){l.kanban.error=P instanceof Error?P.message:"Connection failed"}else l.kanban.error="Kanban API URL or API Key not configured";u.json({success:!0,integrations:l,summary:{total:2,connected:Object.values(l).filter(P=>P.connected).length,failed:Object.values(l).filter(P=>!P.connected).length}})}catch{u.status(500).json({success:!1,error:"Failed to test integrations"})}}),o.post("/api/kanban/external/test-connection",async(g,u)=>{try{let{externalKanbanService:l}=await Promise.resolve().then(()=>(ht(),ft)),f=!!process.env.EXTERNAL_KANBAN_URL,b=!!process.env.EXTERNAL_KANBAN_API_KEY;if(!f||!b)return u.status(400).json({success:!1,error:"Kanban configuration incomplete",details:{hasUrl:f,hasApiKey:b,message:"Please add EXTERNAL_KANBAN_URL and EXTERNAL_KANBAN_API_KEY to your secrets"}});let F=await l.healthCheck(),P=await l.fetchOrders();u.json({success:F.connected,health:F,ordersTest:{success:P.success,orderCount:P.orders.length,error:P.error},configuration:{baseUrl:process.env.EXTERNAL_KANBAN_URL?`${process.env.EXTERNAL_KANBAN_URL.substring(0,30)}...`:"Not configured",apiKeyConfigured:!!process.env.EXTERNAL_KANBAN_API_KEY}})}catch(l){u.status(500).json({success:!1,error:"Connection test failed",details:l instanceof Error?l.message:"Unknown error"})}}),o.post("/api/kanban/external/orders/:orderId/status",async(g,u)=>{try{let{orderId:l}=g.params,{status:f,stage:b,notes:F}=g.body,{externalKanbanService:P}=await Promise.resolve().then(()=>(ht(),ft));await P.updateOrderStatus(l,f,b,F)?u.json({success:!0,orderId:l,updatedStatus:f,stage:b,notes:F,timestamp:new Date().toISOString()}):u.status(500).json({success:!1,error:"Failed to update order status in external Kanban"})}catch{u.status(500).json({success:!1,error:"Failed to update external Kanban order status"})}}),o.get("/api/kanban/api-key",(g,u)=>{u.json({success:!0,message:"Use one of these API keys for integration",apiKeys:[{key:"kanban_admin_key_2025_full_access",name:"3D Designer Integration",permissions:["orders:create","orders:read","orders:update","pricing:read","files:upload"]},{key:"jf_houston_heights_framing_2025_master_api_key_secure_access",name:"Houston Heights Framing API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"]}],usage:{header:"Authorization",format:"Bearer YOUR_API_KEY"},endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-name.replit.app",orders:"/api/kanban/orders",status:"/api/kanban/status"}})});let e=process.env.POS_API_KEY||"jays_frames_kanban_2025";o.get("/api/kanban/orders",dr,(g,u)=>{u.json({success:!0,orders:[],endpoint:"/api/kanban/orders",description:"Retrieves all orders with production status and timeline information"})}),o.post("/api/kanban/orders/:orderId/status",dr,(g,u)=>{let{orderId:l}=g.params,{status:f,stage:b,notes:F}=g.body;u.json({success:!0,orderId:l,updatedStatus:f,stage:b,notes:F,timestamp:new Date().toISOString(),description:"Updates order production status from external Kanban system"})}),o.get("/api/kanban/status",(g,u)=>{u.json({status:"active",service:"Jays Frames POS System",version:"1.0.0",endpoints:{orders:"/api/kanban/orders",updateStatus:"/api/kanban/orders/:orderId/status",health:"/api/kanban/status"},authentication:"API Key required in Authorization header",timestamp:new Date().toISOString()})}),o.get("/api/kanban/api-key",(g,u)=>{u.json({apiKey:e,usage:"Add this to your Kanban app Authorization header as: Bearer "+e,endpoints:{orders:"/api/kanban/orders",updateStatus:"/api/kanban/orders/:orderId/status"},note:"Keep this API key secure - it provides access to your order data"})}),o.use("/api/hub",hr),o.use("/api/hub-admin",Rt),o.use("/api/admin",Rt),o.post("/api/admin/generate-api-key",async(g,u)=>{try{let{generateApiKey:l}=await Promise.resolve().then(()=>(Ue(),lt));await l(g,u)}catch(l){console.error("Error in generate-api-key route:",l),u.status(500).json({success:!1,error:l.message})}}),o.get("/api/admin/integration-status",async(g,u)=>{try{let{getIntegrationStatus:l}=await Promise.resolve().then(()=>(Ue(),lt));await l(g,u)}catch(l){console.error("Error in integration-status route:",l),u.status(500).json({success:!1,error:l.message})}}),o.get("/api/admin/integration-docs",async(g,u)=>{try{let{getIntegrationDocs:l}=await Promise.resolve().then(()=>(Ue(),lt));await l(g,u)}catch(l){console.error("Error in integration-docs route:",l),u.status(500).json({success:!1,error:l.message})}}),o.get("/api/webhooks",async(g,u)=>{try{u.json({success:!0,webhooks:[]})}catch(l){console.error("Error in webhooks route:",l),u.status(500).json({success:!1,error:l.message})}}),o.use("/api",ma),o.use("/api",ha),o.use("/api",Ca),o.use("/api/integration",da),o.use("/api/xml-price-sheets",Aa),o.use("/api/larson-optimizer",ja),o.use("/api/test-email",Da),o.use("/api/voice-calls",Ha),o.use("/api/twiml",Ga),o.use("/api/order-notifications",Ka),o.use("/api",Qa),o.get("/api/discord/status",(g,u)=>{u.json({status:"disabled",message:"Discord integration disabled for deployment stability"})}),o.get("/api/notifications/status",(g,u)=>{u.json({status:"basic",channels:["email"],message:"Basic notifications only"})}),o.get("/api/materials/pick-list",qo),o.get("/api/materials/by-supplier",Bo),o.get("/api/materials/order/:orderId",Wo),o.put("/api/materials/:id",Uo),o.post("/api/materials/purchase-order",Ho),o.get("/api/materials/types",Go),o.get("/api/materials/suppliers",Ko),o.post("/api/materials/bulk-update",async(g,u)=>{try{let{materialIds:l,status:f,adminApproval:b}=g.body;if(!l||!Array.isArray(l)||l.length===0)return u.status(400).json({error:"Material IDs are required"});if(!f)return u.status(400).json({error:"Status is required"});let M=(await y.getMaterialsPickList()).filter(Y=>l.includes(Y.id.toString())).filter(Y=>Y.status==="ordered"||Y.status==="arrived"||Y.status==="completed");if(M.length>0&&!b)return u.status(409).json({error:"DOUBLE_ORDER_PREVENTION",message:"Materials already ordered. Admin approval required.",alreadyOrderedMaterials:M});let oe=[];for(let Y of l)try{let ge=await y.updateMaterialOrder(parseInt(Y),{status:f,notes:b?"Admin approved override for duplicate order":void 0});oe.push(ge)}catch(ge){console.error(`Failed to update material ${Y}:`,ge)}u.json({message:`Successfully updated ${oe.length} materials to ${f}`,updatedMaterials:oe,adminApproval:b||!1})}catch(l){console.error("Error in bulk update:",l),u.status(500).json({error:"Failed to update materials"})}}),o.post("/api/materials/mark-out-of-stock",async(g,u)=>{try{let{materialIds:l,notes:f}=g.body;if(!l||!Array.isArray(l)||l.length===0)return u.status(400).json({error:"Material IDs are required"});let b=[];for(let F of l)try{let P=await y.updateMaterialOrder(parseInt(F),{status:"out_of_stock",notes:f||"Marked as out of stock"});b.push(P)}catch(P){console.error(`Failed to mark material ${F} as out of stock:`,P)}u.json({message:`Successfully marked ${b.length} materials as out of stock`,updatedMaterials:b})}catch(l){console.error("Error marking materials as out of stock:",l),u.status(500).json({error:"Failed to mark materials as out of stock"})}}),o.post("/api/orders/:orderId/generate-materials",async(g,u)=>{try{let l=parseInt(g.params.orderId);if(!l||isNaN(l))return u.status(400).json({error:"Valid order ID is required"});console.log(`Generating materials for order ID: ${l}`);let f=await y.getOrder(l);if(!f)return u.status(404).json({error:"Order not found"});console.log("Found order:",f);let b=await y.createMaterialOrdersFromorder(f);console.log(`Generated ${b.length} material orders`),u.json({success:!0,message:`Generated ${b.length} material orders for order #${l}`,materialOrders:b})}catch(l){console.error("Error generating materials for order:",l),u.status(500).json({success:!1,error:l.message||"Failed to generate material orders"})}}),o.post("/api/orders/generate-all-materials",async(g,u)=>{try{let l=await y.getAllOrders(),f=0,b=0;for(let F of l)try{let P=await y.createMaterialOrdersFromOrder(F);f+=P.length,b++}catch(P){console.error(`Error creating materials for order ${F.id}:`,P)}u.json({success:!0,message:`Generated ${f} material orders from ${b} orders`,totalMaterialOrders:f,processedOrders:b})}catch(l){console.error("Error generating materials for all orders:",l),u.status(500).json({error:l.message})}}),o.post("/api/order-groups/:orderGroupId/partial-payment",na),o.post("/api/order-groups/:orderGroupId/defer-payment",ia),o.post("/api/create-payment-intent",async(g,u)=>{try{let{orderGroupId:l,amount:f}=g.body;if(!l||!f)return u.status(400).json({success:!1,message:"Order group ID and amount are required"});let b=Math.round(Number(f)*100);if(isNaN(b)||b<=0)return u.status(400).json({success:!1,message:"Valid amount is required"});if(!process.env.STRIPE_SECRET_KEY)return u.status(500).json({success:!1,message:"Stripe is not configured. Please contact support."});let P=await new zc(process.env.STRIPE_SECRET_KEY).paymentIntents.create({amount:b,currency:"usd",automatic_payment_methods:{enabled:!0},metadata:{orderGroupId:l.toString(),businessName:"Jay's Frames"},description:`Order #${l} - Jay's Frames`});u.json({success:!0,clientSecret:P.client_secret,amount:b})}catch(l){console.error("Error creating payment intent:",l),u.status(500).json({success:!1,message:"Failed to create payment intent",error:l instanceof Error?l.message:"Unknown error"})}});let{createNewPaymentLink:t,getAllPaymentLinks:r,getPaymentLinkById:a,sendPaymentLinkNotification:s,validatePaymentLinkByToken:n,completePaymentForLink:c,verifyPaymentCompletion:i}=await Promise.resolve().then(()=>(ys(),hs));o.post("/api/payment-links",t),o.get("/api/payment-links",r),o.get("/api/payment-links/:id",a),o.post("/api/payment-links/:id/send",s),o.get("/api/payment/:token/validate",n),o.post("/api/payment/:token/complete",c),o.post("/api/payment/:token/verify",i);let d=Hc(o),h=new Gc({server:d,path:"/ws"});return h.on("connection",g=>{console.log("WebSocket client connected"),g.on("message",u=>{try{console.log("Received message:",u.toString()),h.clients.forEach(l=>{l.readyState===Kc.OPEN&&l.send(u.toString())})}catch(l){console.error("WebSocket message error:",l)}}),g.send(JSON.stringify({type:"connection",message:"WebSocket connection established"}))}),o.use("/api/vendor-catalog",_o),o.use("/api/hub",hr),o.use("/api/hub-admin",Rt),o.post("/api/recommendations/from-image",pe.analyzeArtwork),o.post("/api/recommendations/analyze",pe.generateFrameRecommendations),o.post("/api/recommendations/generate",pe.generateFrameRecommendations),d}Qc.config();var Jc=Yc(import.meta.url),yg=$t.dirname(Jc),ee=Tt();ee.get("/health",(o,e)=>{e.status(200).json({status:"healthy",service:"Jay's Frames POS System",timestamp:new Date().toISOString(),environment:"production"})});ee.get("/ready",(o,e)=>{e.status(200).json({status:"ready"})});ee.get("/ping",(o,e)=>{e.status(200).json({status:"healthy"})});ee.get("/",(o,e)=>{let t=$t.join(Le,"index.html");if(console.log(`\u{1F3E0} Serving root page from: ${t}`),!yt.existsSync(t))return console.error(`\u274C index.html not found at: ${t}`),e.status(404).send("Application not found - index.html missing");e.sendFile(t,r=>{r&&(console.error("Error serving index.html:",r),e.status(500).send("Server Error"))})});ee.set("trust proxy",!0);var Wr=parseInt(process.env.PORT||process.env.REPL_PORT||"5000",10);ee.use(Vc({origin:["https://*.replit.app","https://*.replit.dev"],credentials:!0}));ee.use(Tt.json({limit:"50mb"}));ee.use(Tt.urlencoded({extended:!0,limit:"50mb"}));var Le=$t.join(process.cwd(),"dist/public");console.log(`\u{1F4C1} Serving static files from: ${Le}`);console.log(`\u{1F4C2} Directory exists: ${yt.existsSync(Le)}`);yt.existsSync(Le)&&(console.log("\u{1F4CB} Files in client build directory:"),yt.readdirSync(Le).forEach(e=>console.log(`  - ${e}`)));ee.use(Tt.static(Le,{index:"index.html",redirect:!1,setHeaders:(o,e)=>{e.endsWith(".html")&&o.setHeader("Cache-Control","no-cache")}}));ee.get("*",(o,e)=>{if(o.path.startsWith("/api/"))return e.status(404).json({error:"API endpoint not found"});let t=$t.join(Le,"index.html");if(console.log(`\u{1F4C4} Attempting to serve index.html from: ${t}`),!yt.existsSync(t))return console.error(`\u274C index.html not found at: ${t}`),e.status(404).send("Application not found - index.html missing");e.sendFile(t,r=>{r&&(console.error("Error serving index.html:",r),e.status(500).send("Server Error"))})});ee.use((o,e,t,r)=>{console.error("Server error:",o),t.status(500).json({success:!1,error:"Internal server error",message:o.message})});async function Zc(){try{(await bs(ee)).listen(Wr,"0.0.0.0",()=>{console.log(`Server running on port ${Wr}`),console.log("Environment: production"),console.log(`Server bound to 0.0.0.0:${Wr}`),console.log("Health check endpoints: /, /health, /ready")})}catch(o){console.error("Failed to start server:",o),process.exit(1)}}Zc();var bg=ee;export{bg as default};
